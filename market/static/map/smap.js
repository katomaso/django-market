JAK.VecNd=JAK.ClassMaker.makeClass({NAME:"JAK.VecNd",VERSION:"2.0"});JAK.VecNd.prototype.$constructor=function(a){this.n=a;this.data=[];for(var b=0;b<a;b++)this.data.push(arguments.length>b+1?arguments[b+1]:0)};JAK.VecNd.prototype.setN=function(a,b){this.data[a]=b};JAK.VecNd.prototype.getN=function(a){return this.data[a]};JAK.VecNd.prototype.norm=function(a){for(var a=a||2,b=0,c=0;c<this.n;c++)b+=Math.pow(this.getN(c),a);return Math.pow(b,1/a)};
JAK.VecNd.prototype._plus=function(a){for(var b=0;b<this.n;b++)this.setN(b,this.getN(b)+a.getN(b));return this};JAK.VecNd.prototype.plus=function(a){return this.clone()._plus(a)};JAK.VecNd.prototype._minus=function(a){for(var b=0;b<this.n;b++)this.setN(b,this.getN(b)-a.getN(b));return this};JAK.VecNd.prototype.minus=function(a){return this.clone()._minus(a)};JAK.VecNd.prototype._multiply=function(a){for(var b=0;b<this.n;b++)this.setN(b,this.getN(b)*a);return this};JAK.VecNd.prototype.multiply=function(a){return this.clone()._multiply(a)};
JAK.VecNd.prototype.dot=function(a){for(var b=0,c=0;c<this.n;c++)b+=this.getN(c)*a.getN(c);return b};JAK.VecNd.prototype._unit=function(a){for(var a=this.norm(a),b=0;b<this.n;b++)this.setN(b,this.getN(b)/a);return this};JAK.VecNd.prototype.unit=function(a){return this.clone()._unit(a)};JAK.VecNd.prototype.clone=function(){for(var a=new this.constructor(this.n),b=0;b<this.n;b++)a.setN(b,this.getN(b));return a};
JAK.VecNd.prototype.join=function(a,b){for(var c=a||",",d=[],e=0;e<this.n;e++){var f=this.getN(e);b&&(f=Math.round(f));d.push(f)}return d.join(c)};JAK.VecNd.prototype.toString=function(){return"["+this.join(", ")+"]"};JAK.Vec2d=JAK.ClassMaker.makeClass({NAME:"Vec2d",VERSION:"2.0",EXTEND:JAK.VecNd});JAK.Vec2d.prototype.$constructor=function(a,b){JAK.VecNd.prototype.$constructor.call(this,2,a,b)};JAK.Vec2d.prototype.setX=function(a){this.data[0]=a};
JAK.Vec2d.prototype.setY=function(a){this.data[1]=a};JAK.Vec2d.prototype.getX=function(){return this.data[0]};JAK.Vec2d.prototype.getY=function(){return this.data[1]};JAK.Vec2d.prototype.normal=function(){return new this.constructor(this.getY(),-this.getX())};JAK.Vec2d.prototype._symmetry=function(a){var a=a.normal()._unit(),b=this.dot(a);return this._minus(a._multiply(2*b))};JAK.Vec2d.prototype.symmetry=function(a){return this.clone()._symmetry(a)};
JAK.Vec2d.prototype.distance=function(a,b){var c=b.minus(a),d=c.normal().unit(),e=a.getX(),f=a.getY(),g=this.getX(),h=this.getY(),j=c.getX(),c=c.getY(),k=d.getX(),d=d.getY();return-((j*h-c*g+e*c-f*j)/(k*c-j*d))};JAK.Vector=JAK.ClassMaker.makeStatic({NAME:"JAK.Vector",VERSION:"2.0",DEPEND:[{sClass:JAK.Vec2d,ver:"2.0"}]});JAK.Vector.STYLE_SOLID=0;JAK.Vector.STYLE_DASH=1;JAK.Vector.STYLE_DOT=2;JAK.Vector.STYLE_DASHDOT=3;JAK.Vector.END_STYLE_ROUND=0;JAK.Vector.END_STYLE_SQUARE=1;
JAK.Vector.getCanvas=function(a,b){return JAK.SVG.isSupported()?new JAK.SVG(a,b):JAK.VML.isSupported(a,b)?new JAK.VML(a,b):new JAK.Vector.Canvas(a,b)};JAK.Vector.Canvas=JAK.ClassMaker.makeClass({NAME:"JAK.Vector.Canvas",VERSION:"1.0"});JAK.Vector.Canvas.prototype.$constructor=function(){this._container=JAK.mel("div")};JAK.Vector.Canvas.prototype.clear=function(){};JAK.Vector.Canvas.prototype.resize=function(){};JAK.Vector.Canvas.prototype.setScale=function(){};
JAK.Vector.Canvas.prototype.getContainer=function(){return this._container};JAK.Vector.Canvas.prototype.getContent=function(){};JAK.Vector.Canvas.prototype.setContent=function(){};JAK.Vector.Canvas.prototype.circle=function(){};JAK.Vector.Canvas.prototype.ellipse=function(){};JAK.Vector.Canvas.prototype.polyline=function(){};JAK.Vector.Canvas.prototype.polygon=function(){};JAK.Vector.Canvas.prototype.path=function(){};JAK.Vector.Canvas.prototype.group=function(){return JAK.mel("div")};
JAK.Vector.Canvas.prototype.setStroke=function(){};JAK.Vector.Canvas.prototype.setFill=function(){};JAK.Vector.Canvas.prototype.setCenterRadius=function(){};JAK.Vector.Canvas.prototype.setPoints=function(){};JAK.Vector.Canvas.prototype.setFormat=function(){};JAK.Vector.Canvas.prototype.setTitle=function(a,b){a.setAttribute("title",b)};
JAK.Vector.Canvas.prototype.computeControlPointsSymmetric=function(a,b){var c={flat:!0,curvature:20,join:!1},d;for(d in b)c[d]=b[d];if(2>a.length||2==a.length&&!c.join)return!1;d=[];for(var e=!1,f=!1,g=c.join?a.length:a.length-1,h=0;h<g;h++){var j=a[h];if(c.join)var k=h+1==a.length?a[0]:a[h+1],f=h+2>=a.length?a[h+2-a.length]:a[h+2];else k=a[h+1],f=h+2==a.length?!1:a[h+2];if(f){var l=f.minus(j),m=l.norm();(m/=c.curvature)||(m=Infinity);l=l.multiply(1/m);f=k.minus(l)}else if(m=k.minus(j),c.flat)f=j.plus(m.multiply(0.5));
else var n=e.minus(j),l=n.symmetry(m),f=k.minus(l);e||(m=k.minus(j),c.join?(e=a[a.length-1].minus(k),m=e.norm(),(m/=c.curvature)||(m=Infinity),e=e.multiply(1/m),e=j.minus(e)):c.flat?e=j.plus(m.multiply(0.5)):(n=l.symmetry(m),e=j.plus(n)));d.push([e,f]);e=k.plus(l)}return d};
JAK.Vector.Canvas.prototype.computeControlPoints=function(a,b){var c={flat:!0,curvature:20,join:!1},d;for(d in b)c[d]=b[d];c.curvature/=100;if(2>a.length||2==a.length&&!c.join)return!1;d=[];for(var e=!1,f=!1,g=c.join?a.length:a.length-1,h=0;h<g;h++){var j=a[h];if(c.join)var k=h+1==a.length?a[0]:a[h+1],f=h+2>=a.length?a[h+2-a.length]:a[h+2],l=h?a[h-1]:a[a.length-1];else k=a[h+1],f=h+2==a.length?!1:a[h+2],l=h?a[h-1]:!1;var m=k.minus(j);if(f)var n=f.minus(j),e=m.norm()*c.curvature,o=n.norm(),n=n.multiply(e/
o||0),f=k.minus(n);else c.flat?f=j.plus(m.multiply(0.5)):(e=e.minus(j),n=e.symmetry(m),f=k.minus(n));l?(l=l.minus(k),e=k.minus(j).norm()*c.curvature,o=l.norm(),k=l.multiply(e/o||0),e=j.minus(k)):c.flat?e=j.plus(m.multiply(0.5)):(e=n.symmetry(m),e=j.plus(e));d.push([e,f])}return d};JAK.Vector.Primitive=JAK.ClassMaker.makeClass({NAME:"JAK.Vector.Primitive",VERSION:"1.0"});JAK.Vector.Primitive.prototype.$constructor=function(a){this.canvas=a;this.elm2=this.elm=null};
JAK.Vector.Primitive.prototype.getNodes=function(){var a=[this.elm];this.elm2&&a.push(this.elm2);return a};JAK.Vector.Primitive.prototype.$destructor=function(){this.elm&&(this.elm.parentNode&&1==this.elm.parentNode.nodeType)&&this.elm.parentNode.removeChild(this.elm);this.elm2&&(this.elm2.parentNode&&1==this.elm2.parentNode.nodeType)&&this.elm2.parentNode.removeChild(this.elm2)};JAK.Vector.Line=JAK.ClassMaker.makeClass({NAME:"JAK.Vector.Line",VERSION:"1.0",EXTEND:JAK.Vector.Primitive});
JAK.Vector.Line.prototype.$constructor=function(a,b,c){this.canvas=a;this.elm2=null;this.options={color:"#000",width:1,curvature:0,opacity:1,style:JAK.Vector.STYLE_SOLID,outlineColor:"#fff",outlineOpacity:1,outlineWidth:0,outlineStyle:JAK.Vector.STYLE_SOLID,title:"",symmetricCP:!0};for(var d in c)this.options[d]=c[d];this._build(b)};
JAK.Vector.Line.prototype._build=function(a){this.elm&&this.elm.parentNode.removeChild(this.elm);this.elm2&&this.elm2.parentNode.removeChild(this.elm2);this.options.curvature?(this.elm=this.canvas.path(),this.options.outlineWidth&&(this.elm2=this.canvas.path())):(this.elm=this.canvas.polyline(),this.options.outlineWidth&&(this.elm2=this.canvas.polyline()));this.canvas.setTitle(this.elm,this.options.title);this.options.outlineWidth&&(this.canvas.setTitle(this.elm2,this.options.title),this.canvas.getContent().appendChild(this.elm2));
this.canvas.getContent().appendChild(this.elm);this.setPoints(a);this.setOptions(this.options)};JAK.Vector.Line.prototype.setCurvature=function(a){!!this.options.curvature!=!!a?(this.options.curvature=a,this._build(this.points)):(this.options.curvature=a,this.setPoints(this.points))};JAK.Vector.Line.prototype.$destructor=function(){this.elm.parentNode&&1==this.elm.parentNode.nodeType&&this.elm.parentNode.removeChild(this.elm);this.elm2&&(this.elm2.parentNode&&1==this.elm2.parentNode.nodeType)&&this.elm2.parentNode.removeChild(this.elm2)};
JAK.Vector.Line.prototype.setPoints=function(a){this.points=a;if(this.options.curvature){var a="M "+this.points[0].join(" "),b=this.points.length;if(2<b)for(var c=this.options.symmetricCP?this.canvas.computeControlPointsSymmetric(this.points,{join:!1,curvature:this.options.curvature}):this.canvas.computeControlPoints(this.points,{join:!1,curvature:this.options.curvature}),d=1;d<b;d++)var e=c[d-1],f=e[1],g=this.points[d],a=a+("C "+e[0].join(" ")+", "+f.join(" ")+", "+g.join(" ")+" ");else for(d=1;d<
b;d++)g=this.points[d],a+="L  "+g.join(" ")+" ";this.canvas.setFormat(this.elm,a);this.elm2&&this.canvas.setFormat(this.elm2,a)}else this.canvas.setPoints(this.elm,a),this.elm2&&this.canvas.setPoints(this.elm2,a)};
JAK.Vector.Line.prototype.setOptions=function(a){var b={};"width"in a&&(b.width=a.width,this.options.width=a.width);"opacity"in a&&(b.opacity=a.opacity);"color"in a&&(b.color=a.color);"style"in a&&(b.style=a.style);"endCap"in a&&(b.endCap=a.endCap);"exactStyle"in a&&(b.exactStyle=a.exactStyle);this.canvas.setStroke(this.elm,b);this.elm2&&(b={},"outlineWidth"in a&&(b.width=2*a.outlineWidth+this.options.width),"outlineOpacity"in a&&(b.opacity=a.outlineOpacity),"outlineColor"in a&&(b.color=a.outlineColor),
"outlineStyle"in a&&(b.style=a.outlineStyle),"outlineEndCap"in a&&(b.endCap=a.outlineEndCap),"outlineExactStyle"in a&&(b.exactStyle=a.outlineExactStyle),this.canvas.setStroke(this.elm2,b))};JAK.Vector.Polygon=JAK.ClassMaker.makeClass({NAME:"JAK.Vector.Polygon",VERSION:"1.0",EXTEND:JAK.Vector.Primitive});
JAK.Vector.Polygon.prototype.$constructor=function(a,b,c){this.canvas=a;this.options={color:"#000",curvature:0,opacity:1,outlineColor:"#fff",outlineOpacity:1,outlineWidth:0,outlineStyle:JAK.Vector.STYLE_SOLID,title:"",symmetricCP:!0};for(var d in c)this.options[d]=c[d];this._build(b)};
JAK.Vector.Polygon.prototype._build=function(a){this.elm&&this.elm.parentNode.removeChild(this.elm);this.elm=this.options.curvature?this.canvas.path():this.canvas.polygon();this.canvas.setTitle(this.elm,this.options.title);this.canvas.getContent().appendChild(this.elm);this.setPoints(a);this.setOptions(this.options)};
JAK.Vector.Polygon.prototype.setPoints=function(a){this.points=a;if(this.options.curvature){for(var a=this.options.symmetricCP?this.canvas.computeControlPointsSymmetric(this.points,{join:!0,curvature:this.options.curvature}):this.canvas.computeControlPoints(this.points,{join:!0,curvature:this.options.curvature}),b="M "+this.points[0].join(" "),c=this.points.length,d=1;d<c+1;d++)var e=a[d-1],f=e[1],g=d>=c?this.points[0]:this.points[d],b=b+("C "+e[0].join(" ")+", "+f.join(" ")+", "+g.join(" ")+" ");
this.canvas.setFormat(this.elm,b+"Z")}else this.canvas.setPoints(this.elm,a,!0)};
JAK.Vector.Polygon.prototype.setOptions=function(a){var b={};"outlineColor"in a&&(b.color=a.outlineColor);"outlineWidth"in a&&(b.width=a.outlineWidth);"outlineOpacity"in a&&(b.opacity=a.outlineOpacity);"outlineStyle"in a&&(b.style=a.outlineStyle);"outlineEndCap"in a&&(b.endCap=a.outlineEndCap);"outlineExactStyle"in a&&(b.exactStyle=a.outlineExactStyle);var c={};"color"in a&&(c.color=a.color);"opacity"in a&&(c.opacity=a.opacity);this.canvas.setStroke(this.elm,b);this.canvas.setFill(this.elm,c)};
JAK.Vector.Polygon.prototype.setCurvature=function(a){!!this.options.curvature!=!!a?(this.options.curvature=a,this._build(this.points)):(this.options.curvature=a,this.setPoints(this.points))};JAK.Vector.Circle=JAK.ClassMaker.makeClass({NAME:"JAK.Vector.Circle",VERSION:"1.0",EXTEND:JAK.Vector.Primitive});JAK.Vector.Circle.prototype._method="circle";
JAK.Vector.Circle.prototype.$constructor=function(a,b,c,d){this.canvas=a;this.center=new JAK.Vec2d(0,0);this.radius=0;this.options={color:"",opacity:1,outlineColor:"#000",outlineOpacity:1,outlineWidth:1,outlineStyle:JAK.Vector.STYLE_SOLID,title:""};for(var e in d)this.options[e]=d[e];this.elm=this.canvas[this._method]();this.setCenter(b);this.setRadius(c);this.canvas.setTitle(this.elm,this.options.title);this.canvas.getContent().appendChild(this.elm);this.setOptions(this.options)};
JAK.Vector.Circle.prototype.setCenter=function(a){this.center=a;this.canvas.setCenterRadius(this.elm,this.center,this.radius)};
JAK.Vector.Circle.prototype.setOptions=function(a){var b={};"outlineColor"in a&&(b.color=a.outlineColor);"outlineWidth"in a&&(b.width=a.outlineWidth);"outlineOpacity"in a&&(b.opacity=a.outlineOpacity);"outlineStyle"in a&&(b.style=a.outlineStyle);"outlineEndCap"in a&&(b.endCap=a.outlineEndCap);"outlineExactStyle"in a&&(b.exactStyle=a.outlineExactStyle);var c={};"color"in a&&(c.color=a.color);"opacity"in a&&(c.opacity=a.opacity);this.canvas.setStroke(this.elm,b);this.canvas.setFill(this.elm,c)};
JAK.Vector.Circle.prototype.setRadius=function(a){this.radius=a;this.canvas.setCenterRadius(this.elm,this.center,this.radius)};JAK.Vector.Ellipse=JAK.ClassMaker.makeClass({NAME:"JAK.Vector.Ellipse",VERSION:"1.0",EXTEND:JAK.Vector.Circle});JAK.Vector.Ellipse.prototype._method="ellipse";JAK.Vector.Path=JAK.ClassMaker.makeClass({NAME:"JAK.Vector.Path",VERSION:"1.0",EXTEND:JAK.Vector.Primitive});
JAK.Vector.Path.prototype.$constructor=function(a,b,c){this.canvas=a;this.elm2=null;this.options={color:"none",opacity:1,width:0,style:JAK.Vector.STYLE_SOLID,outlineColor:"#fff",outlineOpacity:1,outlineWidth:1,outlineStyle:JAK.Vector.STYLE_SOLID,title:""};for(var d in c)this.options[d]=c[d];a=this.options.width&&!b.match(/z/i);this.elm=this.canvas.path();this.setFormat(b);a&&(this.elm2=this.canvas.path(),this.setFormat(b),this.canvas.setTitle(this.elm2,this.options.title));this.canvas.setTitle(this.elm,
this.options.title);this.elm2&&this.canvas.getContent().appendChild(this.elm2);this.canvas.getContent().appendChild(this.elm);this.setOptions(this.options)};JAK.Vector.Path.prototype.$destructor=function(){this.elm.parentNode&&1==this.elm.parentNode.nodeType&&this.elm.parentNode.removeChild(this.elm);this.elm2&&(this.elm2.parentNode&&1==this.elm2.parentNode.nodeType)&&this.elm2.parentNode.removeChild(this.elm2)};
JAK.Vector.Path.prototype.setFormat=function(a){this.canvas.setFormat(this.elm,a);this.elm2&&this.canvas.setFormat(this.elm2,a)};
JAK.Vector.Path.prototype.setOptions=function(a){var b={};"outlineColor"in a&&(b.color=a.outlineColor);"outlineWidth"in a&&(b.width=a.outlineWidth);"outlineOpacity"in a&&(b.opacity=a.outlineOpacity);"outlineStyle"in a&&(b.style=a.outlineStyle);"outlineEndCap"in a&&(b.endCap=a.outlineEndCap);"outlineExactStyle"in a&&(b.exactStyle=a.outlineExactStyle);var c={};"color"in a&&(c.color=a.color);"opacity"in a&&(c.opacity=a.opacity);"width"in a&&(c.width=a.width);"style"in a&&(c.style=a.style);"endCap"in
a&&(c.endCap=a.endCap);"outlineExactStyle"in a&&(c.exactStyle=a.outlineExactStyle);this.elm2?(b.width&&(b.width=c.width+2*b.width),this.canvas.setStroke(this.elm,c),this.canvas.setStroke(this.elm2,b)):(this.canvas.setStroke(this.elm,b),this.canvas.setFill(this.elm,c))};JAK.SVG=JAK.ClassMaker.makeClass({NAME:"SVG",VERSION:"3.0",EXTEND:JAK.Vector.Canvas});JAK.SVG.isSupported=function(){return!document.createElementNS||!document.createElementNS(this.prototype.ns,"svg").style?!1:!0};
JAK.SVG.prototype.ns="http://www.w3.org/2000/svg";JAK.SVG.prototype.xlinkns="http://www.w3.org/1999/xlink";JAK.SVG.prototype._styles=[[],[4,3],[1,2],[4,2,1,2]];JAK.SVG.prototype._lineEnds=["round","square"];
JAK.SVG.prototype.$constructor=function(a,b){var c=document.createElementNS(this.ns,"svg");c.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink",this.xlinkns);var d=document.createElementNS(this.ns,"g");c.appendChild(d);this.ec=[];this.ec.push(JAK.Events.addListener(c,"mousemove",JAK.Events.cancelDef));this.ec.push(JAK.Events.addListener(c,"mousedown",JAK.Events.cancelDef));this.ec.push(JAK.Events.addListener(c,"mouseup",JAK.Events.cancelDef));this.canvas=c;this.g=d;this.resize(a,b)};
JAK.SVG.prototype.$destructor=function(){for(var a=0;a<this.ec.length;a++)JAK.Events.removeListener(this.ec[a]);this.ec=[];this.canvas.parentNode&&1==this.canvas.parentNode.nodeType&&this.canvas.parentNode.removeChild(this.canvas);this.canvas=null};JAK.SVG.prototype.getContainer=function(){return this.canvas};JAK.SVG.prototype.getContent=function(){return this.g};JAK.SVG.prototype.setContent=function(a){this.g=a};JAK.SVG.prototype.clear=function(){JAK.DOM.clear(this.g)};
JAK.SVG.prototype.resize=function(a,b){this.canvas.setAttribute("width",a);this.canvas.setAttribute("height",b)};JAK.SVG.prototype.setScale=function(a){this.g.setAttribute("transform","scale("+a+")")};JAK.SVG.prototype.polyline=function(){var a=document.createElementNS(this.ns,"polyline");a.setAttribute("fill","none");a.setAttribute("stroke","none");a.setAttribute("stroke-linejoin","round");a.setAttribute("stroke-linecap","round");return a};
JAK.SVG.prototype.circle=function(){var a=document.createElementNS(this.ns,"circle");a.setAttribute("fill","none");a.setAttribute("stroke","none");return a};JAK.SVG.prototype.ellipse=function(){var a=document.createElementNS(this.ns,"ellipse");a.setAttribute("fill","none");a.setAttribute("stroke","none");return a};
JAK.SVG.prototype.polygon=function(){var a=document.createElementNS(this.ns,"polygon");a.setAttribute("fill","none");a.setAttribute("stroke","none");a.setAttribute("stroke-linejoin","round");a.setAttribute("stroke-linecap","round");return a};JAK.SVG.prototype.path=function(){var a=document.createElementNS(this.ns,"path");a.setAttribute("fill","none");a.setAttribute("stroke","none");a.setAttribute("stroke-linejoin","round");a.setAttribute("stroke-linecap","round");return a};
JAK.SVG.prototype.group=function(){return document.createElementNS(this.ns,"g")};
JAK.SVG.prototype.setStroke=function(a,b){"color"in b&&a.setAttribute("stroke",b.color);"opacity"in b&&a.setAttribute("stroke-opacity",b.opacity);"width"in b&&a.setAttribute("stroke-width",b.width);if("style"in b){for(var c=parseFloat(a.getAttribute("stroke-width")),d=this._styles[b.style],e=d.length,f=[];e--;)f[e]=Math.max(1,d[e]*c+(e%2?1:-1)*c);a.setAttribute("stroke-dasharray",f.join(" "))}"endCap"in b&&a.setAttribute("stroke-linecap",this._lineEnds[b.endCap]);"exactStyle"in b&&a.setAttribute("stroke-dasharray",
b.exactStyle)};JAK.SVG.prototype.setFill=function(a,b){"color"in b&&a.setAttribute("fill",b.color);"opacity"in b&&a.setAttribute("fill-opacity",b.opacity)};JAK.SVG.prototype.setCenterRadius=function(a,b,c){a.setAttribute("cx",b.getX());a.setAttribute("cy",b.getY());c instanceof Array?(a.setAttribute("rx",c[0]),a.setAttribute("ry",c[1])):a.setAttribute("r",c)};JAK.SVG.prototype.setPoints=function(a,b){var c=b.map(function(a){return a.join(" ")});a.setAttribute("points",c.join(", "))};
JAK.SVG.prototype.setFormat=function(a,b){a.setAttribute("d",b)};JAK.SVG.prototype.setTitle=function(a,b){var c=a.getElementsByTagName("title");c.length?c=c[0]:(c=document.createElementNS(this.ns,"title"),a.appendChild(c));JAK.DOM.clear(c);c.appendChild(document.createTextNode(b))};JAK.VML=JAK.ClassMaker.makeClass({NAME:"VML",VERSION:"4.0",EXTEND:JAK.Vector.Canvas});JAK.VML.isSupported=function(){return"ie"==JAK.Browser.client};JAK.VML.prototype._styles=["","dash","dot","dashdot"];
JAK.VML.prototype._lineEnds=["round","square"];
JAK.VML.prototype.$constructor=function(a,b){"ie"==JAK.Browser.client&&!document.namespaces.vml&&(document.documentMode&&8<=document.documentMode?document.namespaces.add("vml","urn:schemas-microsoft-com:vml","#default#VML"):document.namespaces.add("vml","urn:schemas-microsoft-com:vml"),document.createStyleSheet().cssText="vml\\:*{behavior:url(#default#VML);");var c=JAK.mel("div",null,{display:"none"}),d=JAK.mel("div",null,{display:"none"});document.body.insertBefore(c,document.body.firstChild);document.body.insertBefore(d,
document.body.firstChild);this.constructor.storage=c;this.constructor.tmp=d;this.canvas=JAK.mel("div",null,{position:"absolute",overflow:"hidden"});this.resize(a,b);this.clear()};JAK.VML.prototype.$destructor=function(){this.canvas.parentNode&&1==this.canvas.parentNode.nodeType&&this.canvas.parentNode.removeChild(this.canvas);this.canvas=null};JAK.VML.prototype.setScale=function(a){this.canvas.style.zoom=a};JAK.VML.prototype.clear=function(){JAK.DOM.clear(this.canvas);this.canvas.appendChild(this._build("<vml:shape />"))};
JAK.VML.prototype.resize=function(a,b){this.canvas.style.width=a+"px";this.canvas.style.height=b+"px"};JAK.VML.prototype.getContainer=function(){return this.canvas};JAK.VML.prototype.getContent=function(){return this.canvas};JAK.VML.prototype.setContent=function(a){this.canvas=a};
JAK.VML.prototype.path=function(){var a=this._build("<vml:shape><vml:fill></vml:fill><vml:stroke endcap='round' joinstyle='round'></vml:stroke></vml:shape>");a.filled=!1;a.stroked=!1;a.style.position="absolute";a.style.width="1px";a.style.height="1px";a.coordsize="1,1";return a};JAK.VML.prototype.polyline=function(){var a=this._build("<vml:polyline><vml:fill></vml:fill><vml:stroke endcap='round' joinstyle='round'></vml:stroke></vml:polyline>");a.filled=!1;a.stroked=!1;return a};
JAK.VML.prototype.polygon=function(){return this.polyline()};JAK.VML.prototype.circle=function(){var a=this._build("<vml:oval><vml:fill></vml:fill><vml:stroke></vml:stroke></vml:oval>");a.style.position="absolute";a.filled=!1;a.stroked=!1;return a};JAK.VML.prototype.ellipse=JAK.VML.prototype.circle;JAK.VML.prototype.group=function(){return JAK.mel("div")};
JAK.VML.prototype.setStroke=function(a,b){"color"in b&&(a.strokecolor=b.color);"width"in b&&b.width&&(a.stroked=!0,a.strokeweight=b.width+"px");"opacity"in b&&(a.getElementsByTagName("stroke")[0].opacity=b.opacity);"style"in b&&(a.getElementsByTagName("stroke")[0].dashstyle=this._styles[b.style]);"endCap"in b&&(a.getElementsByTagName("stroke")[0].endcap=this._lineEnds[b.endCap])};
JAK.VML.prototype.setFill=function(a,b){"color"in b&&(a.filled=!0,a.fillcolor=b.color);"opacity"in b&&(a.getElementsByTagName("fill")[0].opacity=b.opacity);"endCap"in b&&(a.getElementsByTagName("fill")[0].endcap=this._lineEnds[b.endCap])};
JAK.VML.prototype.setCenterRadius=function(a,b,c){c instanceof Array?(a.style.left=b.getX()-c[0]+"px",a.style.top=b.getY()-c[1]+"px",a.style.width=2*c[0]+"px",a.style.height=2*c[1]+"px"):(a.style.left=b.getX()-c+"px",a.style.top=b.getY()-c+"px",a.style.width=2*c+"px",a.style.height=2*c+"px")};JAK.VML.prototype.setPoints=function(a,b,c){for(var d=[],e=0;e<b.length;e++)d.push(b[e].join(" "));c&&b.length&&d.push(b[0].join(" "));a.points?a.points.value=d.join(" "):a.points=d.join(" ")};
JAK.VML.prototype._analyzeFormat=function(a){for(var b=[],c=0,d="",e=!1;c<a.length;){var f=a.charAt(c);f.match(/[a-z]/i)?(d&&e.parameters.push(parseFloat(d)),e&&b.push(e),e={command:f,parameters:[]},d=""):f.match(/[ ,]/)?(d&&e.parameters.push(parseFloat(d)),d=""):d+=f;c++}d&&e.parameters.push(parseFloat(d));e&&b.push(e);return b};
JAK.VML.prototype._serializeFormat=function(a){for(var b="",c=0;c<a.length;c++)var d=a[c],e=d.parameters.map(function(a){return Math.round(a)}),b=b+(d.command+" "+e.join(" ")+" ");return b};
JAK.VML.prototype._generateArc=function(a,b){function c(a,b,c,d){a=Math.atan2(b,a);c=Math.atan2(d,c);return c>=a?c-a:2*Math.PI-(a-c)}function d(a){a=360*a/(2*Math.PI);return 65536*a}var e=a[0],f=a[1],g=a[5],h=a[6],j=b.getX(),k=b.getY(),l=a[3],m=a[4],n,o,p,q=a[2],q=q*Math.PI/180;n=Math.cos(q)*(j-g)/2+Math.sin(q)*(k-h)/2;o=-Math.sin(q)*(j-g)/2+Math.cos(q)*(k-h)/2;p=0;p=e*e*f*f-e*e*o*o-f*f*n*n;0>p?(l=Math.sqrt(1-p/(e*e*f*f)),e*=l,f*=l,p=0):(p=Math.sqrt(p/(e*e*o*o+f*f*n*n)),l==m&&(p=-p));l=p*e*o/f;p=
-p*f*n/e;j=Math.cos(q)*l-Math.sin(q)*p+(j+g)/2;k=Math.sin(q)*l+Math.cos(q)*p+(k+h)/2;q=c(1,0,(n-l)/e,(o-p)/f);n=c((n-l)/e,(o-p)/f,(-n-l)/e,(-o-p)/f);!m&&0<n?n-=2*Math.PI:m&&0>n&&(n+=2*Math.PI);b.setX(g);b.setY(h);return[j,k,e,f,-d(q),-d(n)]};
JAK.VML.prototype._fixFormat=function(a){for(var b=new JAK.Vec2d(0,0),a=this._analyzeFormat(a),c=0;c<a.length;c++){var d=a[c];switch(d.command){case "M":case "L":b.setX(d.parameters[0]);b.setY(d.parameters[1]);break;case "C":b.setX(d.parameters[4]);b.setY(d.parameters[5]);break;case "z":case "Z":d.command="X";break;case "A":d.command="AE",d.parameters=this._generateArc(d.parameters,b)}}a.push({command:"E",parameters:[]});return this._serializeFormat(a)};
JAK.VML.prototype._build=function(a){this.constructor.tmp.innerHTML=a;a=this.constructor.tmp.firstChild;this.constructor.storage.appendChild(a);return a};JAK.VML.prototype.setFormat=function(a,b){var c=this._fixFormat(b);a.path=c};JAK.Window=JAK.ClassMaker.makeClass({NAME:"Window",VERSION:"2.1"});
JAK.Window.prototype.$constructor=function(a){this._options={imagePath:"/img/shadow-",imageFormat:"png",sizes:[6,6,6,6]};for(var b in a)this._options[b]=a[b];this.content=JAK.mel("div",{className:"window-content"},{position:"relative"});this.container=!1;this._nodes=[];this._imageNames=[["lt","t","rt"],["l","","r"],["lb","b","rb"]];this._build()};
JAK.Window.prototype._build=function(){this.container=JAK.mel("div",{className:"window-container"},{position:"relative",zIndex:10});var a=JAK.mel("table",null,{borderCollapse:"collapse",position:"relative"}),b=JAK.mel("tbody");JAK.DOM.append([a,b],[this.container,a]);for(a=0;3>a;a++){this._nodes.push([]);var c=JAK.cel("tr");b.appendChild(c);for(var d=0;3>d;d++){var e=JAK.cel("td");this._nodes[a].push(e);e.style.padding="0px";e.style.margin="0px";var f=1==a&&1==d?this.content:JAK.mel("div",null,{overflow:"hidden"});
e.appendChild(f);this.setImage(a,d);0==a&&(f.style.height=this._options.sizes[0]+"px");2==a&&(f.style.height=this._options.sizes[2]+"px");0==d&&(f.style.width=this._options.sizes[3]+"px");2==d&&(f.style.width=this._options.sizes[1]+"px");1==d&&1!=a&&(e.style.width="auto");c.appendChild(e)}}};JAK.Window.prototype.$destructor=function(){for(var a in this)this[a]=null};JAK.Window.prototype.show=function(){this.container.style.display=""};
JAK.Window.prototype.hide=function(){this.container.style.display="none"};JAK.Window.prototype.setImage=function(a,b,c){if(c=this._imageNames[a][b]+(c||""))a=this._nodes[a][b],b=this._options.imagePath+c+"."+this._options.imageFormat,"ie"==JAK.Browser.client&&7>JAK.Browser.version&&this._options.imageFormat.match(/png/i)?a.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+b+"',sizingMethod='scale')":a.style.backgroundImage="url("+b+")"};
JAK.XML=JAK.ClassMaker.makeStatic({NAME:"JAK.XML",VERSION:"2.2"});JAK.XML.textContent=function(a){return a.textContent||a.text||""};JAK.XML.childElements=function(a,b){for(var c=[],d=a.childNodes,e=0;e<d.length;e++){var f=d[e];1==f.nodeType&&!(b&&b.toLowerCase()!=f.nodeName.toLowerCase())&&c.push(f)}return c};
JAK.XML.createDocument=function(a){if(window.DOMParser)return(new DOMParser).parseFromString(a,"text/xml");if(window.ActiveXObject){var b=new ActiveXObject("Microsoft.XMLDOM");b.loadXML(a);return b}throw Error("No XML parser available");};JAK.XML.RPC=JAK.ClassMaker.makeStatic({NAME:"JAK.XML.RPC",VERSION:"1.0"});JAK.XML.RPC.parse=function(a){return this._valueToObject(a)};
JAK.XML.RPC._valueToObject=function(a){a=JAK.XML.childElements(a)[0];switch(a.nodeName){case "string":return JAK.XML.textContent(a);case "base64":return JAK.XML.textContent(a).trim();case "i4":case "i8":case "int":return parseInt(a.firstChild.nodeValue);case "double":return parseFloat(a.firstChild.nodeValue);case "boolean":return"1"==a.firstChild.nodeValue;case "array":return this._arrayToObject(a);case "struct":return this._structToObject(a);case "nil":return null;case "dateTime.iso8601":a=JAK.XML.textContent(a).trim().match(/(\d{4})(\d{2})(\d{2})T(\d{2}):(\d{2}):(\d{2})(.)(\d{2})(\d{2})/);
a[7]="+"==a[7]?"1":"-1";for(var b=1;b<a.length;b++)a[b]=parseInt(a[b],10);b=new Date(a[1],a[2]-1,a[3],a[4],a[5],a[6],0);a=a[7]*(60*a[8]+a[9]);a+=b.getTimezoneOffset();b=b.getTime();return new Date(b-6E4*a);default:throw Error("Unknown XMLRPC node "+a.nodeName);}};JAK.XML.RPC._arrayToObject=function(a){for(var b=[],a=JAK.XML.childElements(a)[0],a=JAK.XML.childElements(a),c=0;c<a.length;c++)b.push(this._valueToObject(a[c]));return b};
JAK.XML.RPC._structToObject=function(a){for(var b={},a=JAK.XML.childElements(a),c=0;c<a.length;c++){var d=a[c],e=JAK.XML.childElements(d,"name")[0],e=JAK.XML.textContent(e),d=JAK.XML.childElements(d,"value")[0];b[e]=this._valueToObject(d)}return b};JAK.Interpolator=JAK.ClassMaker.makeClass({NAME:"JAK.Interpolator",VERSION:"2.1",DEPEND:[{sClass:JAK.Timekeeper,ver:"1.0"}]});JAK.Interpolator.LINEAR=1;JAK.Interpolator.QUADRATIC=2;JAK.Interpolator.SQRT=3;JAK.Interpolator.SIN=4;JAK.Interpolator.ASIN=5;
JAK.Interpolator.prototype.$constructor=function(a,b,c,d,e){this.startVal=a;this.endVal=b;this.interval=c;this.callback=d;this.options={interpolation:JAK.Interpolator.LINEAR,count:1,endCallback:!1};this.running=!1;for(var f in e)this.options[f]=e[f]};JAK.Interpolator.prototype._call=function(a){this.callback(this.startVal+(this.endVal-this.startVal)*this._interpolate(a))};
JAK.Interpolator.prototype._interpolate=function(a){if("function"==typeof this.options.interpolation)return this.options.interpolation(a);switch(this.options.interpolation){case JAK.Interpolator.QUADRATIC:return a*a;case JAK.Interpolator.SQRT:return Math.sqrt(a);case JAK.Interpolator.SIN:return(Math.sin(Math.PI*(a-0.5))+1)/2;case JAK.Interpolator.ASIN:return(Math.asin(2*(a-0.5))+Math.PI/2)/Math.PI;default:return a}};
JAK.Interpolator.prototype.start=function(){this.running||(this.running=!0,this.startTime=(new Date).getTime(),this._call(0),JAK.Timekeeper.getInstance().addListener(this,"_tick",this.options.count))};JAK.Interpolator.prototype.stop=function(){this.running&&(this.running=!1,JAK.Timekeeper.getInstance().removeListener(this))};
JAK.Interpolator.prototype._tick=function(){var a=(new Date).getTime()-this.startTime;a>=this.interval?(this.stop(),this._call(1),this.options.endCallback&&this.options.endCallback()):this._call(a/this.interval)};JAK.CSSInterpolator=JAK.ClassMaker.makeClass({NAME:"CSSInterpolator",VERSION:"2.0"});JAK.CSSInterpolator.prototype.$constructor=function(a,b,c){this.elm=a;this.properties=[];this.colors=[];this._tick=this._tick.bind(this);this.interpolator=new JAK.Interpolator(0,1,b,this._tick,c)};
JAK.CSSInterpolator.prototype.addProperty=function(a,b,c,d){this.properties.push({property:a,startVal:b,endVal:c,suffix:d||""})};JAK.CSSInterpolator.prototype.addColorProperty=function(a,b,c){this.colors.push({startVal:JAK.Parser.color(b),endVal:JAK.Parser.color(c),property:a})};JAK.CSSInterpolator.prototype.start=function(){this.interpolator.start()};JAK.CSSInterpolator.prototype.stop=function(){this.interpolator.stop()};
JAK.CSSInterpolator.prototype._setOpacity=function(a,b,c){var d="",b=b.startVal+c*(b.endVal-b.startVal);"ie"==JAK.Browser.client&&9>JAK.Browser.version?(d="filter",b=Math.round(100*b),b="progid:DXImageTransform.Microsoft.Alpha(opacity="+b+");"):d="opacity";a[d]=b};
JAK.CSSInterpolator.prototype._tick=function(a){for(var b=0;b<this.properties.length;b++){var c=this.properties[b];switch(c.property){case "opacity":this._setOpacity(this.elm.style,c,a);break;default:var d=c.startVal+a*(c.endVal-c.startVal),d=d+c.suffix;this.elm.style[c.property]=d}}c=["r","g","b"];for(b=0;b<this.colors.length;b++){for(var d=this.colors[b],e=[0,0,0],f=0;f<c.length;f++){var g=c[f];e[f]=d.startVal[g]+Math.round(a*(d.endVal[g]-d.startVal[g]))}e="rgb("+e.join(",")+")";this.elm.style[d.property]=
e}};JAK.RPC=JAK.ClassMaker.makeClass({NAME:"JAK.RPC",VERSION:"1.0",EXTEND:JAK.Request});JAK.RPC.AUTO=0;JAK.RPC.JSON=1;JAK.RPC.XMLRPC=2;JAK.RPC.FRPC=3;JAK.RPC.FRPC_B64=4;JAK.RPC.ACCEPT={};JAK.RPC.ACCEPT[JAK.RPC.JSON]="application/json";JAK.RPC.ACCEPT[JAK.RPC.XMLRPC]="text/xml";JAK.RPC.ACCEPT[JAK.RPC.FRPC]="application/x-frpc";JAK.RPC.ACCEPT[JAK.RPC.FRPC_B64]="application/x-base64-frpc";
JAK.RPC.prototype.$constructor=function(a,b){this._ERROR=5;this._rpcType=a;this._rpcType==JAK.RPC.AUTO&&(this._rpcType=JAK.RPC.FRPC_B64);var c=null;switch(this._rpcType){case JAK.RPC.JSON:case JAK.RPC.FRPC_B64:c=JAK.Request.TEXT;break;case JAK.RPC.FRPC:c=JAK.Request.BINARY;break;case JAK.RPC.XMLRPC:c=JAK.Request.XML;break;default:throw Error("Unsupported RPC type "+this._rpcType);}this._rpcOptions={timeout:0,async:!0,endpoint:"/"};for(var d in b)this._rpcOptions[d]=b[d];this.$super(c,{timeout:this._rpcOptions.timeout,
async:this._rpcOptions.async,method:"post"})};JAK.RPC.prototype.send=function(a,b,c){this.setHeaders({Accept:JAK.RPC.ACCEPT[this._rpcType],"Content-type":"application/x-base64-frpc"});if(!(b instanceof Array))throw Error("RPC needs an array of data to be sent");a=JAK.FRPC.serializeCall(a,b,c);return this.$super(this._rpcOptions.endpoint,JAK.Base64.btoa(a))};JAK.RPC.prototype.setErrorCallback=function(a,b){this._setCallback(a,b,this._ERROR);return this};
JAK.RPC.prototype._done=function(a,b){if(200!=b)return this.$super(a,b);try{var c=this._rpcParse(a,b)}catch(d){return this._state=this._ERROR,this._userCallback(d,b,this)}return this.$super(c,b)};JAK.RPC.prototype._rpcEscape=function(a){var b=RegExp('"',"g");return a.split(/\\/g).join("\\\\").split(b).join('\\"')};
JAK.RPC.prototype._rpcSerialize=function(a){if(!a)return"";var b=[],c;for(c in a){var d=c,e=a[c];if(e instanceof Array)if(d+="[]",e.length)for(var f=0;f<e.length;f++){var g=e[f],g=this._rpcSerializeValue(g,!1);b.push(encodeURIComponent(d)+"="+encodeURIComponent(g))}else b.push(encodeURIComponent(d)+"=");else e=this._rpcSerializeValue(e,!1),b.push(encodeURIComponent(d)+"="+encodeURIComponent(e))}return b.join("&")};
JAK.RPC.prototype._rpcSerializeValue=function(a,b){if(null===a)return"null";switch(typeof a){case "boolean":return a;case "string":return'"'+this._rpcEscape(a)+'"';case "number":if(!b)return 0<a?Math.floor(a):Math.ceil(a);var c=a.toString();-1==c.indexOf(".")&&(c+=".0");return c;case "object":if(!(a instanceof Date))throw Error("Unserializable object "+a);return a.format("Y-m-d\\TH:i:sO");default:throw Error("Unserializable value "+a);}};
JAK.RPC.prototype._rpcParse=function(a){switch(this._rpcType){case JAK.RPC.JSON:a=JSON.parse(a);if(!a.status&&a.failure)throw Error("JSON/"+a.failure+": "+a.failureMessage);return a;case JAK.RPC.FRPC:return JAK.FRPC.parse(a);case JAK.RPC.FRPC_B64:return a=JAK.Base64.atob(a),JAK.FRPC.parse(a);case JAK.RPC.XMLRPC:return this._rpcParseXML(a);default:throw Error("Unimplemented RPC type "+this._rpcType);}};
JAK.RPC.prototype._rpcParseXML=function(a){if(!a)return null;a=a.documentElement;if("methodResponse"!=a.nodeName)throw Error("Only XMLRPC method responses supported");var a=JAK.XML.childElements(a)[0],b=null;if("fault"==a.nodeName)throw b=JAK.XML.childElements(a,"value")[0],Error(JSON.stringify(JAK.XML.RPC.parse(b)));b=JAK.XML.childElements(a,"param")[0];b=JAK.XML.childElements(b,"value")[0];return JAK.XML.RPC.parse(b)};JAK.FRPC=JAK.ClassMaker.makeStatic({NAME:"JAK.FRPC",VERSION:"1.2"});
JAK.FRPC.TYPE_MAGIC=25;JAK.FRPC.TYPE_CALL=13;JAK.FRPC.TYPE_RESPONSE=14;JAK.FRPC.TYPE_FAULT=15;JAK.FRPC.TYPE_INT=1;JAK.FRPC.TYPE_BOOL=2;JAK.FRPC.TYPE_DOUBLE=3;JAK.FRPC.TYPE_STRING=4;JAK.FRPC.TYPE_DATETIME=5;JAK.FRPC.TYPE_BINARY=6;JAK.FRPC.TYPE_INT8P=7;JAK.FRPC.TYPE_INT8N=8;JAK.FRPC.TYPE_STRUCT=10;JAK.FRPC.TYPE_ARRAY=11;JAK.FRPC.TYPE_NULL=12;JAK.FRPC._hints=null;JAK.FRPC._path=[];JAK.FRPC._data=[];JAK.FRPC._pointer=0;
JAK.FRPC.parse=function(a){this._pointer=0;this._data=a;var a=this._getByte(),b=this._getByte();if(202!=a||17!=b)throw this._data=[],Error("Missing FRPC magic");this._getByte();this._getByte();a=this._getInt(1)>>3;if(a==JAK.FRPC.TYPE_FAULT)throw a=this._parseValue(),b=this._parseValue(),this._data=[],Error("FRPC/"+a+": "+b);b=null;switch(a){case JAK.FRPC.TYPE_RESPONSE:b=this._parseValue();if(this._pointer<this._data.length)throw this._data=[],Error("Garbage after FRPC data");break;case JAK.FRPC.TYPE_CALL:a=
this._decodeUTF8(this._getInt(1));for(b=[];this._pointer<this._data.length;)b.push(this._parseValue());this._data=[];return{method:a,params:b};default:throw this._data=[],Error("Unsupported FRPC type "+a);}this._data=[];return b};JAK.FRPC.serializeCall=function(a,b,c){b=this.serialize(b,c);b.shift();b.shift();a=this._encodeUTF8(a);b.unshift.apply(b,a);b.unshift(a.length);b.unshift(JAK.FRPC.TYPE_CALL<<3);b.unshift(202,17,2,0);return b};
JAK.FRPC.serialize=function(a,b){var c=[];this._hints=b;this._serializeValue(c,a);this._hints=null;return c};
JAK.FRPC._parseValue=function(){var a=this._getInt(1),b=a>>3;switch(b){case this.TYPE_STRING:return a=this._getInt((a&7)+1),this._decodeUTF8(a);case this.TYPE_STRUCT:b={};for(a=this._getInt((a&7)+1);a--;)this._parseMember(b);return b;case this.TYPE_ARRAY:b=[];for(a=this._getInt((a&7)+1);a--;)b.push(this._parseValue());return b;case this.TYPE_BOOL:return a&1?!0:!1;case this.TYPE_INT:var a=a&7,c=Math.pow(2,8*a),b=this._getInt(a);b>=c/2&&(b-=c);return b;case this.TYPE_DATETIME:this._getByte();b=this._getInt(4);
for(a=0;5>a;a++)this._getByte();return new Date(1E3*b);case this.TYPE_DOUBLE:return this._getDouble();case this.TYPE_BINARY:a=this._getInt((a&7)+1);for(b=[];a--;)b.push(this._getByte());break;case this.TYPE_INT8P:return this._getInt((a&7)+1);case this.TYPE_INT8N:return-this._getInt((a&7)+1);case this.TYPE_NULL:return null;default:throw Error("Unkown FRPC type "+b);}};JAK.FRPC._append=function(a,b){for(var c=b.length,d=0;d<c;d++)a.push(b[d])};
JAK.FRPC._parseMember=function(a){var b=this._decodeUTF8(this._getInt(1));a[b]=this._parseValue()};JAK.FRPC._getInt=function(a){for(var b=0,c=1,d=0;d<a;d++)b+=c*this._getByte(),c*=256;return b};JAK.FRPC._getByte=function(){if(this._pointer+1>this._data.length)throw Error("Cannot read byte from buffer");return this._data[this._pointer++]};
JAK.FRPC._decodeUTF8=function(a){var b=a,c="";if(!a)return c;for(var a=c1=c2=0,d=String.fromCharCode,e=this._data,f=this._pointer;!(b--,a=e[f],f+=1,128>a?c+=d(a):191<a&&224>a?(c2=e[f],f+=1,c+=d((a&31)<<6|c2&63),b-=1):240>a?(c2=e[f++],c3=e[f++],c+=d((a&15)<<12|(c2&63)<<6|c3&63),b-=2):248>a?(f+=3,b-=3):252>a?(f+=4,b-=4):(f+=5,b-=5),0>=b););this._pointer=f+b;return c};
JAK.FRPC._encodeUTF8=function(a){for(var b=[],c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b.push(d):(127<d&&2048>d?b.push(d>>6|192):(b.push(d>>12|224),b.push(d>>6&63|128)),b.push(d&63|128))}return b};
JAK.FRPC._getDouble=function(){for(var a=[],b=8;b--;)a[b]=this._getByte();var c=a[0]&128?1:0,d=(a[0]&127)<<4,d=d+(a[1]>>4);if(0==d)return 0*Math.pow(-1,c);var e=0,f=1,g=3,b=1;do e+=(a[f]&1<<g?1:0)*Math.pow(2,-b),b++,g--,0>g&&(g=7,f++);while(f<a.length);if(2047==d)return e?NaN:Infinity*Math.pow(-1,c);d-=1023;return Math.pow(-1,c)*Math.pow(2,d)*(1+e)};
JAK.FRPC._serializeValue=function(a,b){if(null===b)a.push(JAK.FRPC.TYPE_NULL<<3);else switch(typeof b){case "string":var c=this._encodeUTF8(b),d=this._encodeInt(c.length),e=JAK.FRPC.TYPE_STRING<<3,e=e+(d.length-1);a.push(e);this._append(a,d);this._append(a,c);break;case "number":"float"==this._getHint()?(e=JAK.FRPC.TYPE_DOUBLE<<3,c=this._encodeDouble(b)):(e=0<b?JAK.FRPC.TYPE_INT8P:JAK.FRPC.TYPE_INT8N,e<<=3,c=this._encodeInt(Math.abs(b)),e+=c.length-1);a.push(e);this._append(a,c);break;case "boolean":c=
JAK.FRPC.TYPE_BOOL<<3;b&&(c+=1);a.push(c);break;case "object":b instanceof Date?this._serializeDate(a,b):b instanceof Array?this._serializeArray(a,b):this._serializeStruct(a,b);break;default:throw Error("FRPC does not allow value "+b);}};
JAK.FRPC._serializeArray=function(a,b){if("binary"==this._getHint()){var c=JAK.FRPC.TYPE_BINARY<<3,d=this._encodeInt(b.length),c=c+(d.length-1);a.push(c);this._append(a,d);this._append(a,b)}else{c=JAK.FRPC.TYPE_ARRAY<<3;d=this._encodeInt(b.length);c+=d.length-1;a.push(c);this._append(a,d);for(c=0;c<b.length;c++)this._path.push(c),this._serializeValue(a,b[c]),this._path.pop()}};
JAK.FRPC._serializeStruct=function(a,b){var c=0,d;for(d in b)c++;var e=JAK.FRPC.TYPE_STRUCT<<3,c=this._encodeInt(c),e=e+(c.length-1);a.push(e);this._append(a,c);for(d in b)e=this._encodeUTF8(d),a.push(e.length),this._append(a,e),this._path.push(d),this._serializeValue(a,b[d]),this._path.pop()};
JAK.FRPC._serializeDate=function(a,b){a.push(JAK.FRPC.TYPE_DATETIME<<3);var c=b.getTimezoneOffset()/15;0>c&&(c+=256);a.push(c);c=Math.round(b.getTime()/1E3);if(0>c||c>=Math.pow(2,31))c=-1;0>c&&(c+=Math.pow(2,32));for(c=this._encodeInt(c);4>c.length;)c.push(0);this._append(a,c);var c=b.getFullYear()-1600,c=Math.max(c,0),c=Math.min(c,2047),d=b.getMonth()+1,e=b.getDate(),f=b.getDay(),g=b.getHours(),h=b.getMinutes(),j=b.getSeconds();a.push((j&31)<<3|f&7);a.push((h&63)<<1|(j&32)>>5|(g&1)<<7);a.push((g&
30)>>1|(e&15)<<4);a.push((e&31)>>4|(d&15)<<1|(c&7)<<5);a.push((c&2040)>>3)};JAK.FRPC._encodeInt=function(a){if(!a)return[0];for(var b=[];a;){var c=a%256,a=(a-c)/256;b.push(c)}return b};
JAK.FRPC._encodeDouble=function(a){var b=[],c,d,e;if(isNaN(a))d=2047,e=1,c=0;else if(Infinity===a||-Infinity===a)d=2047,e=0,c=0>a?1:0;else if(0===a)e=d=0,c=-Infinity===1/a?1:0;else{c=0>a;var f=Math.abs(a);f>=Math.pow(2,-1022)?(a=Math.min(Math.floor(Math.log(f)/Math.LN2),1023),d=a+1023,e=f*Math.pow(2,52-a)-Math.pow(2,52)):(d=0,e=f/Math.pow(2,-1074))}f=[];for(a=52;0<a;a--)f.push(e%2?1:0),e=Math.floor(e/2);for(a=11;0<a;a--)f.push(d%2?1:0),d=Math.floor(d/2);f.push(c?1:0);for(c=a=0;f.length;)a+=(1<<c)*
f.shift(),c++,8==c&&(b.push(a),c=a=0);return b};JAK.FRPC._getHint=function(){return!this._hints?null:"object"!=typeof this._hints?this._hints:this._hints[this._path.join(".")]||null};JAK.Base64=JAK.ClassMaker.makeStatic({NAME:"JAK.Base64",VERSION:"1.0"});JAK.Base64.ALPHABET="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";JAK.Base64.INDEXED_ALPHABET=JAK.Base64.ALPHABET.split("");JAK.Base64.ASSOCIATED_ALPHABET={};
for(var i=0;i<JAK.Base64.ALPHABET.length;i++)JAK.Base64.ASSOCIATED_ALPHABET[JAK.Base64.ALPHABET.charAt(i)]=i;JAK.Base64.atob=function(a){for(var b=[],c,d,e,f,g=a.replace(/\s/g,"").split(""),h=0,j=g.length;h<j;h+=4)c=JAK.Base64.ASSOCIATED_ALPHABET[g[h]],d=JAK.Base64.ASSOCIATED_ALPHABET[g[h+1]],a=JAK.Base64.ASSOCIATED_ALPHABET[g[h+2]],f=JAK.Base64.ASSOCIATED_ALPHABET[g[h+3]],c=c<<2|d>>4,d=(d&15)<<4|a>>2,e=(a&3)<<6|f,b.push(c),64!=a&&b.push(d),64!=f&&b.push(e);return b};
JAK.Base64.btoa=function(a){var b=[],c,d,e,f,g,h,j=0,k=a.length;do c=j<a.length?a[j++]:NaN,d=j<a.length?a[j++]:NaN,e=j<a.length?a[j++]:NaN,f=c>>2,c=(c&3)<<4|d>>4,g=(d&15)<<2|e>>6,h=e&63,isNaN(d)?g=h=64:isNaN(e)&&(h=64),b.push(JAK.Base64.INDEXED_ALPHABET[f]),b.push(JAK.Base64.INDEXED_ALPHABET[c]),b.push(JAK.Base64.INDEXED_ALPHABET[g]),b.push(JAK.Base64.INDEXED_ALPHABET[h]);while(j<k);return b.join("")};var SMap=JAK.ClassMaker.makeClass({NAME:"SMap",VERSION:"1.0"});SMap.MOUSE_PAN=1;
SMap.MOUSE_WHEEL=2;SMap.MOUSE_ZOOM_IN=4;SMap.MOUSE_ZOOM_OUT=8;SMap.MOUSE_ZOOM=SMap.MOUSE_ZOOM_IN+SMap.MOUSE_ZOOM_OUT;SMap.KB_PAN=1;SMap.KB_ZOOM=2;SMap.LAYER_TILE=0;SMap.LAYER_SHADOW=1;SMap.LAYER_GEOMETRY=2;SMap.LAYER_MARKER=3;SMap.LAYER_ACTIVE=4;SMap.LAYER_HUD=5;SMap.NORTH=0;SMap.WEST=1;SMap.SOUTH=2;SMap.EAST=3;SMap.DEF_BASE=1;SMap.DEF_TURIST=2;SMap.DEF_OPHOTO=3;SMap.DEF_HYBRID=4;SMap.DEF_HISTORIC=5;SMap.DEF_BIKE=6;SMap.DEF_TRAIL=7;SMap.DEF_OPHOTO0203=8;SMap.DEF_OPHOTO0406=9;SMap.DEF_RELIEF_L=10;
SMap.DEF_RELIEF_H=11;SMap.DEF_OBLIQUE=12;SMap.DEF_OBLIQUE_HYBRID=13;SMap.DEF_SMART_BASE=14;SMap.DEF_SMART_OPHOTO=15;SMap.DEF_SMART_TURIST=16;SMap.DEF_RELIEF=17;SMap.GEOMETRY_POLYLINE=0;SMap.GEOMETRY_POLYGON=1;SMap.GEOMETRY_CIRCLE=2;SMap.GEOMETRY_ELLIPSE=3;SMap.GEOMETRY_PATH=4;SMap.POI_BASE="/basepoi";SMap.TRANSFORM="";SMap.LAYER_VECTOR=SMap.LAYER_GEOMETRY;SMap.DEF_SMART=SMap.DEF_SMART_BASE;
SMap.prototype.$constructor=function(a,b,c,d){JAK.Request.supportsCrossOrigin()&&(SMap.POI_BASE=SMap.CONFIG.base+SMap.POI_BASE);this._ec=[];this._options={minZoom:3,maxZoom:18,animTime:500,zoomTime:300,rotationTime:300,orientation:SMap.NORTH,projection:new SMap.Projection.UTM33};for(var e in d)this._options[e]=d[e];this._dom={container:a};this._layers=[];this._cursor=[];this.controlLayer=!1;this.controls=[];this._card=null;this._lock=0;this._eventCoords=null;this._projection=this._options.projection;
this._availability={oblique:{},ophoto:{}};this._zoomAnimation={running:!1,sourceZoom:null,targetZoom:null,fixedPoint:null,ts:null,disabledLayers:[],tileLayers:[]};this._rotationAnimation={sourceAngle:null,targetAngle:null,targetOrientation:null,running:!1,ts:null,disabledLayers:[],tileLayers:[]};this._padding={left:0,right:0,top:0,bottom:0};this._signals=new JAK.Signals;this._sizeHalf=this._size=null;this._offset=new SMap.Pixel(0,0);this._zoom=c||6;this._center=b||SMap.Coords.fromPP(135118848,134987776);
this._orientation=this._options.orientation;this._build();this._projection.setOwner(this);this.syncPort();this.addControl(new SMap.Control.Image(SMap.CONFIG.img+"/logo.png","http://mapy.cz/#x={cx}&y={cy}&z={zoom}"),{right:"0px",bottom:"0px"});a=["msTransform","transform","WebkitTransform","MozTransform","OTransform"];for(b=0;b<a.length;b++)a[b]in document.body.style&&(this.constructor.TRANSFORM=a[b])};
SMap.prototype.$destructor=function(){JAK.DOM.clear(this._dom.container);this._dom={};JAK.Events.removeListeners(this._ec);this._layers=[];this.controlLayer.$destructor();this.controlLayer=!1;this.controls.forEach(function(a){a.$destructor()});this.controls=[];this._card&&(this._card.$destructor(),this._card=null)};
SMap.prototype.createDataProvider=function(){var a=["basepoi"],b=new SMap.DataProvider;b.setOwner(this);for(var c=0;c<a.length;c++){var d="/"+a[c],d=JAK.Request.supportsCrossOrigin()?SMap.CONFIG.base+d:d,d=new SMap.POIServer(d);d.setOwner(this);d.getPOIParams();b.addPOIServer(d)}return b};SMap.prototype.lock=function(){this._lock||this._signals.makeEvent("map-lock",this);this._lock++};
SMap.prototype.unlock=function(){if(!this._lock)throw Error("Cannot unlock unlocked map");this._lock--;this._lock||(this._signals.makeEvent("map-unlock",this),this._redraw(!1))};SMap.prototype.getSignals=function(){return this._signals};SMap.prototype.getZoomRange=function(){return[this._options.minZoom,this._options.maxZoom]};
SMap.prototype.setZoomRange=function(a,b){this._options.minZoom=a;this._options.maxZoom=b;var c=Math.max(a,this._zoom),c=Math.min(b,c);c!=this._zoom&&this.setZoom(c);this._signals.makeEvent("zoom-range-change",this)};SMap.prototype.redraw=function(){this._redraw(!1)};SMap.prototype.getOrientation=function(){return this._orientation};
SMap.prototype.setOrientation=function(a,b){if(!this._zoomAnimation.running&&(this._rotationAnimation.running||a!=this._orientation))return this._options.rotationTime&&!1!==b&&SMap.TRANSFORM?this._rotationAnimation.running?this._rotationAnimationTarget(a):this._rotationAnimationStart(a):(this._orientation=a,this._redraw(!0)),this};SMap.prototype.setProjection=function(a){this._projection&&this._projection.setOwner(null);this._projection=a;this._projection.setOwner(this);this._redraw(!0);return this};
SMap.prototype.getContainer=function(){return this._dom.container};SMap.prototype.getContent=function(){return this._dom.content};SMap.prototype.getSize=function(){return this._size};SMap.prototype.getProjection=function(){return this._projection};SMap.prototype.getOffset=function(){return this._offset};SMap.prototype.getGeometryCanvas=function(){return this._geometryCanvas};
SMap.prototype.setCursor=function(a,b,c){a?("chrome"==JAK.Browser.client&&2<arguments.length&&(a=a.replace(/,/," "+b+" "+c+",")),this._cursor.push(a)):this._cursor.length&&this._cursor.pop();this._dom.content.style.cursor=this._cursor.length?this._cursor[this._cursor.length-1]:""};
SMap.prototype.animate=function(a,b){var c={time:500},d;for(d in b)c[d]=b[d];var e=!1,f=!1;if(a instanceof SMap.Coords)f=a,e=f.toPixel(this),e.x=-e.x,e.y=-e.y;else if(a instanceof SMap.Pixel)e=a,f=(new SMap.Pixel(-e.x,-e.y)).toCoords(this);else return;var g=!1,h=new SMap.Pixel(0,0),j=(new Date).getTime();this.lock();JAK.Timekeeper.getInstance().addListener(this,function(){var a=(new Date).getTime()-j;a>c.time?(JAK.Timekeeper.getInstance().removeListener(this),this.setCenter(f),this.unlock()):(a/=
this._options.animTime,g=new SMap.Pixel(Math.round(e.x*a),Math.round(e.y*a)),g.minus(h),h.plus(g),this.setCenter(g))})};SMap.prototype.setCenter=function(a){var b=null,c=null;if(a instanceof SMap.Coords)c=a,b=c.toPixel(this),b.x=-b.x,b.y=-b.y;else if(a instanceof SMap.Pixel)b=a,c=(new SMap.Pixel(-b.x,-b.y)).toCoords(this);else return;c.isValid()&&(this._center=c,!this._setOffset(this._offset.plus(b))&&!this._lock&&this._redraw(!1))};
SMap.prototype.setZoom=function(a,b,c){if(!this._rotationAnimation.running)if(this._zoomAnimation.running)a=this._newZoom(this._zoomAnimation.targetZoom,a),this.zoomAnimationTarget(a);else if(a=this._newZoom(this._zoom,a),a!=this._zoom){var d=!1;this._card&&this._card.isVisible()?d=this._card.getAnchor():b&&(d=b);c&&this._options.zoomTime?(this.zoomAnimationStart(d||this._center),this.zoomAnimationTarget(a)):this.setCenterZoom(d?d.newCenter(this,a):this._center,a)}};
SMap.prototype.setCenterZoom=function(a,b){if(a.isValid()){var c=this._newZoom(this._zoom,b);if(c==this._zoom)this.setCenter(a);else{var d=19==this._zoom;this._zoom=c;this._center=a;this._orientation!=SMap.NORTH&&19>c?(this.setOrientation(SMap.NORTH),this.setProjection(new SMap.Projection.UTM33)):d?this.setProjection(new SMap.Projection.UTM33):this._redraw(!0)}}};SMap.prototype.getCenter=function(){return this._center};SMap.prototype.getZoom=function(){return this._zoom};
SMap.prototype.computeCenterZoom=function(a,b){for(var c=Infinity,d=Infinity,e=-Infinity,f=-Infinity,g=0;g<a.length;g++)var h=a[g],c=Math.min(c,h.x),d=Math.min(d,h.y),e=Math.max(e,h.x),f=Math.max(f,h.y);var g=(c+e)/2,h=(d+f)/2,j=this._size.x,k=this._size.y;b&&(j-=this._padding.left,j-=this._padding.right,k-=this._padding.top,k-=this._padding.bottom);c=Math.max((e-c)/j,(f-d)/k);c=Math.floor(20-Math.log(c)/Math.LN2);return[new SMap.Coords(g,h),c]};
SMap.prototype.addLayer=function(a,b){if(-1!=this._layers.indexOf(a))throw Error("Layer "+a+" is already added");this._layers.push(a);var c=a.getContainer(),d;for(d in c){if(!(d in this._dom.layers))throw Error("Cannot append layer component to map");var e=d==SMap.LAYER_GEOMETRY?this._geometryCanvas.getContent():this._dom.layers[d],f=c[d];f instanceof Array||(f=[f]);for(var g=0;g<f.length;g++){var h=f[g];b?e.insertBefore(h,e.firstChild):e.appendChild(h)}}a.setOwner(this);return a};
SMap.prototype.removeLayer=function(a){var b=this._layers.indexOf(a);if(-1==b)throw Error("Cannot find layer to be removed");a.setOwner(null);this._layers.splice(b,1);var b=a.getContainer(),c;for(c in b){var d=b[c];d instanceof Array||(d=[d]);for(var e=0;e<d.length;e++)d[e].parentNode.removeChild(d[e])}return a};SMap.prototype.getLayer=function(a){for(var b=0;b<this._layers.length;b++){var c=this._layers[b];if(c.getId()==a)return c}return null};SMap.prototype.getLayerContainer=function(a){return this._dom.layers[a]};
SMap.prototype.addControl=function(a,b){this.controls.push(a);var c=a.getContainer();c&&this.controlLayer.addItem(c,b);a.setOwner(this)};SMap.prototype.getControls=function(){return this.controls};SMap.prototype.removeControl=function(a){var b=this.controls.indexOf(a);-1!=b&&((a=a.getContainer())&&this.controlLayer.removeItem(a),this.controls.splice(b,1))};
SMap.prototype.addCard=function(a,b,c){this.removeCard();this._card=a;var d=a.getContainer();d.style.visibility="hidden";this._dom.content.appendChild(d);a.setOwner(this);a.anchorTo(b);d.style.visibility="visible";this._signals.makeEvent("card-open",this._card);c||a.makeVisible()};SMap.prototype.removeCard=function(){if(this._card){var a=this._card.getContainer();a.parentNode.removeChild(a);this._signals.makeEvent("card-close",this._card);this._card=null}};SMap.prototype.getCard=function(){return this._card};
SMap.prototype.syncPort=function(){this._size=new SMap.Pixel(this._dom.container.clientWidth,this._dom.container.clientHeight);this._sizeHalf=new SMap.Pixel(Math.round(this._size.x/2),Math.round(this._size.y/2));this._setOffset(new SMap.Pixel(0,0));this._geometryCanvas.resize(this._size.x,this._size.y);this._redraw(!0)};SMap.prototype.setPadding=function(a,b){this._padding[a]=b};SMap.prototype.getPadding=function(a){return this._padding[a]};SMap.prototype.getMap=function(){return this};
SMap.prototype.addDefaultLayer=function(a){var b=SMap.CONFIG,c=null;switch(a){case SMap.DEF_OBLIQUE:case SMap.DEF_OBLIQUE_HYBRID:b=b[a];c=new SMap.Layer.Tile.Oblique(a,b.url,b.options);c.setCopyright(b.copyright);break;case SMap.DEF_SMART_BASE:c=new SMap.Layer.Smart(a,this);break;case SMap.DEF_SMART_OPHOTO:c=new SMap.Layer.Smart(a,this,{base:SMap.DEF_OPHOTO});break;case SMap.DEF_SMART_TURIST:c=new SMap.Layer.Turist(a,this);break;default:if(!(a in b))throw Error("Invalid default layer id "+a);b=b[a];
c=new SMap.Layer.Tile(a,b.url,b.options);c.setCopyright(b.copyright)}this.addLayer(c);return c};
SMap.prototype.addDefaultContextMenu=function(){var a=new SMap.Control.ContextMenu;this.addControl(a);a.addItem(new SMap.Control.ContextMenu.Coords);a.addItem(new SMap.Control.ContextMenu.Separator);a.addItem(new SMap.Control.ContextMenu.Zoom("P\u0159ibl\u00ed\u017eit",1));a.addItem(new SMap.Control.ContextMenu.Zoom("Odd\u00e1lit",-1));this._signals.addListener(null,"map-contextmenu",function(b){a.open(b.data.event)});return a};
SMap.prototype.addDefaultControls=function(){this.addControl(new SMap.Control.Mouse(SMap.MOUSE_PAN|SMap.MOUSE_WHEEL|SMap.MOUSE_ZOOM));this.addControl(new SMap.Control.Keyboard(SMap.KB_PAN|SMap.KB_ZOOM));this.addControl(new SMap.Control.Selection(2));this.addControl(new SMap.Control.ZoomNotification);this.addControl(new SMap.Control.Compass({title:"Posun mapy"}),{right:"8px",top:"9px"});this.addControl(new SMap.Control.Zoom({"0":"Sv\u011btad\u00edly",3:"St\u00e1ty",6:"Kraje",9:"M\u011bsta",12:"Obce",
15:"Ulice",18:"Domy",19:"Pta\u010d\u00ed pohled"},{titles:["P\u0159ibl\u00ed\u017eit","Odd\u00e1lit"]}),{right:"2px",top:"79px"});this.setPadding("right",this.getPadding("right")+73+8+2);this.setCursor("move")};
SMap.prototype.formatString=function(a,b){var c=this._center.toWGS84(),d=(new SMap.Pixel(-this._sizeHalf.x-20,this._sizeHalf.y+20)).toCoords(this).toWGS84(),e=(new SMap.Pixel(-this._sizeHalf.x-20,-this._sizeHalf.y-20)).toCoords(this).toWGS84(),f=(new SMap.Pixel(this._sizeHalf.x+20,this._sizeHalf.y+20)).toCoords(this).toWGS84(),g=(new SMap.Pixel(this._sizeHalf.x+20,-this._sizeHalf.y-20)).toCoords(this).toWGS84(),h={cx:c[0].toFixed(6),cy:c[1].toFixed(6),lbx:d[0].toFixed(6),lby:d[1].toFixed(6),rtx:g[0].toFixed(6),
rty:g[1].toFixed(6),lx:Math.min(d[0],e[0],f[0],g[0]).toFixed(6),rx:Math.max(d[0],e[0],f[0],g[0]).toFixed(6),by:Math.min(d[1],e[1],f[1],g[1]).toFixed(6),ty:Math.max(d[1],e[1],f[1],g[1]).toFixed(6),zoom:this._zoom,orientation:this._orientation};return a.replace(/{(.+?)}/g,function(a,c){return c in h?h[c]:b&&c in b?b[c]:a})};
SMap.prototype.isObliqueAvailable=function(a){var a=(a||this._center).toUTM33(),b=a.join("-");if(!(b in this._availability.oblique)){this._availability.oblique[b]=!1;for(var c=SMap.CONFIG.obliqueExtents||[],d=0;d<c.length;d++)if(this._pointInPolygon(a,c[d])){this._availability.oblique[b]=!0;break}}return this._availability.oblique[b]};
SMap.prototype.isOphotoAvailable=function(a){if(this.isObliqueAvailable(a))return!0;var a=(a||this._center).toUTM33(),b=a.join("-");if(!(b in this._availability.ophoto)){this._availability.ophoto[b]=!1;for(var c=SMap.CONFIG.ophotoExtents||[],d=0;d<c.length;d++)if(this._pointInPolygon(a,c[d])){this._availability.ophoto[b]=!0;break}}return this._availability.ophoto[b]};
SMap.prototype.adjustCoordsByPadding=function(a,b,c){var c=c||this._projection,b=b||this._zoom,d=Math.round((this._padding.right-this._padding.left)/2),e=Math.round((this._padding.bottom-this._padding.left)/2),d=new SMap.Pixel(d,e);return c.shiftCoords(a,b,d)};
SMap.prototype.zoomAnimationStart=function(a){var b=this._zoomAnimation;b.fixedPoint=a;for(var c=0;c<this._layers.length;c++){var d=this._layers[c];if(d.isActive()&&!(d instanceof SMap.Layer.HUD))if(d instanceof SMap.Layer.Tile&&!d.isAlpha())b.tileLayers.push(d);else{b.disabledLayers.push(d);var d=d.getContainer(),e;for(e in d){var f=d[e];f instanceof Array||(f=[f]);f.forEach(function(a){a.style.display="none"})}}}this._signals.makeEvent("zoom-start",this,{fixedPoint:a})};
SMap.prototype.zoomAnimationStep=function(a){for(var b=this._zoomAnimation,c=0;c<b.tileLayers.length;c++)b.tileLayers[c].zoomTo(a,b.fixedPoint);this._signals.makeEvent("zoom-step",this,{currentZoom:a})};SMap.prototype.zoomAnimationTarget=function(a,b){var c=this._zoomAnimation;c.ts=(new Date).getTime();c.running?a!=c.targetZoom&&(c.sourceZoom=c.targetZoom,c.targetZoom=a):(c.targetZoom=a,c.sourceZoom=b||this._zoom,c.running=!0,JAK.Timekeeper.getInstance().addListener(this,"_zoomAnimationStep",2))};
SMap.prototype.zoomAnimationStop=function(){var a=this._zoomAnimation;a.running=!1;JAK.Timekeeper.getInstance().removeListener(this);for(var b=0;b<a.tileLayers.length;b++)a.tileLayers[b].zoomTo(a.targetZoom,a.fixedPoint);this.setCenterZoom(a.fixedPoint.newCenter(this,a.targetZoom),a.targetZoom);a.disabledLayers.forEach(function(a){var a=a.getContainer(),b;for(b in a){var e=a[b];e instanceof Array||(e=[e]);e.forEach(function(a){a.style.display=""})}});a.disabledLayers=[];a.tileLayers=[];this._signals.makeEvent("zoom-stop",
this)};SMap.prototype._zoomAnimationStep=function(){var a=this._zoomAnimation,b=(new Date).getTime()-a.ts,c=this._options.zoomTime;b>=c?this.zoomAnimationStop():this.zoomAnimationStep(a.sourceZoom+b/c*(a.targetZoom-a.sourceZoom))};SMap.prototype._pointInPolygon=function(a,b){for(var c=0,d=0;d<b.length;d++){var e=b[d?d-1:b.length-1],f=b[d];(e[1]<=a[1]&&f[1]>a[1]||e[1]>a[1]&&f[1]<=a[1])&&a[0]<e[0]+(a[1]-e[1])/(f[1]-e[1])*(f[0]-e[0])&&c++}return c&1};
SMap.prototype._newZoom=function(a,b){var c="number"==typeof b?b:a+parseInt(b),c=Math.min(this._options.maxZoom,c);return c=Math.max(c,this._options.minZoom)};SMap.prototype._setOffset=function(a){var b=!1;this._offset=a;if(15E3<Math.abs(this._offset.x)||15E3<Math.abs(this._offset.y))this._offset=new SMap.Pixel(0,0),b=!0;a=this._offset.y+this._sizeHalf.y;this._dom.content.style.left=this._offset.x+this._sizeHalf.x+"px";this._dom.content.style.top=a+"px";b&&this._redraw(!0);return b};
SMap.prototype._redraw=function(a){var b=this._geometryCanvas.getContainer();b.style.left=-(this._offset.x+this._sizeHalf.x)+"px";b.style.top=-(this._offset.y+this._sizeHalf.y)+"px";this._layers.forEach(function(b){b.redraw(a)});this._card&&this._card.anchorTo(this._card.getAnchor());this._signals.makeEvent("map-redraw",this,{full:a})};
SMap.prototype._buildLayers=function(){JAK.DOM.addClass(this._dom.container,"smap");this._dom.container.style.overflow="hidden";"absolute"!=JAK.DOM.getStyle(this._dom.container,"position")&&(this._dom.container.style.position="relative");this._dom.content=JAK.mel("div",{},{position:"absolute",width:"0px",height:"0px",margin:"0px",padding:"0px"});JAK.DOM.append([this._dom.container,this._dom.content]);this._dom.layers=[];for(var a=SMap.LAYER_HUD,b=0;b<=a;b++){var c=b==SMap.LAYER_GEOMETRY?this._geometryCanvas.getContainer():
JAK.mel("div");this._dom.layers[b]=c;(b<a?this._dom.content:this._dom.container).appendChild(c)}this._ec.push(JAK.Events.addListener(this._dom.content,"mousedown",JAK.Events.cancelDef));"ie"==JAK.Browser.client&&this._ec.push(JAK.Events.addListener(this._dom.content.firstChild,"mousemove",JAK.Events.cancelDef));this._ec.push(JAK.Events.addListener(this._dom.container,"contextmenu",JAK.Events.cancelDef));this._ec.push(JAK.Events.addListener(this._dom.content,"mousedown",this,"_mousedown"));this._ec.push(JAK.Events.addListener(this._dom.content,
"click",this,"_click"))};SMap.prototype._buildControls=function(){this.controlLayer=new SMap.Layer.HUD;var a=this.controlLayer.getContainer();JAK.DOM.addClass(a[SMap.LAYER_HUD],"noprint");this.addLayer(this.controlLayer);this.controlLayer.enable();this.addControl(new SMap.Control.Copyright,{left:"5px",bottom:"3px"})};SMap.prototype._buildGeometryCanvas=function(){this._geometryCanvas=JAK.Vector.getCanvas(1,1);this._geometryCanvas.getContainer().style.position="absolute"};
SMap.prototype._build=function(){this._buildGeometryCanvas();this._buildLayers();this._buildControls()};
SMap.prototype._rotationAnimationStart=function(a){var b=this._rotationAnimation;this._rotationAnimationTarget(a);for(var c=0;c<this._layers.length;c++){var d=this._layers[c];if(d.isActive()&&!(d instanceof SMap.Layer.HUD))if(d instanceof SMap.Layer.Tile&&!d.isAlpha())b.tileLayers.push(d);else{b.disabledLayers.push(d);var d=d.getContainer(),e;for(e in d){var f=d[e];f instanceof Array||(f=[f]);f.forEach(function(a){a.style.display="none"})}}}this._signals.makeEvent("rotation-start",this,{targetOrientation:a});
b.running=!0;b.ts=(new Date).getTime();JAK.Timekeeper.getInstance().addListener(this,"_rotationAnimationStep",2)};SMap.prototype._rotationAnimationTarget=function(a){var b=this._rotationAnimation;b.targetOrientation=a;b.sourceAngle=b.running?b.targetAngle:0;a-=this._orientation;2<Math.abs(a)&&(a=-a/3);b.targetAngle=90*a;180<=b.targetAngle-b.sourceAngle&&(b.targetAngle-=360);180<=b.sourceAngle-b.targetAngle&&(b.targetAngle+=360)};
SMap.prototype._rotationAnimationStep=function(){var a=this._rotationAnimation,b=(new Date).getTime()-a.ts,c=this._options.rotationTime;if(b>=c)this._rotationAnimationStop();else{b=b/c*(a.targetAngle-a.sourceAngle)+a.sourceAngle;for(c=0;c<a.tileLayers.length;c++)a.tileLayers[c].rotateTo(b);this._signals.makeEvent("rotation-step",this)}};
SMap.prototype._rotationAnimationStop=function(){var a=this._rotationAnimation;a.running=!1;JAK.Timekeeper.getInstance().removeListener(this);for(var b=0;b<a.tileLayers.length;b++)a.tileLayers[b].rotateTo(a.targetAngle);this._orientation=a.targetOrientation;this._redraw(!0);a.disabledLayers.forEach(function(a){var a=a.getContainer(),b;for(b in a){var e=a[b];e instanceof Array||(e=[e]);e.forEach(function(a){a.style.display=""})}});a.disabledLayers=[];a.tileLayers=[];this._signals.makeEvent("rotation-stop",
this)};SMap.prototype._mousedown=function(a){this._eventCoords=new SMap.Pixel(a.clientX,a.clientY)};SMap.prototype._click=function(a){this._eventCoords&&!(1.5<(new SMap.Pixel(a.clientX,a.clientY)).distance(this._eventCoords))&&(this._eventCoords=null,this._signals.makeEvent("map-click",this,{event:a}))};SMap.IOwned=JAK.ClassMaker.makeInterface({NAME:"SMap.IOwned",VERSION:"1.0"});SMap.IOwned.prototype.getMap=function(){return!this._owner?null:this._owner.getMap()};
SMap.IOwned.prototype.setOwner=function(a){this._owner=a;return this};SMap.Util={};SMap.Util.stringToObject=function(a){for(var b=a.split("."),c=window;b.length;)if(c=c[b.shift()],!c)throw Error("Undefined object '"+a+"'");return c};SMap.Util.mergeObject=function(a,b){for(var c in a)c in b?a[c].constructor==Object&&b[c].constructor==Object?arguments.callee(a[c],b[c]):b[c]=a[c]:b[c]=a[c]};SMap.Pixel=JAK.ClassMaker.makeClass({NAME:"SMap.Pixel",VERSION:"1.0"});
SMap.Pixel.prototype.$constructor=function(a,b){this.x=a||0;this.y=b||0};SMap.Pixel.fromEvent=function(a,b){var c=b.getContainer(),d=b.getSize(),e=Math.round(d.x/2),d=Math.round(d.y/2),f=JAK.DOM.getBoxPosition(c),g=JAK.DOM.getScrollPos();f.left-=g.x;f.top-=g.y;f.left+=c.clientLeft||0;f.top+=c.clientTop||0;f.left+=e;f.top+=d;return new this(a.clientX-f.left,a.clientY-f.top)};
SMap.Pixel.prototype.toCoords=function(a,b){var c=a.getProjection(),d=b||a.getZoom(),e=a.getOrientation();return c.pixelToCoords(this,a.getCenter(),d,e)};SMap.Pixel.prototype.plus=function(a){this.x+=a.x;this.y+=a.y;return this};SMap.Pixel.prototype.minus=function(a){this.x-=a.x;this.y-=a.y;return this};SMap.Pixel.prototype.clone=function(){return new SMap.Pixel(this.x,this.y)};SMap.Pixel.prototype.norm=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};
SMap.Pixel.prototype.distance=function(a){var b=this.x-a.x,a=this.y-a.y;return Math.sqrt(b*b+a*a)};SMap.Pixel.prototype.toString=function(){return"["+this.x+","+this.y+"]"};SMap.Pixel.prototype.toTile=function(a,b){return a.getProjection().pixelToTile(this,a.getCenter(),a.getZoom(),a.getOrientation(),b)};SMap.Coords=JAK.ClassMaker.makeClass({NAME:"SMap.Coords",VERSION:"1.0"});SMap.Coords.prototype.$constructor=function(a,b){this.x=a||0;this.y=b||0};SMap.Coords._alphabet="0ABCD2EFGH4IJKLMN6OPQRST8UVWXYZ-1abcd3efgh5ijklmn7opqrst9uvwxyz.";
SMap.Coords.fromEvent=function(a,b){return SMap.Pixel.fromEvent(a,b).toCoords(b)};SMap.Coords.fromPP=function(a,b){return new this(a,b)};SMap.Coords.fromUTM33=function(a,b){var c=(a- -37E5)*Math.pow(2,5),d=(b-13E5)*Math.pow(2,5);return new this(Math.round(c),Math.round(d))};
SMap.Coords.fromWGS84=function(a,b){if(1==arguments.length)var c=this._splitWGS84(arguments[0]),a=c[0],b=c[1];"string"==typeof a&&(a=this._fromWGS84str(a));"string"==typeof b&&(b=this._fromWGS84str(b));var c=Math.PI,d=b*c/180,c=Math.PI,e=6378137*(1-1/298.257223563),f=(40680631590769-e*e)/40680631590769;Math.sqrt(f);Math.sqrt((40680631590769-e*e)/(e*e));Math.pow((6378137-e)/(6378137+e),4);var c=(a-15)*c/180,e=Math.tan(d),g=6378137*(1-f)/Math.pow(1-f*Math.sin(d)*Math.sin(d),1.5),h=6378137/Math.sqrt(1-
f*Math.sin(d)*Math.sin(d)),j=h/g,g=Math.cos(d),k=Math.sin(d),l=1-f/4-3*f*f/64-5*Math.pow(f,3)/256,m=0.375*(f+f*f/4+15*Math.pow(f,3)/128),n=0.05859375*(f*f+3*Math.pow(f,3)/4),f=35*Math.pow(f,3)/3072,d=6378137*(l*d-m*Math.sin(2*d)+n*Math.sin(4*d)-f*Math.sin(6*d)),f=c*c/6*g*g*(j-e*e),l=Math.pow(c,4)/120*Math.pow(g,4)*(4*Math.pow(j,3)*(1-6*e*e)+j*j*(1+8*e*e)-2*j*e*e+Math.pow(e,4)),m=Math.pow(c,6)/5040*Math.pow(g,6)*(61-479*e*e+179*Math.pow(e,4)-Math.pow(e,6)),f=5E5+0.9996*h*c*g*(1+f+l+m)/1,l=c*c/2*h*
k*g,m=Math.pow(c,4)/24*h*k*Math.pow(g,3)*(4*j*j+j-e*e),j=Math.pow(c,6)/720*h*k*Math.pow(g,5)*(8*Math.pow(j,4)*(11-24*e*e)-28*Math.pow(j,3)*(1-6*e*e)+j*j*(1-32*e*e)-2*j*e*e+Math.pow(e,4)),c=Math.pow(c,8)/40320*h*k*Math.pow(g,7)*(1385-3111*e*e+543*Math.pow(e,4)-Math.pow(e,6));return this.fromUTM33(f,0.9996*(d+l+m+j+c)/1)};
SMap.Coords.fromJTSK=function(a,b){var c=this.prototype._jtsk,d,e,f;d=Math.sqrt(a*a+b*b);e=Math.atan2(b,a)/Math.sin(c.s0);f=2*(Math.atan(Math.pow(c.ro0/d,1/c.n)*Math.tan(c.s0/2+c.s45))-c.s45);d=Math.asin(Math.cos(c.ad)*Math.sin(f)-Math.sin(c.ad)*Math.cos(f)*Math.cos(e));e=Math.asin(Math.cos(f)*Math.sin(e)/Math.cos(d));var g=c.long0-e/c.alfa,h;e=d;f=!1;var j=0;do h=2*(Math.atan(Math.pow(c.k,-1/c.alfa)*Math.pow(Math.tan(d/2+c.s45),1/c.alfa)*Math.pow((1+c.e*Math.sin(e))/(1-c.e*Math.sin(e)),c.e/2))-c.s45),
1.0E-9>Math.abs(e-h)&&(f=!0),e=h,j+=1;while(!f&&15>j);if(15<=j)throw Error("JTSK latitude failed to converge after 15 iterations");g*=180/Math.PI;h*=180/Math.PI;return this.fromWGS84(g,h)};
SMap.Coords.fromEXIF=function(a){var a=a.getTags(),b=a.GPSLongitude,c=a.GPSLatitude;if(!c||!b)throw Error("No GPS data in EXIF");for(var d=0,e=0,f=1,g=0;3>g;g++)d+=b[g]/f,e+=c[g]/f,f*=60;a.GPSLongitudeRef&&"W"==a.GPSLongitudeRef.toUpperCase()&&(d=-d);a.GPSLatitudeRef&&"S"==a.GPSLatitudeRef.toUpperCase()&&(e=-e);return this.fromWGS84(d,e)};SMap.Coords._splitWGS84=function(a){a=a.match(/^(.*?[ns])(.*?[ew]?)$/i);if(!a)throw Error("Not a valid WGS84 string.");return[a[2].trim(),a[1].trim()]};
SMap.Coords._fromWGS84str=function(a){var b=0,c=a.match(/-?\d+([.,]\d*)?/g);if(!c)return b;for(var d=1,e=0;e<c.length;e++)var f=c[e].replace(/,/g,"."),b=b+parseFloat(f)/d,d=60*d;a.match(/[ws] *$/gi)&&(b*=-1);return b};
SMap.Coords.stringToCoords=function(a){for(var b=[],c=[0,0],d=0,a=a.trim().split("").reverse();a.length;){var e=this._parseNumber(a,1);48==(e&48)?(e-=48,e=((e&15)<<24)+this._parseNumber(a,4),c[d]=e):(32==(e&32)?(e=((e&15)<<12)+this._parseNumber(a,2),e-=32768):(e=((e&31)<<6)+this._parseNumber(a,1),e-=1024),c[d]+=e);d&&b.push(this.fromWGS84(360*c[0]/268435456-180,180*c[1]/268435456-90));d=(d+1)%2}return b};
SMap.Coords._parseNumber=function(a,b){for(var c=0,d=b;d;){if(!a.length)throw Error("No data!");var e=this._alphabet.indexOf(a.pop());-1!=e&&(c<<=6,c+=e,d--)}return c};SMap.Coords.coordsToString=function(a){for(var b=0,c=0,d="",e=0;e<a.length;e++){var f=a[e].toWGS84(),g=Math.round(268435456*(f[0]+180)/360),f=Math.round(268435456*(f[1]+90)/180),h=g-b,j=f-c;if(h||j)d+=this._serializeNumber(h,g),d+=this._serializeNumber(j,f),b=g,c=f}return d};
SMap.Coords._serializeNumber=function(a,b){var c="";if(-1024<=a&&1024>a)c+=this._alphabet.charAt(a+1024>>6),c+=this._alphabet.charAt(a+1024&63);else{if(-32768<=a&&32768>a)var d=131072|a+32768;else d=805306368|b&268435455,c+=this._alphabet.charAt(d>>24&63),c+=this._alphabet.charAt(d>>18&63);c+=this._alphabet.charAt(d>>12&63);c+=this._alphabet.charAt(d>>6&63);c+=this._alphabet.charAt(d&63)}return c};
SMap.Coords.stringToAltitude=function(a){for(var b=[],c=0,a=a.trim().split("").reverse(),d,e,f,g;a.length;)if(d=this._parseNumber(a,1),0==(d&32)){e=1+((d&24)>>3);d=(d&7)-3;for(f=0;f<e;f++)b.push(c);4!=d&&(c+=d,b.push(c))}else 32==(d&48)?(d=(d&15)-8+(8<=(d&15)?1:0),c+=d):48==(d&56)?(e=this._parseNumber(a,1),d=(d&7)-4+(4<=(d&7)?1:0),g=(e>>3)-4+(4<=e>>3?1:0),e=(e&7)-(0>g?4:3),c+=d,b.push(c),c+=g,b.push(c),c+=e):56==(d&60)?(e=this._parseNumber(a,1),d=(d&3)<<6,g=(e&63)-128,c+=d+g):(e=this._parseNumber(a,
1),f=this._parseNumber(a,1),d=(d&3)<<12,g=(e&63)<<6,e=(f&63)-8192,c+=d+g+e),b.push(c);return b};SMap.Coords.prototype.toPixel=function(a,b){var c=a.getProjection(),d=b||a.getZoom();return c.coordsToPixel(this,a.getCenter(),d,a.getOrientation())};SMap.Coords.prototype.clone=function(){return new SMap.Coords(this.x,this.y)};SMap.Coords.prototype.newCenter=function(a,b){var c=this.toPixel(a),d=this.toPixel(a,b);return(new SMap.Pixel(d.x-c.x,d.y-c.y)).toCoords(a,b)};
SMap.Coords.prototype.fixedPoint=function(a,b){if(a.getZoom()==b)return null;var c=1-Math.pow(2,b-a.getZoom()),d=this.toPixel(a,b);d.x/=-c;d.y/=-c;return d.toCoords(a)};SMap.Coords.prototype.azimuth=function(a){var b=Math.PI/180,c=1/b,d=this.toWGS84(),e=a.toWGS84(),a=(e[0]-d[0])*b,d=d[1]*b,f=Math.PI/4,b=Math.log(Math.tan(e[1]*b/2+f)/Math.tan(d/2+f));Math.abs(a)>Math.PI&&(a=0<a?-(2*Math.PI-a):2*Math.PI+a);return(Math.atan2(a,b)*c+360)%360};
SMap.Coords.prototype.distance=function(a){var b=this.x-a.x,a=this.y-a.y;return Math.sqrt(b*b+a*a)/32};
SMap.Coords.prototype.distanceMiro=function(a,b){var c=1/298.257223563,d=6378135+(b||0),e=Math.PI/180,f=e*this.y,g=e*a.y,h=(f+g)/2,j=(f-g)/2,k=(-e*this.x- -e*a.x)/2,e=Math.sin(j),g=Math.cos(k),f=Math.cos(h),l=Math.sin(k),h=Math.sin(h),j=Math.cos(j),k=e*e*g*g+f*f*l*l,g=j*j*g*g+h*h*l*l,l=Math.atan2(Math.sqrt(k),Math.sqrt(g)),m=Math.sqrt(k*g)/l;return 2*l*d*(1+c*((3*m-1)/(2*g))*h*h*j*j-c*((3*m+1)/(2*k))*f*f*e*e)};SMap.Coords.prototype.toString=function(){return"("+this.x+","+this.y+")"};
SMap.Coords.prototype.toWGS84=function(a){var b=this.toUTM33(),c=b[0],d=b[1],b=Math.PI,e=33,f=6378137*(1-1/298.257223563),g=(40680631590769-f*f)/40680631590769;Math.sqrt(g);Math.sqrt((40680631590769-f*f)/(f*f));var h=(6378137-f)/(6378137+f),j=6378137*(1-h)*(1-h*h)*(1+2.25*h*h+3.984375*Math.pow(h,4))*(b/180),f=1*(c-5E5),c=1*(d-0)/0.9996*b/(180*j),h=c+(3*h/2-27*Math.pow(h,3)/32)*Math.sin(2*c)+(21*h*h/16-55*Math.pow(h,4)/32)*Math.sin(4*c)+151*Math.pow(h,3)/96*Math.sin(6*c)+1097*Math.pow(h,4)/512*Math.sin(8*
c),j=6378137*(1-g)/Math.pow(1-g*Math.sin(h)*Math.sin(h),1.5),c=6378137/Math.sqrt(1-g*Math.sin(h)*Math.sin(h)),d=c/j,g=Math.tan(h),c=f/(0.9996*c),k=g/(0.9996*j)*(f*c/2),l=g/(0.9996*j)*(f*Math.pow(c,3)/24)*(-4*d*d+9*d*(1-g*g)+12*g*g),m=g/(0.9996*j)*(f*Math.pow(c,5)/720)*(8*Math.pow(d,4)*(11-24*g*g)-12*Math.pow(d,3)*(21-71*g*g)+15*d*d*(15-98*g*g+15*Math.pow(g,4))+180*d*(5*g*g-3*Math.pow(g,4))+360*Math.pow(g,4)),f=g/(0.9996*j)*(f*Math.pow(c,7)/40320)*(1385+3633*g*g+4095*Math.pow(g,4)+1575*Math.pow(g,
6)),f=180*(h-k+l-m+f)/b,k=1/Math.cos(h),h=c*k,j=Math.pow(c,3)/6*k*(d+2*g*g),d=Math.pow(c,5)/120*k*(-4*Math.pow(d,3)*(1-6*g*g)+d*d*(9-68*g*g)+72*d*g*g+24*Math.pow(g,4)),c=Math.pow(c,7)/5040*k*(61+662*g*g+1320*Math.pow(g,4)+720*Math.pow(g,6)),b=[180*((6*e-183)*b/180+(h-j+d-c))/b,f];return"number"==typeof a?this._formatWGS84(b,a):b};
SMap.Coords.prototype._formatWGS84=function(a,b){for(var c=[],d=["\u00b0","'",'"'],e=[["E","W"],["N","S"]],f=Math.min(b,2),g=0;g<a.length;g++){for(var h=36E5,j=Math.round(h*Math.abs(a[g])),k="",l=0;l<=f;l++){var m=j/h;l<f?(m=Math.floor(m),j%=h):m=m.toFixed(7-2*f);h/=60;k+=m;k+=d[l]}k+=0<a[g]?e[g][0]:e[g][1];c.push(k)}return c};SMap.Coords.prototype.toPP=function(){return[this.x,this.y]};
SMap.Coords.prototype.toUTM33=function(){var a=this.x*Math.pow(2,-5)+-37E5,b=this.y*Math.pow(2,-5)+13E5;return[a,b]};
SMap.Coords.prototype.toJTSK=function(){var a=this.toWGS84(),b=a[0],c=a[1],b=b*(Math.PI/180),c=c*(Math.PI/180),a=this._jtsk,d;d=b-a.long0;b=Math.pow((1+a.e*Math.sin(c))/(1-a.e*Math.sin(c)),a.alfa*a.e/2);b=2*(Math.atan(a.k*Math.pow(Math.tan(c/2+a.s45),a.alfa)/b)-a.s45);d=-d*a.alfa;c=Math.asin(Math.cos(a.ad)*Math.sin(b)+Math.sin(a.ad)*Math.cos(b)*Math.cos(d));b=Math.asin(Math.cos(b)*Math.sin(d)/Math.cos(c));b*=a.n;a=a.ro0*Math.pow(Math.tan(a.s0/2+a.s45),a.n)/Math.pow(Math.tan(c/2+a.s45),a.n);return[a*
Math.cos(b),a*Math.sin(b)]};SMap.Coords.prototype.isValid=function(){var a=this.toPP();return 58720256<=a[0]&&209715200>=a[0]&&58720256<=a[1]&&218103808>=a[1]};SMap.Coords.prototype.inMap=function(a,b){var c=a.getSize(),d=Math.round(c.x/2),e=Math.round(c.y/2),c=new SMap.Pixel(-d,-e),d=new SMap.Pixel(d,e);b&&(c.x+=a.getPadding("left"),c.y-=a.getPadding("bottom"),d.x-=a.getPadding("right"),d.y+=a.getPadding("top"));e=this.toPixel(a);return e.x>=c.x&&e.x<=d.x&&e.y>=c.y&&e.y<=d.y};
SMap.Coords.prototype._jtsk={};
(function(){var a=SMap.Coords.prototype._jtsk;a.a=6377397.155;a.es=0.006674372230614;a.e=Math.sqrt(a.es);a.lat0||(a.lat0=0.863937979737193);a.long0||(a.long0=0.4334234309119251);a.k0||(a.k0=0.9999);a.s45=0.785398163397448;a.s90=2*a.s45;a.fi0=a.lat0;a.e2=a.es;a.e=Math.sqrt(a.e2);a.alfa=Math.sqrt(1+a.e2*Math.pow(Math.cos(a.fi0),4)/(1-a.e2));a.uq=1.04216856380474;a.u0=Math.asin(Math.sin(a.fi0)/a.alfa);a.g=Math.pow((1+a.e*Math.sin(a.fi0))/(1-a.e*Math.sin(a.fi0)),a.alfa*a.e/2);a.k=Math.tan(a.u0/2+a.s45)/
Math.pow(Math.tan(a.fi0/2+a.s45),a.alfa)*a.g;a.k1=a.k0;a.n0=a.a*Math.sqrt(1-a.e2)/(1-a.e2*Math.pow(Math.sin(a.fi0),2));a.s0=1.37008346281555;a.n=Math.sin(a.s0);a.ro0=a.k1*a.n0/Math.tan(a.s0);a.ad=a.s90-a.uq})();SMap.Tile=JAK.ClassMaker.makeClass({NAME:"SMap.Tile",VERSION:"1.0"});SMap.Tile.prototype.$constructor=function(a,b,c,d){this.tileSize=b;this.zoom=a;this.x=c;this.y=d};SMap.Tile.prototype.clone=function(){return new SMap.Tile(this.zoom,this.tileSize,this.x,this.y)};
SMap.Tile.prototype.toPixel=function(a){return a.getProjection().tileToPixel(this,a.getCenter(),a.getZoom(),a.getOrientation())};SMap.Projection=JAK.ClassMaker.makeClass({NAME:"SMap.Projection",VERSION:"1.0",IMPLEMENT:SMap.IOwned});SMap.Projection.prototype.$constructor=function(){this._owner=null};SMap.Projection.prototype.pixelToCoords=function(a,b,c,d){return this._absolutePixelToCoords(this._pixelToAbsolutePixel(a,b,c,d),c)};
SMap.Projection.prototype.coordsToPixel=function(a,b,c,d){return this._absolutePixelToPixel(this._coordsToAbsolutePixel(a,c),b,c,d)};SMap.Projection.prototype.pixelToTile=function(a,b,c,d,e){a=this._pixelToAbsolutePixel(a,b,c,d);return new SMap.Tile(c,e,Math.floor(a.x/e),Math.floor(a.y/e))};
SMap.Projection.prototype.tileToPixel=function(a,b,c,d){var e=a.tileSize,f=a.x*a.tileSize,a=a.y*a.tileSize,g=this._screenCoefficients,b=this._coordsToAbsolutePixel(b,c);switch(d){case SMap.NORTH:var h=new SMap.Pixel(f-b.x,a-b.y);-1==g.x&&(h.x=-h.x-e);-1==g.y&&(h.y=-h.y-e);break;case SMap.WEST:h=new SMap.Pixel(a-b.y,f-b.x);1==g.y&&(h.x=-h.x-e);-1==g.x&&(h.y=-h.y-e);break;case SMap.SOUTH:h=new SMap.Pixel(f-b.x,a-b.y);1==g.x&&(h.x=-h.x-e);1==g.y&&(h.y=-h.y-e);break;case SMap.EAST:if(h=new SMap.Pixel(a-
b.y,f-b.x),-1==g.y&&(h.x=-h.x-e),1==g.x)h.y=-h.y-e}return h};SMap.Projection.prototype.shiftCoords=function(a,b,c){return this._absolutePixelToCoords(this._coordsToAbsolutePixel(a,b).plus(c),b)};
SMap.Projection.prototype._pixelToAbsolutePixel=function(a,b,c,d){b=this._coordsToAbsolutePixel(b,c);c=this._screenCoefficients;switch(d){case SMap.NORTH:b.x+=c.x*a.x;b.y+=c.y*a.y;break;case SMap.WEST:b.x+=c.x*a.y;b.y-=c.y*a.x;break;case SMap.SOUTH:b.x-=c.x*a.x;b.y-=c.y*a.y;break;case SMap.EAST:b.x-=c.x*a.y,b.y+=c.y*a.x}return b};
SMap.Projection.prototype._absolutePixelToPixel=function(a,b,c,d){b=this._coordsToAbsolutePixel(b,c);c=this._screenCoefficients;switch(d){case SMap.NORTH:return new SMap.Pixel(c.x*(a.x-b.x),c.y*(a.y-b.y));case SMap.WEST:return new SMap.Pixel(c.y*(b.y-a.y),c.x*(a.x-b.x));case SMap.SOUTH:return new SMap.Pixel(c.x*(b.x-a.x),c.y*(b.y-a.y));case SMap.EAST:return new SMap.Pixel(c.y*(a.y-b.y),c.x*(b.x-a.x))}};SMap.Projection.prototype._coordsToAbsolutePixel=function(){};
SMap.Projection.prototype._absolutePixelToCoords=function(){};SMap.Projection.prototype._screenCoefficients={x:1,y:1};SMap.Projection.Mercator=JAK.ClassMaker.makeClass({NAME:"SMap.Projection.Mercator",VERSION:"1.0",EXTEND:SMap.Projection});SMap.Projection.Mercator.WORLD_SIZE=256;
SMap.Projection.Mercator.prototype._absolutePixelToCoords=function(a,b){var c=this.constructor.WORLD_SIZE<<b,d=360*a.x/c-180,c=2*Math.atan(Math.exp(Math.PI*(1-2*a.y/c)))-0.5*Math.PI,c=180*c/Math.PI;return SMap.Coords.fromWGS84(d,c)};
SMap.Projection.Mercator.prototype._coordsToAbsolutePixel=function(a,b){var c=a.toWGS84(),d=this.constructor.WORLD_SIZE<<b,e=Math.round((c[0]+180)/360*d),c=c[1]*Math.PI/180,c=Math.min(Math.max(Math.sin(c),-0.9999),0.9999),c=Math.round((1-0.5*Math.log((1+c)/(1-c))/Math.PI)/2*d);return new SMap.Pixel(e,c)};SMap.Projection.UTM33=JAK.ClassMaker.makeClass({NAME:"SMap.Projection.UTM33",VERSION:"1.0",EXTEND:SMap.Projection});SMap.Projection.UTM33.prototype._screenCoefficients={x:1,y:-1};
SMap.Projection.UTM33.prototype._absolutePixelToCoords=function(a,b){return SMap.Coords.fromPP(a.x<<20-b,a.y<<20-b)};SMap.Projection.UTM33.prototype._coordsToAbsolutePixel=function(a,b){var c=a.toPP(),d=Math.pow(2,20-b);return new SMap.Pixel(Math.round(c[0]/d),Math.round(c[1]/d))};SMap.Projection.Oblique=JAK.ClassMaker.makeClass({NAME:"SMap.Projection.Oblique",VERSION:"1.0",EXTEND:SMap.Projection});SMap.Projection.Oblique.CORS=JAK.Request.supportsCrossOrigin();
SMap.Projection.Oblique.create=function(a,b,c,d){var e=new JAK.Request(JAK.Request.XML);e.setCallback(function(e){(e=SMap.Projection.Oblique.fromXML(e,b,a))?c(e):d&&d()});var f={loc:a.toWGS84().join(","),direct:b};e.send((SMap.Projection.Oblique.CORS?SMap.CONFIG.base:"")+"/oblique/",f);return e};
SMap.Projection.Oblique.fromXML=function(a,b,c){if(!a||200!=a.getElementsByTagName("status")[0].getAttribute("status"))return null;for(var d=function(a){return a.split(",").map(function(a){return parseFloat(a)})},e=a.getElementsByTagName("name")[0].getAttribute("name"),f=["a","b","c","d"],g=0;g<f.length;g++){var h=a.getElementsByTagName(f[g])[0].getAttribute("point");f[g]=d(h)}var g=d(a.getElementsByTagName("center")[0].getAttribute("point")),h=d(a.getElementsByTagName("best")[0].getAttribute("point")),
d=d(a.getElementsByTagName("angles")[0].getAttribute("angle")),j=parseFloat(a.getElementsByTagName("multiplier")[0].getAttribute("multiplier")),k=0.0497696,l=6.8E-6,m=new SMap.Pixel(5412,7216),n=new SMap.Pixel(5412,7216),o=new SMap.Pixel(0,0),a=a.getElementsByTagName("image");a.length&&(a=a[0],k=parseFloat(a.getAttribute("focalLength")),l=parseFloat(a.getAttribute("pixelSize")),m.x=parseInt(a.getAttribute("width")),m.y=parseInt(a.getAttribute("height")),n.x=parseInt(a.getAttribute("originalWidth"))||
m.x,n.y=parseInt(a.getAttribute("originalHeight"))||m.y,o.x=parseInt(a.getAttribute("offsetX"))||0,o.y=parseInt(a.getAttribute("offsetY"))||0);return new this(e,{points:f,center:g,best:h,angles:d,focalLength:k,pixelSize:l/j,imageSize:m,originalImageSize:n,imageOffset:o},b,c)};SMap.Projection.Oblique.prototype._screenCoefficients={x:1,y:1};
SMap.Projection.Oblique.prototype.$constructor=function(a,b,c,d){this.$super();this._response=this._response.bind(this);this._fail=this._fail.bind(this);this._sc=[];this._nextProjection=null;this._rotating=!1;this._id=a;this._coords=d;this._a=b.points[0];this._b=b.points[1];this._c=b.points[2];this._d=b.points[3];this._best=b.best;this._omega=b.angles[0];this._phi=b.angles[1];this._kappa=b.angles[2];this._center=b.center;this._imageSize=b.imageSize;this._focalLength=b.focalLength;this._px=this._pixelSize=
b.pixelSize;this._orientation=c;this._originalImageSize=b.originalImageSize;this._imageOffset=b.imageOffset;this._triangles=[new SMap.Projection.Oblique.Triangle(this._a,this._b,b.best),new SMap.Projection.Oblique.Triangle(this._b,this._c,b.best),new SMap.Projection.Oblique.Triangle(this._c,this._d,b.best),new SMap.Projection.Oblique.Triangle(this._d,this._a,b.best)];var a=Math.cos(this._phi),b=Math.cos(this._kappa),c=Math.cos(this._omega),d=Math.sin(this._phi),e=Math.sin(this._kappa),f=Math.sin(this._omega);
this._rotMatrix=new SMap.Projection.Oblique.Matrix([[a*b,c*e+f*d*b,f*e-c*d*b],[-a*e,-f*d*e+c*b,c*d*e+f*b],[d,-f*a,c*a]]);this._rotMatrixTr=this._rotMatrix.transpose()};
SMap.Projection.Oblique.prototype.setOwner=function(a){this._owner&&this._owner.getSignals().removeListeners(this._sc);this.$super(a);a&&(a=a.getSignals(),this._sc.push(a.addListener(this,"map-redraw","_mapRedraw")),this._sc.push(a.addListener(this,"rotation-start","_rotationStart")),this._sc.push(a.addListener(this,"rotation-stop","_rotationStop")))};SMap.Projection.Oblique.prototype.getId=function(){return this._id};
SMap.Projection.Oblique.prototype.isValid=function(){if(this.getMap().getOrientation()!=this._orientation)return!1;var a=this._owner.getCenter();if(10>a.distance(this._coords))return!0;var b=this._coordsToAbsolutePixel(a),a=Math.min(Math.abs(b.x),Math.abs(this._imageSize.x-b.x)),b=Math.min(Math.abs(b.y),Math.abs(this._imageSize.y-b.y)),c=this.getMap().getSize();Math.min(a,b);return a<c.x/2+100||b<c.y/2+100?!1:!0};
SMap.Projection.Oblique.prototype._getElevation=function(a){for(var b=0,c=this._triangles.length;b<c;++b)if(this._triangles[b].containsPoint(a))return this._triangles[b].interpolatePoint(a);return null};
SMap.Projection.Oblique.prototype._absolutePixelToCoords=function(a){var b=this._originalImageSize.x*this._pixelSize,c=this._originalImageSize.y*this._pixelSize;a.x=this._imageOffset.x+a.x;a.y=this._imageOffset.y+a.y;var d=[0,0,-this._focalLength];d[0]=a.x*this._pixelSize-b/2;d[1]=c/2-a.y*this._pixelSize;a=new SMap.Projection.Oblique.Vector(d);b=new SMap.Projection.Oblique.Vector(this._center);a=this._rotMatrixTr.mulByVector(a).plus(b).getPoint();b=0;for(c=this._triangles.length;b<c;++b)if(d=this._triangles[b].rayIntersection(this._center,
a))return SMap.Coords.fromUTM33(d[0],d[1]);return null};
SMap.Projection.Oblique.prototype._coordsToAbsolutePixel=function(a){var b=this._originalImageSize.x*this._pixelSize,c=this._originalImageSize.y*this._pixelSize,a=a.toUTM33();a.push(0);var d=this._getElevation(a);if(null==d)return null;a[2]=d;var a=this._rotMatrix.mulByVector(new SMap.Projection.Oblique.Vector(this._center,a)).getPoint(),d=-this._focalLength/a[2],e=new SMap.Pixel(0,0);e.x=Math.round((a[0]*d+b/2)/this._pixelSize);e.y=Math.round((c/2-a[1]*d)/this._pixelSize);e.x-=this._imageOffset.x;
e.y-=this._imageOffset.y;return e};SMap.Projection.Oblique.prototype.pixelToTile=function(a,b,c,d,e){a=this._pixelToAbsolutePixel(a,b,c,d);a.y=this._imageSize.y-a.y;return new SMap.Tile(c,e,Math.floor(a.x/e),Math.floor(a.y/e))};SMap.Projection.Oblique.prototype.tileToPixel=function(a,b,c){var d=a.tileSize,e=a.x*a.tileSize,a=this._imageSize.y-a.y*a.tileSize,b=this._coordsToAbsolutePixel(b,c),b=new SMap.Pixel(e-b.x,a-b.y);b.y-=d;return b};
SMap.Projection.Oblique.prototype._pixelToAbsolutePixel=function(a,b,c){return this.$super(a,b,c,SMap.NORTH)};SMap.Projection.Oblique.prototype._absolutePixelToPixel=function(a,b,c){return this.$super(a,b,c,SMap.NORTH)};SMap.Projection.Oblique.prototype._mapRedraw=function(){if(!this._rotating&&!this.isValid()&&!this._rq){var a=this.getMap();this._rq=this.constructor.create(a.getCenter(),a.getOrientation(),this._response,this._fail)}};SMap.Projection.Oblique.prototype._fail=function(){this._rq=null};
SMap.Projection.Oblique.prototype._rotationStart=function(a){this._nextProjection=null;this._rotating=!0;var b=this.getMap(),c=b.getOrientation();this._rq=this.constructor.create(b.getCenter(),a.data.targetOrientation,function(a){this._rq=null;var b=this.getMap();this._rotating?this._nextProjection=a:b&&b.setProjection(a)}.bind(this),function(){this._rq=null;var a=this.getMap();this._rotating?this._nextProjection=c:a&&a.setOrientation(c,!1)}.bind(this))};
SMap.Projection.Oblique.prototype._rotationStop=function(){this._rotating=!1;var a=this.getMap();a&&null!==this._nextProjection&&(this._nextProjection instanceof SMap.Projection?a.setProjection(this._nextProjection):a.setOrientation(this._nextProjection,!1))};SMap.Projection.Oblique.prototype._response=function(a){this._rq=null;this.getMap().setProjection(a)};SMap.Projection.Oblique.Vector=JAK.ClassMaker.makeClass({NAME:"SMap.Projection.Oblique.Vector",VERSION:"1.0"});
SMap.Projection.Oblique.Vector.prototype.$constructor=function(a,b){1==arguments.length?(this._x=a[0],this._y=a[1],this._z=a[2]):2==arguments.length?(this._x=b[0]-a[0],this._y=b[1]-a[1],this._z=b[2]-a[2]):this._z=this._y=this._x=0};SMap.Projection.Oblique.Vector.prototype.getPoint=function(){return[this._x,this._y,this._z]};SMap.Projection.Oblique.Vector.prototype.norm=function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)};
SMap.Projection.Oblique.Vector.prototype.normalize=function(){var a=this.norm();this._x/=a;this._y/=a;this._z/=a};SMap.Projection.Oblique.Vector.prototype.dot=function(a){return this._x*a._x+this._y*a._y+this._z*a._z};SMap.Projection.Oblique.Vector.prototype.cross=function(a){return new SMap.Projection.Oblique.Vector([this._y*a._z-this._z*a._y,this._z*a._x-this._x*a._z,this._x*a._y-this._y*a._x])};
SMap.Projection.Oblique.Vector.prototype.plus=function(a){return new SMap.Projection.Oblique.Vector([this._x+a._x,this._y+a._y,this._z+a._z])};SMap.Projection.Oblique.Vector.prototype.mul=function(a){return new SMap.Projection.Oblique.Vector([this._x*a,this._y*a,this._z*a])};SMap.Projection.Oblique.Vector.prototype.minus=function(a){return new SMap.Projection.Oblique.Vector([this._x-a._x,this._y-a._y,this._z-a._z])};
SMap.Projection.Oblique.Matrix=JAK.ClassMaker.makeClass({NAME:"SMap.Projection.Oblique.Matrix",VERSION:"1.0"});SMap.Projection.Oblique.Matrix.prototype.$constructor=function(a){this._data=1==arguments.length?a:[[0,0,0],[0,0,0],[0,0,0]]};
SMap.Projection.Oblique.Matrix.prototype.mulByVector=function(a){return new SMap.Projection.Oblique.Vector([this._data[0][0]*a._x+this._data[0][1]*a._y+this._data[0][2]*a._z,this._data[1][0]*a._x+this._data[1][1]*a._y+this._data[1][2]*a._z,this._data[2][0]*a._x+this._data[2][1]*a._y+this._data[2][2]*a._z])};
SMap.Projection.Oblique.Matrix.prototype.transpose=function(){return new SMap.Projection.Oblique.Matrix([[this._data[0][0],this._data[1][0],this._data[2][0]],[this._data[0][1],this._data[1][1],this._data[2][1]],[this._data[0][2],this._data[1][2],this._data[2][2]]])};SMap.Projection.Oblique.Triangle=JAK.ClassMaker.makeClass({NAME:"SMap.Projection.Oblique.Triangle",VERSION:"1.0"});
SMap.Projection.Oblique.Triangle.prototype.$constructor=function(a,b,c){3==arguments.length?(this._a=a,this._b=b,this._c=c,this._computeABC()):(this._a=[0,0,0],this._b=[0,0,0],this._c=[0,0,0])};SMap.Projection.Oblique.Triangle.prototype._sameSide=function(a,b,c,d){d=new SMap.Projection.Oblique.Vector(c,d);a=new SMap.Projection.Oblique.Vector(c,a);b=new SMap.Projection.Oblique.Vector(c,b);c=d.cross(a);d=d.cross(b);return 0<=c.dot(d)?!0:!1};
SMap.Projection.Oblique.Triangle.prototype.containsPoint=function(a){var a=[a[0],a[1],0],b=[this._a[0],this._a[1],0],c=[this._b[0],this._b[1],0],d=[this._c[0],this._c[1],0];return this._sameSide(a,b,c,d)&&this._sameSide(a,c,b,d)};
SMap.Projection.Oblique.Triangle.prototype._computeABC=function(){var a=this._a[0]-this._b[0],b=this._a[1]-this._b[1],c=this._a[0]-this._c[0],d=this._a[1]-this._c[1],e=this._a[2]-this._b[2],f=this._a[2]-this._c[2],g=a*d-c*b;this._A=(e*d-f*b)/g;this._B=(a*f-c*e)/g;this._C=this._a[2]-this._A*this._a[0]-this._B*this._a[1]};
SMap.Projection.Oblique.Triangle.prototype.rayIntersection=function(a,b){var c=new SMap.Projection.Oblique.Vector(a,b),d=new SMap.Projection.Oblique.Vector([this._A,this._B,-1]),e=new SMap.Projection.Oblique.Vector(a),d=-(e.dot(d)+this._C)/c.dot(d),c=e.plus(c.mul(d)).getPoint();return this.containsPoint(c)?c:null};SMap.Projection.Oblique.Triangle.prototype.interpolatePoint=function(a){return this._A*a[0]+this._B*a[1]+this._C};
Test={name:"C5 - 5_14_10_043662.tif",a:[503636.5109654868,5559503.31847186,230.57615661621094],b:[503717.0099285099,5558846.529062748,228.6359100341797],c:[502914.6661651179,5558888.705335688,228.42263793945312],d:[502864.9232562855,5559229.376199699,234.0729217529297],angles:[0.108081,-0.556786,4.883399],center:[502836.084,5559044.579,746.352],best:[503162.309094,5559098.211615,225.921677],testPicture:function(){return new SMap.Projection.Oblique(Test.name,[Test.a,Test.b,Test.c,Test.d],Test.best,
Test.angles,Test.center)}};SMap.Layer=JAK.ClassMaker.makeClass({NAME:"SMap.Layer",VERSION:"1.0",IMPLEMENT:SMap.IOwned});SMap.Layer.prototype.$constructor=function(a){this._id=a||Math.random();this._owner=null;this._dom={container:{}};this._active=!1;this._copyright={};this._build()};SMap.Layer.prototype.$destructor=function(){};SMap.Layer.prototype.setCopyright=function(a){this._copyright=a;return this};
SMap.Layer.prototype.getCopyright=function(a){for(var b in this._copyright){var c=this._copyright[b],d=b.match(/([0-9]*)(-?)([0-9]*)/);if(d[2]){var e=!0,f=!0;d[1]&&a<d[1]&&(e=!1);d[3]&&a>d[3]&&(f=!1);if(e&&f)return c}else if(a==d[1])return c}return null};SMap.Layer.prototype.getId=function(){return this._id};SMap.Layer.prototype.enable=function(){if(!this._active)return this._active=!0,this.redraw(!0),this.getMap().getSignals().makeEvent("layer-enable",this),this};
SMap.Layer.prototype.disable=function(){if(this._active)return this._active=!1,this.clear(),this.getMap().getSignals().makeEvent("layer-disable",this),this};SMap.Layer.prototype.redraw=function(){};SMap.Layer.prototype.clear=function(){};SMap.Layer.prototype.getContainer=function(){return this._dom.container};SMap.Layer.prototype.isActive=function(){return this._active};SMap.Layer.prototype.removeAll=function(){};SMap.Layer.prototype._build=function(){};
SMap.Layer.HUD=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.HUD",VERSION:"1.0",EXTEND:SMap.Layer});SMap.Layer.HUD.prototype.clear=function(){this._dom.container[SMap.LAYER_HUD].style.display="none"};SMap.Layer.HUD.prototype.enable=function(){this._dom.container[SMap.LAYER_HUD].style.display="";this.$super()};SMap.Layer.HUD.prototype.setOwner=function(a){this._owner=a};SMap.Layer.HUD.prototype.addItem=function(a,b){a.style.position="absolute";for(var c in b)a.style[c]=b[c];this._dom.container[SMap.LAYER_HUD].appendChild(a)};
SMap.Layer.HUD.prototype.removeItem=function(a){a.parentNode.removeChild(a)};SMap.Layer.HUD.prototype._build=function(){this._dom.container[SMap.LAYER_HUD]=JAK.mel("div")};SMap.Layer.Multi=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Multi",VERSION:"1.0",EXTEND:SMap.Layer});SMap.Layer.Multi.prototype.$destructor=function(){this.$super();for(var a=0;a<this._layers.length;a++)this._layers[a].$destructor()};SMap.Layer.Multi.prototype.redraw=function(a){for(var b=0;b<this._layers.length;b++)this._layers[b].redraw(a)};
SMap.Layer.Multi.prototype.clear=function(){for(var a=0;a<this._layers.length;a++)this._layers[a].clear()};SMap.Layer.Multi.prototype.removeAll=function(){for(var a=0;a<this._layers.length;a++)this._layers[a].removeAll()};SMap.Layer.Multi.prototype.enable=function(){if(!this._active){this._active=!0;for(var a=0;a<this._layers.length;a++)this._layers[a].enable();this.getMap().getSignals().makeEvent("layer-enable",this)}};
SMap.Layer.Multi.prototype.disable=function(){if(this._active){this._active=!1;for(var a=0;a<this._layers.length;a++)this._layers[a].disable();this.getMap().getSignals().makeEvent("layer-disable",this)}};SMap.Layer.Multi.prototype.setOwner=function(a){this.$super(a);for(var b=0;b<this._layers.length;b++)this._layers[b].setOwner(a)};SMap.Layer.Multi.prototype.getContainer=function(){for(var a={},b=0;b<this._layers.length;b++){var c=this._layers[b].getContainer(),d;for(d in c)d in a||(a[d]=[]),a[d].push(c[d])}return a};
SMap.Layer.Multi.prototype.addLayer=function(a){this._layers.push(a);this.getMap()&&a.setOwner(a);this._active&&a.enable()};SMap.Layer.Multi.prototype.removeLayer=function(a){var b=this._layers.indexOf(a);-1!=b&&(a.$destructor(),this._layers.splice(b,1))};SMap.Layer.Multi.prototype.getLayers=function(){return this._layers};SMap.Layer.Multi.prototype._build=function(){this._layers=[]};SMap.Layer.Canvas=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Canvas",VERSION:"1.0",EXTEND:SMap.Layer});
SMap.Layer.Canvas.prototype.$constructor=function(a,b){this._layerId=b;this._context=null;this.$super(a)};SMap.Layer.Canvas.prototype.$destructor=function(){this.clear();this.$super()};SMap.Layer.Canvas.prototype.clear=function(){this._context&&this._context.clearRect(0,0,this._context.canvas.width,this._context.canvas.height)};SMap.Layer.Canvas.prototype.getContext=function(){return this._context};
SMap.Layer.Canvas.prototype._build=function(){var a=JAK.mel("canvas",{},{position:"absolute"});this._dom.container[this._layerId]=a;a.getContext&&(this._context=a.getContext("2d"))};SMap.Layer.Canvas.prototype.redraw=function(){if(this._active){var a=this._dom.container[this._layerId],b=this.getMap().getSize();a.width=b.x;a.height=b.y;var c=this.getMap().getOffset(),b=new SMap.Pixel(Math.round(b.x/2),Math.round(b.y/2));a.style.left=-(c.x+b.x)+"px";a.style.top=-(c.y+b.y)+"px"}};
SMap.Layer.Tile=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Tile",VERSION:"1.0",EXTEND:SMap.Layer});SMap.Layer.Tile.DEFAULT_OPTIONS={tileSize:256,alpha:!1,prefetch:0,prefetchDelay:1E3,fadeTime:600,gcDelay:800,gcThreshold:0.8,query:"{zoom}_{ppx}_{ppy}"};
SMap.Layer.Tile.prototype.$constructor=function(a,b,c){this.$super(a);this._options={};var a=SMap.Layer.Tile.DEFAULT_OPTIONS,d;for(d in a)this._options[d]=a[d];for(d in c)this._options[d]=c[d];this._url=b;this._nodes={img:JAK.mel("img",{alt:"",galleryimg:"no"},{position:"absolute"}),div:JAK.mel("div",null,{position:"absolute",width:this._options.tileSize+"px",height:this._options.tileSize+"px"})};this._tiles={};this._oldTiles={};this._oldVisible=!1;this._currentFilter="";this._fade={running:!1,ts:null};
this._prefetchTimeout=null;this._prefetch=this._prefetch.bind(this);this._gcTimeout=null;this._gc=this._gc.bind(this);this._fadeStep=this._fadeStep.bind(this)};SMap.Layer.Tile.prototype.setOptions=function(a){for(var b in a)this._options[b]=a[b];this.redraw(!0)};
SMap.Layer.Tile.prototype.redraw=function(a){if(this._active){this._oldTiles={};var b=this.getMap();b.getZoom();var c=this._options.tileSize;if(a)this._invalidateTiles(),!this._fade.running&&this._options.fadeTime&&(this._fade.ts=(new Date).getTime(),this._fade.running=!0,this._opacity(0),JAK.Timekeeper.getInstance().addListener(this,"_fadeStep"));else for(var d in this._tiles)this._tiles[d].used=!1;var a=b.getSize(),e=Math.round(a.x/2),f=Math.round(a.y/2),g=new SMap.Pixel(0,0),g=g.toTile(b,c).toPixel(b),
a=new SMap.Pixel(0,0);for(d=new SMap.Pixel(0,0);a.x*c+g.x>-e;)a.x--;for(;a.y*c+g.y>-f;)a.y--;for(;d.x*c+g.x+c<e;)d.x++;for(;d.y*c+g.y+c<f;)d.y++;e=[];for(f=a.x;f<=d.x;f++)for(var h=a.y;h<=d.y;h++)g=new SMap.Pixel(f*c,h*c),g={used:!0,node:null,px:g,tile:g.toTile(b,c)},e.push(g);this._render(e);this._gcTimeout=setTimeout(this._gc,this._options.gcDelay);this._options.prefetch&&(this._options.prefetchDelay?(this._prefetchTimeout&&clearTimeout(this._prefetchTimeout),this._prefetchTimeout=setTimeout(this._prefetch,
this._options.prefetchDelay)):this._prefetch())}};SMap.Layer.Tile.prototype.setURL=function(a){a!=this._url&&(this._url=a,this.redraw(!0))};SMap.Layer.Tile.prototype.clear=function(){this._dom.cNew.innerHTML="";this._dom.cOld.innerHTML="";this._oldVisible&&(this._dom.cOld.parentNode.removeChild(this._dom.cOld),this._oldVisible=!1);this._tiles={}};
SMap.Layer.Tile.prototype.zoomTo=function(a,b){for(var c in this._tiles)this._oldTiles[c]=this._tiles[c];this._invalidateTiles();var d=this.getMap(),e=a-this.getMap().getZoom(),e=Math.pow(2,e),f=d.getOffset(),d=b.toPixel(d);d.x-=f.x;d.y-=f.y;d.x*=1-e;d.y*=1-e;f=Math.ceil(this._options.tileSize*e);for(c in this._oldTiles){var g=this._oldTiles[c],h=g.node;h.style.width=f+"px";h.style.height=f+"px";h.style.left=Math.round(g.px.x*e+d.x)+"px";h.style.top=Math.round(g.px.y*e+d.y)+"px"}};
SMap.Layer.Tile.prototype.rotateTo=function(a){this._invalidateTiles();if(SMap.TRANSFORM){var b=this._owner.getOffset();this._dom.cOld.style[SMap.TRANSFORM]=a?"translate("+-b.x+"px, "+-b.y+"px) rotate("+a+"deg) translate("+b.x+"px,"+b.y+"px)":""}};SMap.Layer.Tile.prototype.isAlpha=function(){return this._options.alpha};
SMap.Layer.Tile.prototype._render=function(a){var b=this.getMap(),b=(new SMap.Pixel(0,0)).toTile(b,this._options.tileSize).toPixel(b).minus(b.getOffset());a.sort(function(a,b){return a.px.norm()-b.px.norm()});for(var c=this._dom.cNew,d=0;d<a.length;d++){var e=a[d],f=e.tile.x+"-"+e.tile.y;f in this._tiles?this._tiles[f].used=!0:(e.px=e.px.plus(b),e.node=this._buildElement(e),this._tiles[f]=e,c.appendChild(e.node))}};
SMap.Layer.Tile.prototype._build=function(){this._dom.cNew=JAK.mel("div",{id:this._id+"-"+SMap.LAYER_TILE+"-"+Math.random()});this._dom.cOld=JAK.mel("div");this._dom.container[SMap.LAYER_TILE]=this._dom.cNew;this._dom.cNew.style.webkitTransform="translateZ(0px)"};
SMap.Layer.Tile.prototype._invalidateTiles=function(){this._gcTimeout&&(clearTimeout(this._gcTimeout),this._gcTimeout=null);this._prefetchTimeout&&(clearTimeout(this._prefetchTimeout),this._prefetchTimeout=null);var a=this._dom.cOld,b=this._dom.cNew;this._oldVisible||(b.parentNode.insertBefore(a,b),this._oldVisible=!0);for(;b.firstChild;)a.appendChild(b.firstChild);if(this._options.alpha)for(b=0;b<a.childNodes.length;b++)a.childNodes[b].style.display="none";this._tiles={}};
SMap.Layer.Tile.prototype._opacity=function(a){var b=this._dom.cNew;if("opacity"in b.style)b.style.opacity=null===a?"":a;else if("filter"in b.style){this._currentFilter=a=null===a?"":"alpha(opacity="+Math.round(100*a)+")";for(var c in this._tiles)this._tiles[c].node.style.filter=a}};SMap.Layer.Tile.prototype._fadeStep=function(){var a=((new Date).getTime()-this._fade.ts)/this._options.fadeTime;1<=a?(JAK.Timekeeper.getInstance().removeListener(this),this._fade.running=!1,this._opacity(null)):this._opacity(a)};
SMap.Layer.Tile.prototype._buildURL=function(a){for(var b=(a.x<<28-a.zoom).toString(16),c=(a.y<<28-a.zoom).toString(16),d=1<<this._owner.getZoom(),e=a.x,f=a.y;0>e;)e+=d;for(;e>=d;)e-=d;d=this._url+this._options.query;d=d.replace(/#/,1+(a.x+a.y&3));return this.getMap().formatString(d,{ppx:b,ppy:c,x:e,y:f})};
SMap.Layer.Tile.prototype._buildElement=function(a){var b=this._buildURL(a.tile);if("ie"==JAK.Browser.client&&7>JAK.Browser.version&&this._options.alpha){var c=this._nodes.div.cloneNode(!1);c.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+b+"',sizingMethod='scale')"}else if(c=this._nodes.img.cloneNode(!1),c.src=b,this._currentFilter&&(c.style.filter=this._currentFilter),SMap.TRANSFORM){b="";switch(this.getMap().getOrientation()){case SMap.NORTH:b="";break;case SMap.SOUTH:b=
"rotate(180deg)";break;case SMap.EAST:b="rotate(270deg)";break;case SMap.WEST:b="rotate(90deg)"}c.style[SMap.TRANSFORM]=b}c.style.left=a.px.x+"px";c.style.top=a.px.y+"px";return c};
SMap.Layer.Tile.prototype._gc=function(){var a=!1,b=0,c=0,d;for(d in this._tiles)a=this._tiles[d],b++,a.node.complete&&c++;if(b&&!(c/b>=this._options.gcThreshold))this._gcTimeout=setTimeout(this._gc,this._options.gcDelay);else for(d in this._oldVisible&&(this._dom.cOld.parentNode.removeChild(this._dom.cOld),this._oldVisible=!1),this._dom.cOld.innerHTML="",SMap.TRANSFORM&&(this._dom.cOld.style[SMap.TRANSFORM]=""),this._tiles)a=this._tiles[d],a.used||(a.node.parentNode.removeChild(a.node),delete this._tiles[d])};
SMap.Layer.Tile.prototype._prefetch=function(){if(this._active){var a=this.getMap();a.getZoom();for(var b=this._options.tileSize,c=a.getSize(),d=Math.round(c.x/2),e=Math.round(c.y/2),f=new SMap.Pixel(0,0),f=f.toTile(a,b).toPixel(a),c=this._options.prefetch,g=new SMap.Pixel(0,0),h=new SMap.Pixel(0,0);g.x*b+f.x>-d;)g.x--;for(;g.y*b+f.y>-e;)g.y--;for(;h.x*b+f.x+b<d;)h.x++;for(;h.y*b+f.y+b<e;)h.y++;d=[];for(e=g.x-c;e<=h.x+c;e++)for(var j=g.y-c;j<=h.y+c;j++)e>=g.x&&e<=h.x&&j>=g.y&&j<=h.y||(f=new SMap.Pixel(e*
b,j*b),f={used:!0,node:null,px:f,tile:f.toTile(a,b)},d.push(f));this._render(d)}};SMap.Layer.Tile.Oblique=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Tile.Oblique",VERSION:"1.0",EXTEND:SMap.Layer.Tile});SMap.Layer.Tile.Oblique.prototype.redraw=function(a){if(this._active){var b=this.getMap().getProjection();b instanceof SMap.Projection.Oblique&&b.isValid()&&this.$super(a)}};
SMap.Layer.Tile.Oblique.prototype._buildURL=function(a){var b=this._url+this.getMap().getProjection().getId(),b=b.replace(/#/,1+(a.x+a.y&3)),c=a.x.toString(16).lpad("0",2),a=a.y.toString(16).lpad("0",2);return this.getMap().formatString(b,{x:c,y:a})};
SMap.Layer.Tile.Oblique.prototype._buildElement=function(a){var b=this._buildURL(a.tile);if("ie"==JAK.Browser.client&&7>JAK.Browser.version&&this._options.alpha){var c=this._nodes.div.cloneNode(!1);c.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+b+"',sizingMethod='scale')"}else c=this._nodes.img.cloneNode(!1),c.src=b,this._currentFilter&&(c.style.filter=this._currentFilter);c.style.left=a.px.x+"px";c.style.top=a.px.y+"px";return c};
SMap.Layer.Smart=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Smart",VERSION:"1.0",EXTEND:SMap.Layer.Tile});
SMap.Layer.Smart.prototype.$constructor=function(a,b,c){this.$super(a);this._options={base:SMap.DEF_BASE};for(var d in c)this._options[d]=c[d];this._layers={base:this._options.base==SMap.DEF_OPHOTO?null:b.removeLayer(b.addDefaultLayer(this._options.base)),ophoto:b.removeLayer(b.addDefaultLayer(SMap.DEF_OPHOTO)),oblique:b.removeLayer(b.addDefaultLayer(SMap.DEF_OBLIQUE)),hybrid:b.removeLayer(b.addDefaultLayer(SMap.DEF_HYBRID)),obliqueHybrid:b.removeLayer(b.addDefaultLayer(SMap.DEF_OBLIQUE_HYBRID))};
null==this._layers.base&&(this._layers.base=this._layers.ophoto);this._hybridMode=!1;this._currentHybrid=this._currentLayer=null};SMap.Layer.Smart.prototype.getLayers=function(){return this._layers};SMap.Layer.Smart.prototype.setHybrid=function(a){if(a!=this._hybridMode&&(this._hybridMode=a,this._currentHybrid))return a?this._currentHybrid.enable():this._currentHybrid.disable(),this};
SMap.Layer.Smart.prototype.redraw=function(a){if(this._active){var b=this.getMap(),c=b.getZoom(),d=b.isObliqueAvailable(),e=b.isOphotoAvailable(),f=17;e&&(f=18);d&&(f=19);18>b.getZoom()&&(e=!0);c=19==c?this._tryOblique(d):16<c?this._tryOphoto(e):this._tryBase();b.setZoomRange(3,f);c||(this._currentLayer.isActive()?this._currentLayer.redraw(a):this._currentLayer.enable(),this._currentHybrid&&this._hybridMode&&(this._currentHybrid.isActive()?this._currentHybrid.redraw(a):this._currentHybrid.enable()))}};
SMap.Layer.Smart.prototype.getSimpleLayerId=function(){if(!this._currentLayer)return null;var a=this._currentLayer.getId();return a==SMap.DEF_OBLIQUE?SMap.DEF_OPHOTO:a};SMap.Layer.Smart.prototype.clear=function(){this._currentLayer&&this._currentLayer.clear();this._currentHybrid&&this._currentHybrid.clear()};SMap.Layer.Smart.prototype.zoomTo=function(a,b){this._currentLayer&&this._currentLayer.zoomTo(a,b);this._currentHybrid&&this._currentHybrid.zoomTo(a,b)};
SMap.Layer.Smart.prototype.rotateTo=function(a){this._currentLayer&&this._currentLayer.rotateTo(a);this._currentHybrid&&this._currentHybrid.rotateTo(a)};SMap.Layer.Smart.prototype.isAlpha=function(){return!this._currentLayer?!1:this._currentLayer.isAlpha()};
SMap.Layer.Smart.prototype.getCopyright=function(a){if(!this._currentLayer)return null;var b=this._currentLayer.getCopyright(a);this._currentHybrid&&this._currentHybrid.isActive()&&(b instanceof Array||(b=[b]),b=b.concat(this._currentHybrid.getCopyright(a)));return b};SMap.Layer.Smart.prototype.setOwner=function(a){this.$super(a);for(var b in this._layers)this._layers[b].setOwner(a)};SMap.Layer.Smart.prototype.enable=function(){return this.$super()};
SMap.Layer.Smart.prototype.disable=function(){this._active&&(this.$super(),this._currentLayer.disable(),this._currentHybrid&&this._currentHybrid.disable(),this._currentLayer=null)};SMap.Layer.Smart.prototype.getContainer=function(){var a={},b;for(b in this._layers){var c=this._layers[b].getContainer(),d;for(d in c)d in a||(a[d]=[]),a[d]=a[d].concat(c[d])}return a};
SMap.Layer.Smart.prototype._tryOblique=function(a){if(a){if(this._currentLayer==this._layers.oblique)return!1;this._currentLayer&&this._currentLayer.disable();this._currentHybrid&&this._currentHybrid.disable();this._currentHybrid=this._currentLayer=null;var b=this.getMap();SMap.Projection.Oblique.create(b.getCenter(),SMap.NORTH,function(a){this._currentLayer=this._layers.oblique;this._currentHybrid=this._layers.obliqueHybrid;b.setProjection(a)}.bind(this),function(){b.setZoom(18)}.bind(this));return!0}return this._tryOphoto()};
SMap.Layer.Smart.prototype._tryOphoto=function(a){if(a){if(this._currentLayer==this._layers.ophoto)return!1;this._currentLayer&&this._currentLayer.disable();this._currentHybrid&&this._currentHybrid.disable();a=this._currentLayer;this._currentLayer=this._layers.ophoto;this._currentHybrid=this._layers.hybrid;a==this._layers.oblique?this._switchToUTM33():(this._currentLayer.enable(),this._hybridMode&&this._currentHybrid.enable());return!0}return this._tryBase()};
SMap.Layer.Smart.prototype._tryBase=function(){if(this._currentLayer==this._layers.base)return!1;this._currentLayer&&this._currentLayer.disable();this._currentHybrid&&this._currentHybrid.disable();var a=this._currentLayer;this._currentLayer=this._layers.base;this._currentHybrid=null;this._layers.base==this._layers.ophoto&&(this._currentHybrid=this._layers.hybrid);a==this._layers.oblique?this._switchToUTM33():(this._currentLayer.enable(),this._currentHybrid&&this._hybridMode&&this._currentHybrid.enable());
return!0};SMap.Layer.Smart.prototype._switchToUTM33=function(){var a=this.getMap();a.setOrientation(SMap.NORTH);a.setProjection(new SMap.Projection.UTM33)};SMap.Layer.Turist=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Turist",VERSION:"1.0",EXTEND:SMap.Layer.Smart});SMap.Layer.Turist.prototype.$constructor=function(a,b){this.$super(a,b,{base:SMap.DEF_TURIST});this._trail=this._bike=!1;this._updateUrl()};SMap.Layer.Turist.prototype.setTrail=function(a){this._trail=a;this._updateUrl();return this};
SMap.Layer.Turist.prototype.setBike=function(a){this._bike=a;this._updateUrl();return this};SMap.Layer.Turist.prototype.getTrail=function(){return this._trail};SMap.Layer.Turist.prototype.getBike=function(){return this._bike};SMap.Layer.Turist.prototype._updateUrl=function(){var a=SMap.CONFIG[SMap.DEF_SMART_TURIST].url,b=["turist"];this._trail&&b.push("trail");this._bike&&b.push("bike");a=a.replace("{}",b.join("_"));this._layers.base.setURL(a)};
SMap.Layer.Marker=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Marker",VERSION:"1.0",EXTEND:SMap.Layer});SMap.Layer.Marker.prototype.$constructor=function(a,b){this._ec=[];this.$super(a);this._eventCoords=this._clusterer=this._repositionOptions=null;this._markers={};this._options={prefetch:100};for(var c in b)this._options[c]=b[c]};
SMap.Layer.Marker.prototype.$destructor=function(){for(var a in this._dom.container)JAK.DOM.clear(this._dom.container[a]);this._dom={};for(var b in this._markers)this._markers[b].marker.setOwner(null),this._markers[b].marker.$destructor();this._markers={};JAK.Events.removeListeners(this._ec);this.$super()};
SMap.Layer.Marker.prototype.setClusterer=function(a){var b=this._clusterer;this._clusterer=a;!a&&b&&(this.clear(),this._markers={},this._addMarker(this._clusterer.getAllMarkers()));if(a)for(var c in this._markers)this._clusterer.addMarker(this._markers[c].marker);this.redraw(!0)};SMap.Layer.Marker.prototype.addMarker=function(a,b){var c=!1;this._clusterer?(this._clusterer.addMarker(a),c=!0):this._addMarker(a);b||this.redraw(c)};
SMap.Layer.Marker.prototype.removeMarker=function(a,b){var c=!1;this._clusterer?(this._clusterer.removeMarker(a),c=!0):this._removeMarker(a);b||this.redraw(c)};SMap.Layer.Marker.prototype.removeAll=function(){if(this._clusterer)this._clusterer.clear(),this.clear(),this._markers={};else{var a=[],b;for(b in this._markers)a.push(this._markers[b].marker);for(;a.length;)this._removeMarker(a.shift())}};
SMap.Layer.Marker.prototype.getMarkers=function(){if(this._clusterer)return this._clusterer.getAllMarkers();var a=[],b;for(b in this._markers)a.push(this._markers[b].marker);return a};
SMap.Layer.Marker.prototype.fillFromData=function(a){var b=[],c={};a instanceof Array||(a=[a]);for(var d=0;d<a.length;d++){var e=a[d];e.nodeType?this._fillFromXML(e,b,c):this._fillFromData(e,b,c)}a=[];if(this._clusterer){for(var f=this._clusterer.getAllMarkers(),d=0;d<f.length;d++)e=f[d],e.getId()in c||a.push(e);this._clusterer.removeMarker(a)}else{for(f in this._markers)f in c||a.push(this._markers[f].marker);this._removeMarker(a)}for(;a.length;)a.pop().$destructor();this.addMarker(b)};
SMap.Layer.Marker.prototype._fillFromXML=function(a,b,c){var d={};if(this._clusterer)for(var e=this._clusterer.getAllMarkers(),f=0;f<e.length;f++){var g=e[f];d[g.getId()]=g}else d=this._markers;a=a.getElementsByTagName("poi");for(e=0;e<a.length;e++)f=a[e],g=f.getAttribute("source")+f.getAttribute("id"),g in d?c[g]=!0:(g=SMap.LOOKUP_MARKER[f.getAttribute("source")]||SMap.Marker,b.push(g.fromXML(f)))};
SMap.Layer.Marker.prototype._fillFromData=function(a,b,c){var d={};if(this._clusterer)for(var e=this._clusterer.getAllMarkers(),f=0;f<e.length;f++){var g=e[f];d[g.getId()]=g}else d=this._markers;a=a.pois||[];for(e=0;e<a.length;e++)f=a[e],f.geom||(g=f.source+f.id,g in d?c[g]=!0:b.push((SMap.LOOKUP_MARKER[f.source]||SMap.Marker).fromData(f)))};SMap.Layer.Marker.prototype.setReposition=function(a){this._repositionOptions=a;this._reposition()};
SMap.Layer.Marker.prototype._reposition=function(){var a=this._repositionOptions;if(a){var b={},c;for(c in this._markers)this._markers[c].appended&&(b[c]=this._markers[c].pos);SMap.Marker.Repositioner.getInstance().go(b,a);for(c in b){a=this._markers[c];a.pos=b[c];var d=a.marker.getContainer(),e;for(e in d)d[e].style.left=a.pos.x+"px",d[e].style.top=a.pos.y+"px"}}};
SMap.Layer.Marker.prototype.redraw=function(a){if(this._active){a&&this._clusterer&&(this.clear(),this._markers={},this._clusterer.compute(),this._addMarker(this._clusterer.getClusters()),this._addMarker(this._clusterer.getMarkers()));var b=this.getMap().getSize(),c=new SMap.Pixel(Math.round(b.x/2),Math.round(b.y/2));this.getMap().getOffset();var b=c.x,c=c.y,d;for(d in this._markers){var e=this._markers[d],f=e.marker.getCoords().toPixel(this.getMap()),g=Math.abs(f.x),f=Math.abs(f.y);(g=!(g>b+this._options.prefetch||
f>c+this._options.prefetch))&&(!e.appended||a)&&this.positionMarker(e.marker);!g&&e.appended?this._unlink(e):g&&!e.appended&&this._append(e)}this._reposition()}};
SMap.Layer.Marker.prototype.positionMarker=function(a){if(this._active){var b=this.getMap();if(b){b=a.getCoords().toPixel(b);b.minus(this.getMap().getOffset());var c=a.getAnchor();if("left"in c){var d="left";b.x-=c.left}else d="right",b.x=-b.x-c.right;if("top"in c){var e="top";b.y-=c.top}else e="bottom",b.y=-b.y-c.bottom;c=this._markers[a.getId()];c.pos=b;c.appended||this._append(c);var a=a.getContainer(),f;for(f in a)a[f].style[d]=b.x+"px",a[f].style[e]=b.y+"px"}}};
SMap.Layer.Marker.prototype.clear=function(){for(var a in this._dom.container)JAK.DOM.clear(this._dom.container[a]);for(var b in this._markers)this._markers[b].appended=!1};SMap.Layer.Marker.prototype._addMarker=function(a){for(var a=a instanceof Array?a:[a],b=0;b<a.length;b++){var c=a[b],d={appended:!1,marker:c,pos:null};this._markers[c.getId()]=d;c.setOwner(this)}};
SMap.Layer.Marker.prototype._removeMarker=function(a){for(var a=a instanceof Array?a:[a],b=0;b<a.length;b++){var c=a[b],d=c.getId();if(!(d in this._markers))break;this._markers[d].appended&&this._unlink(this._markers[d]);c.setOwner(null);delete this._markers[d]}};
SMap.Layer.Marker.prototype._append=function(a){var b=a.marker.getContainer(),c;for(c in b){if(!(c in this._dom.container))throw Error("Cannot append marker component to layer");var d=b[c];d.style.position="absolute";this._dom.container[c].appendChild(d)}a.appended=!0};SMap.Layer.Marker.prototype._unlink=function(a){var b=a.marker.getContainer(),c;for(c in b){var d=b[c];d.parentNode.removeChild(d)}a.appended=!1};
SMap.Layer.Marker.prototype._build=function(){this._dom.container[SMap.LAYER_SHADOW]=JAK.mel("div",{id:this._id+"-"+SMap.LAYER_SHADOW});this._dom.container[SMap.LAYER_MARKER]=JAK.mel("div",{id:this._id+"-"+SMap.LAYER_MARKER});this._dom.container[SMap.LAYER_ACTIVE]=JAK.mel("div",{id:this._id+"-"+SMap.LAYER_ACTIVE});this._ec.push(JAK.Events.addListener(this._dom.container[SMap.LAYER_ACTIVE],"click",this,"_click"));this._ec.push(JAK.Events.addListener(this._dom.container[SMap.LAYER_MARKER],"click",this,
"_click"));this._ec.push(JAK.Events.addListener(this._dom.container[SMap.LAYER_ACTIVE],"mousedown",this,"_mouseDown"));this._ec.push(JAK.Events.addListener(this._dom.container[SMap.LAYER_MARKER],"mousedown",this,"_mouseDown"))};SMap.Layer.Marker.prototype._mouseDown=function(a){this._eventCoords=new SMap.Pixel(a.clientX,a.clientY)};
SMap.Layer.Marker.prototype._click=function(a,b){if(this._eventCoords&&!(1.5<(new SMap.Pixel(a.clientX,a.clientY)).distance(this._eventCoords))){var c=JAK.Events.getTarget(a),d=[],e;for(e in this._dom.container)d.push(this._dom.container[e]);for(var f in this._markers){e=this._markers[f].marker;var g=c,h=e.getActive();do{if(g==h){e.click(a,b);return}g=g.parentNode}while(-1==d.indexOf(g))}}};SMap.Layer.Geometry=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Geometry",VERSION:"1.0",EXTEND:SMap.Layer});
SMap.Layer.Geometry.prototype.$constructor=function(a){this._ec=[];this._canvas=null;this.$super(a);this._eventCoords=null;this._geometries={}};SMap.Layer.Geometry.prototype.$destructor=function(){this.clear();this._geometries={};this._canvas.$destructor();this.$super()};SMap.Layer.Geometry.prototype.addGeometry=function(a){this._addGeometry(a);if(this._active){var b=this.getMap().getSize(),b=new SMap.Pixel(Math.round(b.x/2),Math.round(b.y/2));a.draw(this._canvas,b)}return a};
SMap.Layer.Geometry.prototype.removeGeometry=function(a){if(!(a.getId()in this._geometries))throw Error("Cannot remove geometry "+a.getId());a.clear();a.setOwner(null);delete this._geometries[a.getId()]};SMap.Layer.Geometry.prototype.getGeometries=function(){return this._geometries};SMap.Layer.Geometry.prototype.clear=function(){for(var a in this._geometries)this._geometries[a].clear()};
SMap.Layer.Geometry.prototype.removeAll=function(){var a=[],b;for(b in this._geometries)a.push(this._geometries[b]);for(;a.length;)this.removeGeometry(a.shift())};SMap.Layer.Geometry.prototype.fillFromData=function(a){var b=[];a instanceof Array||(a=[a]);for(var c=0;c<a.length;c++){var d=a[c];d.nodeType?this._fillFromXML(d,b):this._fillFromData(d,b)}b.sort(function(a,b){var c=a.isPoint(),d=b.isPoint();return c==d?0:c?-1:1});for(this.removeAll();b.length;)this._addGeometry(b.pop());this.redraw()};
SMap.Layer.Geometry.prototype._fillFromXML=function(a,b){for(var c=a.getElementsByTagName("geometry"),d=0;d<c.length;d++){var e=c[d],f=SMap.LOOKUP_GEOMETRY[e.getAttribute("source")]||SMap.Geometry.Multi;b.push(f.fromXML(e))}};SMap.Layer.Geometry.prototype._fillFromData=function(a,b){for(var c=a.pois||[],d=0;d<c.length;d++){var e=c[d];e.geom&&b.push((SMap.LOOKUP_GEOMETRY[e.source]||SMap.Geometry.Multi).fromData(e))}};
SMap.Layer.Geometry.prototype.redraw=function(){if(this._active){this.clear();var a=this.getMap().getSize(),a=new SMap.Pixel(Math.round(a.x/2),Math.round(a.y/2)),b;for(b in this._geometries)this._geometries[b].draw(this._canvas,a)}};SMap.Layer.Geometry.prototype.redrawGeometry=function(a){var b=this.getMap().getSize(),b=new SMap.Pixel(Math.round(b.x/2),Math.round(b.y/2));a.clear();a.draw(this._canvas,b)};
SMap.Layer.Geometry.prototype._addGeometry=function(a){var b=a.getId();this._geometries[b]&&this.removeGeometry(this._geometries[b]);this._geometries[a.getId()]=a;a.setOwner(this)};
SMap.Layer.Geometry.prototype._build=function(){this._canvas=JAK.Vector.getCanvas(1,1);var a=this._canvas.group();a.id=this._id+"-"+SMap.LAYER_GEOMETRY;this._ec.push(JAK.Events.addListener(a,"click",this,"_click"));this._ec.push(JAK.Events.addListener(a,"mousedown",this,"_mouseDown"));this._dom.container[SMap.LAYER_GEOMETRY]=a;this._canvas.setContent(a)};SMap.Layer.Geometry.prototype._mouseDown=function(a){this._eventCoords=new SMap.Pixel(a.clientX,a.clientY)};
SMap.Layer.Geometry.prototype._click=function(a,b){if(this._eventCoords&&!(1.5<(new SMap.Pixel(a.clientX,a.clientY)).distance(this._eventCoords))){var c=JAK.Events.getTarget(a),d;for(d in this._geometries)if(-1!=this._geometries[d].getNodes().indexOf(c)){this._geometries[d].click(a,b);break}}};SMap.Layer.Vector=SMap.Layer.Geometry;SMap.Layer.Vector.prototype.addCircle=function(a,b,c){return this._addItem(SMap.GEOMETRY_CIRCLE,[a,b],c)};
SMap.Layer.Vector.prototype.addPath=function(a,b){return this._addItem(SMap.GEOMETRY_PATH,a,b)};SMap.Layer.Vector.prototype.removePolyline=function(a){this.removeGeometry(a)};SMap.Layer.Vector.prototype.removePolygon=function(a){this.removeGeometry(a)};SMap.Layer.Vector.prototype.removeCircle=function(a){this.removeGeometry(a)};SMap.Layer.Vector.prototype.removePath=function(a){this.removeGeometry(a)};
SMap.Layer.Vector.prototype.addPolyline=function(a,b){return this._addItem(SMap.GEOMETRY_POLYLINE,a,b)};SMap.Layer.Vector.prototype.addPolygon=function(a,b){return this._addItem(SMap.GEOMETRY_POLYGON,a,b)};SMap.Layer.Vector.prototype.addVector=function(){return this.addGeometry.apply(this,arguments)};SMap.Layer.Vector.prototype.removeVector=function(){return this.removeGeometry.apply(this,arguments)};
SMap.Layer.Vector.prototype._addItem=function(a,b,c){return this.addGeometry(new SMap.Geometry(a,null,b,c))};SMap.Geometry=JAK.ClassMaker.makeClass({NAME:"SMap.Geometry",VERSION:"1.0",IMPLEMENT:[SMap.IOwned,JAK.IDecorable]});SMap.Geometry.prototype.DEFAULT_OPTIONS={};SMap.Geometry.prototype.DEFAULT_OPTIONS[SMap.GEOMETRY_POLYLINE]={color:"red",opacity:0.65,width:5,outlineColor:"white",outlineWidth:3,outlineOpacity:0.6};SMap.Geometry.prototype.DEFAULT_OPTIONS[SMap.GEOMETRY_PATH]=SMap.Geometry.prototype.DEFAULT_OPTIONS[SMap.GEOMETRY_POLYLINE];
SMap.Geometry.prototype.DEFAULT_OPTIONS[SMap.GEOMETRY_POLYGON]={color:"red",opacity:0.2,outlineColor:"red",outlineWidth:2,outlineOpacity:0.55};SMap.Geometry.prototype.DEFAULT_OPTIONS[SMap.GEOMETRY_CIRCLE]={color:"red",opacity:0.65,width:8,outlineColor:"white",outlineWidth:2,outlineOpacity:0.6};SMap.Geometry.prototype.DEFAULT_OPTIONS[SMap.GEOMETRY_ELLIPSE]=SMap.Geometry.prototype.DEFAULT_OPTIONS[SMap.GEOMETRY_CIRCLE];
SMap.Geometry.prototype.$constructor=function(a,b,c,d){this._owner=null;this._type=a;this._id=b||Math.random();this._coords=c;this._pixels=[];this._options={};for(var e in this.DEFAULT_OPTIONS[a])this._options[e]=this.DEFAULT_OPTIONS[a][e];for(e in d)this._options[e]=d[e];this._instance=null};SMap.Geometry.prototype.$destructor=function(){this.clear();this._coords=[]};SMap.Geometry.prototype.getId=function(){return this._id};SMap.Geometry.prototype.getType=function(){return this._type};
SMap.Geometry.prototype.getCoords=function(){return this._coords};SMap.Geometry.prototype.getPixels=function(){return this._pixels};SMap.Geometry.prototype.getOptions=function(){return this._options};SMap.Geometry.prototype.setOptions=function(a){for(var b in a)this._options[b]=a[b];this._instance&&this._instance.setOptions(this._options)};SMap.Geometry.prototype.getNodes=function(){return this._instance?this._instance.getNodes():[]};
SMap.Geometry.prototype.click=function(a){this.getMap().getSignals().makeEvent("geometry-click",this,{event:a})};SMap.Geometry.prototype.clear=function(){this._instance&&(this._instance.$destructor(),this._instance=null)};
SMap.Geometry.prototype.draw=function(a,b){var c=this._convertCoords(this._coords,b);switch(this._type){case SMap.GEOMETRY_POLYLINE:case SMap.GEOMETRY_POLYGON:var d={};d[SMap.GEOMETRY_POLYLINE]=JAK.Vector.Line;d[SMap.GEOMETRY_POLYGON]=JAK.Vector.Polygon;for(var e=d[this._type],f=[],d=0;d<c.length;d++)f.push(new JAK.Vec2d(c[d].x,c[d].y));this._instance=new e(a,f,this._options);break;case SMap.GEOMETRY_CIRCLE:d=new JAK.Vec2d(c[0].x,c[0].y);e=null;c[1]instanceof SMap.Pixel?(e=c[0].clone().minus(c[1]),
e=Math.sqrt(e.x*e.x+e.y*e.y)):e=c[1];this._instance=new JAK.Vector.Circle(a,d,e,this._options);break;case SMap.GEOMETRY_ELLIPSE:d=new JAK.Vec2d(c[0].x,c[0].y);e=[];for(f=1;3>f;f++)if(c[f]instanceof SMap.Pixel){var g=c[0].clone().minus(c[f]);e.push(Math.sqrt(g.x*g.x+g.y*g.y))}else e.push(c[f]);this._instance=new JAK.Vector.Ellipse(a,d,e,this._options);break;case SMap.GEOMETRY_PATH:e=[];for(d=0;d<c.length;d++)g=c[d],g instanceof SMap.Pixel?(f=Math.round(g.x),g=Math.round(g.y),e.push(f+" "+g)):g instanceof
Array?(g[0].minus(g[1]),e.push(Math.sqrt(g[0].x*g[0].x+g[0].y*g[0].y))):e.push(g);c=e.join(" ");this._instance=new JAK.Vector.Path(a,c,this._options)}};SMap.Geometry.prototype.setCoords=function(a){this._coords=a;this._owner&&this._owner.redrawGeometry(this)};
SMap.Geometry.prototype.computeCenterZoom=function(a,b){for(var c=[],d=0;d<this._coords.length;d++){var e=this._coords[d];e instanceof Array||(e=[e]);for(var f=0;f<e.length;f++){var g=e[f];g instanceof SMap.Coords&&c.push(g)}}return a.computeCenterZoom(c,b)};
SMap.Geometry.prototype._convertCoords=function(a,b){var c=this.getMap();this._pixels=[];for(var d=[],e=null,f=0;f<a.length;f++){var g=a[f];if(g instanceof SMap.Coords){g=g.toPixel(c);if(e&&3>=e.distance(g)&&this._type!=SMap.GEOMETRY_ELLIPSE)continue;e=g.clone();this._pixels.push(e);g.plus(b)}else if(g instanceof Array){for(var e=null,h=[],j=0;j<g.length;j++)h.push(g[j].toPixel(c).plus(b));g=h}d.push(g)}return d};SMap.Vector=SMap.Geometry;SMap.Geometry.Feature=JAK.ClassMaker.makeStatic({NAME:"SMap.Geometry.Feature"});
SMap.Geometry.Feature.Card=JAK.ClassMaker.makeSingleton({NAME:"SMap.Geometry.Feature.Card",VERSION:"1.0",EXTEND:JAK.AbstractDecorator});SMap.Geometry.Feature.Card.prototype.decorate=function(a,b){this.$super(a);a._card=b;a._setCursor=this._setCursor;a.click=this.click;a.draw=this.draw;a._setCursor();return a};SMap.Geometry.Feature.Card.prototype.click=function(a,b){this.$super(a,b);this.getMap().addCard(this._card,SMap.Coords.fromEvent(a,this.getMap()))};
SMap.Geometry.Feature.Card.prototype.draw=function(a,b){this.$super(a,b);this._setCursor()};SMap.Geometry.Feature.Card.prototype._setCursor=function(){for(var a=this.getNodes(),b=0;b<a.length;b++)a[b].style.cursor="pointer"};SMap.Geometry.Multi=JAK.ClassMaker.makeClass({NAME:"SMap.Geometry.Multi",VERSION:"1.0",EXTEND:SMap.Geometry});
SMap.Geometry.Multi.fromXML=function(a){var b=this._optionsFromXML(a),c=new this(a.getAttribute("source")+a.getAttribute("id"),b);c.setSource(a.getAttribute("source"));c.setPlainId(a.getAttribute("id"));for(var a=JAK.XML.childElements(a),d=0;d<a.length;d++){var e=this._geometryFromXML(a[d],b);c.addGeometry(e)}return c};
SMap.Geometry.Multi.fromData=function(a){var b=this._optionsFromData(a),c=new this(a.source+a.id,b);c.setSource(a.source);c.setPlainId(a.id);a=this._geometryFromData(a,b);for(a instanceof Array||(a=[a]);a.length;)c.addGeometry(a.shift());return c};
SMap.Geometry.Multi._optionsFromXML=function(a){var b={},c=a.getAttribute("title");c&&(b.title=c);if(c=a.getAttribute("color"))b.color=c;if(c=a.getAttribute("opacity"))b.opacity=parseFloat(c);if(c=a.getAttribute("width"))b.width=parseFloat(c);if(c=a.getAttribute("style"))b.style=parseInt(c);if(c=a.getAttribute("exactStyle"))b.exactStyle=c;if(c=a.getAttribute("outlineColor"))b.outlineColor=c;if(c=a.getAttribute("outlineOpacity"))b.outlineOpacity=parseFloat(c);if(c=a.getAttribute("outlineWidth"))b.outlineWidth=
parseFloat(c);if(c=a.getAttribute("outlineStyle"))b.outlineStyle=parseInt(c);if(a=a.getAttribute("outlineExactStyle"))b.outlineExactStyle=a;return b};SMap.Geometry.Multi._optionsFromData=function(a){var b=a.geom,a={title:a.title},c;for(c in b.style)a[c]=c.match(/width|opacity/i)?parseFloat(b.style[c]):b.style[c];return a};
SMap.Geometry.Multi._geometryFromXML=function(a,b){switch(a.nodeName.toLowerCase()){case "polygon":var c=this._coordsFromXML(a);return new SMap.Geometry(SMap.GEOMETRY_POLYGON,null,c,b);case "linestring":return c=this._coordsFromXML(a),new SMap.Geometry(SMap.GEOMETRY_POLYLINE,null,c,b);case "circle":return c=a.getElementsByTagName("point")[0],c=SMap.Coords.fromWGS84(c.getAttribute("x"),c.getAttribute("y")),new SMap.Geometry(SMap.GEOMETRY_CIRCLE,null,[c,b.width],b);default:throw Error("Unknown sub-geometry '"+
a.nodeName+"'");}};
SMap.Geometry.Multi._geometryFromData=function(a,b){var c=a.geom;switch(c.type){case "polygon":var d=SMap.Coords.stringToCoords(c.data[0]);return new SMap.Geometry(SMap.GEOMETRY_POLYGON,null,d,b);case "linestring":return d=SMap.Coords.stringToCoords(c.data[0]),new SMap.Geometry(SMap.GEOMETRY_POLYLINE,null,d,b);case "multilinestring":for(var e=[],f=0;f<c.data.length;f++)d=SMap.Coords.stringToCoords(c.data[f]),e.push(new SMap.Geometry(SMap.GEOMETRY_POLYLINE,null,d,b));return e;case "point":return c=SMap.Coords.stringToCoords(c.data[0])[0],
new SMap.Geometry(SMap.GEOMETRY_CIRCLE,null,[c,b.width],b);default:throw Error("Unknown geometry '"+c.type+"'");}};SMap.Geometry.Multi._coordsFromXML=function(a){for(var b=[],a=a.getElementsByTagName("point"),c=0;c<a.length;c++){var d=a[c],d=SMap.Coords.fromWGS84(d.getAttribute("x"),d.getAttribute("y"));b.push(d)}return b};SMap.Geometry.Multi.prototype.$constructor=function(a,b){this.$super(null,a,[],b);this._geometries=[];this._plainId=this._source=null};
SMap.Geometry.Multi.prototype.$destructor=function(){for(;this._geometries.length;)this._geometries.pop().$destructor()};SMap.Geometry.Multi.prototype.addGeometry=function(a){this._geometries.push(a)};SMap.Geometry.Multi.prototype.getGeometries=function(){return this._geometries};SMap.Geometry.Multi.prototype.clear=function(){for(var a=0;a<this._geometries.length;a++)this._geometries[a].clear()};
SMap.Geometry.Multi.prototype.draw=function(a,b){for(var c=0;c<this._geometries.length;c++)this._geometries[c].draw(a,b)};SMap.Geometry.Multi.prototype.setOwner=function(a){this.$super(a);for(var b=0;b<this._geometries.length;b++)this._geometries[b].setOwner(a)};
SMap.Geometry.Multi.prototype.computeCenterZoom=function(a,b){for(var c=[],d=0;d<this._geometries.length;d++)for(var e=this._geometries[d].getCoords(),f=0;f<e.length;f++){var g=e[f];g instanceof Array||(g=[g]);for(var h=0;h<g.length;h++)g[h]instanceof SMap.Coords&&c.push(g[h])}return a.computeCenterZoom(c,b)};SMap.Geometry.Multi.prototype.isArea=function(){for(var a=0;a<this._geometries.length;a++)if(this._geometries[a].getType()==SMap.GEOMETRY_POLYGON)return!0;return!1};
SMap.Geometry.Multi.prototype.isPoint=function(){for(var a=0;a<this._geometries.length;a++)if(this._geometries[a].getType()!=SMap.GEOMETRY_CIRCLE)return!1;return!0};SMap.Geometry.Multi.prototype.setSource=function(a){this._source=a};SMap.Geometry.Multi.prototype.getSource=function(){return this._source};SMap.Geometry.Multi.prototype.setPlainId=function(a){this._plainId=a};SMap.Geometry.Multi.prototype.getPlainId=function(){return this._plainId};
SMap.Geometry.Multi.prototype.getNodes=function(){for(var a=[],b=0;b<this._geometries.length;b++)a=a.concat(this._geometries[b].getNodes());return a};SMap.Geometry.Multi.prototype.click=function(a){this.getMap().getSignals().makeEvent("geometry-multi-click",this,{event:a})};SMap.Marker=JAK.ClassMaker.makeClass({NAME:"SMap.Marker",VERSION:"1.0",IMPLEMENT:[SMap.IOwned,JAK.IDecorable]});SMap.Marker._image=JAK.mel("img");
SMap.Marker.fromXML=function(a){var b={title:a.getAttribute("title")},c=a.getAttribute("url");c&&(b.url=c);c=a.getElementsByTagName("anchor");if(c.length){for(var c=c[0],d={},e=0;e<c.attributes.length;e++){var f=c.attributes[e];d[f.nodeName]=parseInt(f.nodeValue)}b.anchor=d}return new this(SMap.Coords.fromWGS84(parseFloat(a.getAttribute("x")),parseFloat(a.getAttribute("y"))),a.getAttribute("source")+a.getAttribute("id"),b)};
SMap.Marker.fromData=function(a){var b={title:a.title};a.url&&(b.url=a.url);a.anchor&&(b.anchor=a.anchor);return new this(SMap.Coords.fromWGS84(a.mark.lon,a.mark.lat),a.source+a.id,b)};SMap.Marker.prototype.$constructor=function(a,b,c){this._options={title:"",url:SMap.CONFIG.img+"/marker/drop-red.png",anchor:{left:11,top:30}};for(var d in c)this._options[d]=c[d];this._ec={};this._id=b||Math.random();this._owner=!1;this._coords=a;this._dom={container:{},active:null};this._build()};
SMap.Marker.prototype.$destructor=function(){for(var a in this._ec)JAK.Events.removeListener(this._ec[a]);this._ec={}};SMap.Marker.prototype.getCoords=function(){return this._coords};SMap.Marker.prototype.getContainer=function(){return this._dom.container};SMap.Marker.prototype.getAnchor=function(){return this._options.anchor};SMap.Marker.prototype.getTitle=function(){return this._options.title};SMap.Marker.prototype.getId=function(){return this._id};
SMap.Marker.prototype.setURL=function(a){this._dom.container[SMap.LAYER_MARKER].src=a};SMap.Marker.prototype.setCoords=function(a){this._coords=a;this._owner&&this._owner.positionMarker(this)};SMap.Marker.prototype.getActive=function(){return this._dom.active};SMap.Marker.prototype.click=function(a){this.getMap().getSignals().makeEvent("marker-click",this,{event:a})};
SMap.Marker.prototype._build=function(){if("string"==typeof this._options.url){var a=SMap.Marker._image.cloneNode(!1);a.src=this._options.url;a.title=this._options.title;this._dom.container[SMap.LAYER_MARKER]=a}else this._dom.container[SMap.LAYER_MARKER]=this._options.url;this._dom.active=this._dom.container[SMap.LAYER_MARKER]};SMap.Marker.Feature=JAK.ClassMaker.makeStatic({NAME:"SMap.Marker.Feature"});
SMap.Marker.Feature.ImageMap=JAK.ClassMaker.makeSingleton({NAME:"SMap.Marker.Feature.ImageMap",VERSION:"1.0",EXTEND:JAK.AbstractDecorator});SMap.Marker.Feature.ImageMap.prototype.decorate=function(a,b){this.$super(a);for(var c in b);a._over=this._over;a._out=this._out;this._buildMap(a,b);return a};
SMap.Marker.Feature.ImageMap.prototype._buildMap=function(a,b){var c=JAK.mel("div");a._dom.container[SMap.LAYER_ACTIVE]=c;for(var d=b.useMap.split(","),e=[Infinity,Infinity],f=[-Infinity,-Infinity],g=0;g<d.length;g++){var h=g&1,j=d[g];e[h]=Math.min(e[h],j);f[h]=Math.max(f[h],j)}for(g=0;g<d.length;g++)h=g&1,j=d[g],j-=e[h],d[g]=j;g="m"+a.getId();h=JAK.mel("map");"gecko"==JAK.Browser.client||"safari"==JAK.Browser.client||"chrome"==JAK.Browser.client?h.name=g:h.id=g;c.appendChild(h);d=JAK.mel("area",
{href:"#",shape:"poly",coords:d.join(","),title:a._options.title},{cursor:"pointer"});h.appendChild(d);h=JAK.mel("img",{},{position:"absolute",left:e[0]+"px",top:e[1]+"px",border:"none"});h.useMap="#"+g;h.src=b.blank;h.width=f[0]-e[0]+1;h.height=f[1]-e[1]+1;c.appendChild(h);"ie"==JAK.Browser.client&&(a._ec._im_ie_blur=JAK.Events.addListener(d,"click",this,"_blur"),a._ec._im_ie_over=JAK.Events.addListener(d,"mouseover",a,"_over"),a._ec._im_ie_out=JAK.Events.addListener(d,"mouseout",a,"_out"));a._ec._im_click=
JAK.Events.addListener(d,"click",JAK.Events.cancelDef);a._dom.active=d};SMap.Marker.Feature.ImageMap.prototype._blur=function(a,b){b.blur()};SMap.Marker.Feature.ImageMap.prototype._over=function(){this._dom.container[SMap.LAYER_ACTIVE].style.cursor="pointer"};SMap.Marker.Feature.ImageMap.prototype._out=function(){this._dom.container[SMap.LAYER_ACTIVE].style.cursor="move"};SMap.Marker.Feature.RelativeAnchor=JAK.ClassMaker.makeSingleton({NAME:"SMap.Marker.Feature.RelativeAnchor",VERSION:"1.0",EXTEND:JAK.AbstractDecorator});
SMap.Marker.Feature.RelativeAnchor.prototype.decorate=function(a,b){this.$super(a);a._computeRelativeAnchor=this._computeRelativeAnchor;a._loadedRelativeAnchor=this._loadedRelativeAnchor;var c=a._options;c.relativeAnchor=b.anchor;var d=a._dom.container,e=d[SMap.LAYER_MARKER];if(b.size)c.size=b.size,a._computeRelativeAnchor();else if(e.width&&e.height)c.size=new SMap.Pixel(e.width,e.height),a._computeRelativeAnchor();else{for(var f in d)d[f].style.visibility="hidden";a._ec._ra_load=JAK.Events.addListener(e,
"load",a,"_loadedRelativeAnchor")}return a};SMap.Marker.Feature.RelativeAnchor.prototype._computeRelativeAnchor=function(){var a=this._options,b=a.relativeAnchor;"left"in b&&(a.anchor.left=Math.round(a.size.x*b.left));"right"in b&&(a.anchor.right=Math.round(a.size.x*b.right));"top"in b&&(a.anchor.top=Math.round(a.size.y*b.top));"bottom"in b&&(a.anchor.bottom=Math.round(a.size.y*b.bottom))};
SMap.Marker.Feature.RelativeAnchor.prototype._loadedRelativeAnchor=function(a,b){this._options.size=new SMap.Pixel(b.width,b.height);this._computeRelativeAnchor();var c=this._owner;c&&c.positionMarker(this);for(var d in this._dom.container)this._dom.container[d].style.visibility="visible"};SMap.Marker.Feature.Card=JAK.ClassMaker.makeSingleton({NAME:"SMap.Marker.Feature.Card",VERSION:"1.0",EXTEND:JAK.AbstractDecorator});
SMap.Marker.Feature.Card.prototype.decorate=function(a,b){this.$super(a);a._card=b;a.click=this.click;a.getContainer()[SMap.LAYER_MARKER].style.cursor="pointer";return a};SMap.Marker.Feature.Card.prototype.click=function(a,b){this.$super(a,b);this.getMap().addCard(this._card,this._coords)};SMap.Marker.Feature.Draggable=JAK.ClassMaker.makeSingleton({NAME:"SMap.Marker.Feature.Draggable",VERSION:"1.0",EXTEND:JAK.AbstractDecorator});
SMap.Marker.Feature.Draggable.prototype.decorate=function(a){this.$super(a);a._ecDrag=[];a._dragStart=this._dragStart;a._dragMove=this._dragMove;a._dragStop=this._dragStop;a.setDrag=this.setDrag;a._mapMoveChange=this._mapMoveChange;a._dragCoords=[];a._dragState=!0;this._startCenter=this._scMap=null;var b=a.getActive();a._ec._d_down=JAK.Events.addListener(b,"mousedown",a,"_dragStart");return a};SMap.Marker.Feature.Draggable.prototype.setDrag=function(a){this._dragState=a};
SMap.Marker.Feature.Draggable.prototype._mapMoveChange=function(){var a=this.getMap(),b=this._startCenter.toPixel(a),c=this._coords.toPixel(a);c.minus(b);this.setCoords(c.toCoords(a));this._startCenter=this.getMap().getCenter();this.getMap().getSignals().makeEvent("marker-drag-move",this)};
SMap.Marker.Feature.Draggable.prototype._dragStart=function(a){this._dragState&&a.button==JAK.Browser.mouse.left&&(this._scMap=this.getMap().getSignals().addListener(this,"map-redraw","_mapMoveChange"),JAK.Events.getTarget(a).useMap||(this._startCenter=this.getMap().getCenter(),JAK.Events.cancelDef(a),JAK.Events.stopEvent(a),this.getMap().getSignals().makeEvent("marker-drag-start",this,{event:a}),this._ecDrag.push(JAK.Events.addListener(document,"mousemove",this,"_dragMove")),this._ecDrag.push(JAK.Events.addListener(document,
"mouseup",this,"_dragStop")),this._dragCoords=[a.clientX,a.clientY],this._wasDrag=!1))};SMap.Marker.Feature.Draggable.prototype._dragMove=function(a){JAK.Events.cancelDef(a);this._wasDrag=!0;var b=this.getMap(),c=a.clientX-this._dragCoords[0],d=a.clientY-this._dragCoords[1];this._dragCoords=[a.clientX,a.clientY];c=new SMap.Pixel(c,d);this.setCoords(this._coords.toPixel(b).plus(c).toCoords(b));this.getMap().getSignals().makeEvent("marker-drag-move",this,{event:a})};
SMap.Marker.Feature.Draggable.prototype._dragStop=function(a,b){this._ecDrag.forEach(JAK.Events.removeListener,JAK.Events);this._ecDrag=[];this._scMap&&(this.getMap().getSignals().removeListener(this._scMap),this._scMap=null);this._wasDrag?this.getMap().getSignals().makeEvent("marker-drag-stop",this,{event:a}):this.click(a,b)};SMap.Marker.Feature.Shadow=JAK.ClassMaker.makeSingleton({NAME:"SMap.Marker.Feature.Shadow",VERSION:"1.0",EXTEND:JAK.AbstractDecorator});
SMap.Marker.Feature.Shadow.prototype.decorate=function(a,b){this.$super(a);a._dom.container[SMap.LAYER_SHADOW]=JAK.mel("img",{src:b||SMap.CONFIG.img+"/marker/drop-shadow.png"})};SMap.Marker.POI=JAK.ClassMaker.makeClass({NAME:"SMap.Marker.POI",VERSION:"1.0",EXTEND:SMap.Marker});SMap.Marker.POI.fromXML=function(a){var b=SMap.Marker.fromXML.call(this,a);b.setSource(a.getAttribute("source"));b.setPlainId(a.getAttribute("id"));return b};
SMap.Marker.POI.fromData=function(a){var b=SMap.Marker.fromData.call(this,a);b.setSource(a.source);b.setPlainId(a.id);return b};SMap.Marker.POI.prototype.$constructor=function(a,b,c){c=c||{};!c.anchor&&c.url&&(c.anchor={left:9,top:9});this.$super(a,b,c)};SMap.Marker.POI.prototype.setSource=function(a){this._source=a};SMap.Marker.POI.prototype.getSource=function(){return this._source};SMap.Marker.POI.prototype.setPlainId=function(a){this._plainId=a};SMap.Marker.POI.prototype.getPlainId=function(){return this._plainId};
SMap.Marker.POI.prototype.click=function(a,b){SMap.Logger.log("card-poi",{source:this._source,id:this._plainId});this.$super(a,b);this.getMap().getSignals().makeEvent("marker-poi-click",this,{event:a})};SMap.Marker.Repositioner=JAK.ClassMaker.makeSingleton({NAME:"SMap.Marker.Repositioner",VERSION:"1.0"});
SMap.Marker.Repositioner.prototype.$constructor=function(){this._options={itemSize:[18,18],tolerance:0,gridStep:6,gridDistance:3};this._data={};this._todo=[];this._grid=[];this._offset=this._distance=this._itemSize=this._gridSize=null;this._directions=[[1,0],[0,1],[-1,0],[0,-1],[1,0]]};SMap.Marker.Repositioner.prototype.go=function(a,b){for(var c in b)this._options[c]=b[c];this._data=a;this._todo=[];this._createGrid();this._initialPlacement();this._mainLoop();this._finish()};
SMap.Marker.Repositioner.prototype._createGrid=function(){var a=this._options;this._itemSize=[Math.round(a.itemSize[0]/a.gridStep),Math.round(a.itemSize[1]/a.gridStep)];this._distance=[this._itemSize[0]*a.gridDistance,this._itemSize[1]*a.gridDistance];var b=new SMap.Pixel(Infinity,Infinity),c=new SMap.Pixel(-Infinity,-Infinity),d;for(d in this._data){var e=this._data[d];b.x=Math.min(b.x,e.x);b.y=Math.min(b.y,e.y);c.x=Math.max(c.x,e.x);c.y=Math.max(c.y,e.y)}b.x=Math.floor(b.x/a.gridStep)*a.gridStep;
b.y=Math.floor(b.y/a.gridStep)*a.gridStep;this._offset=b;for(d in this._data)this._data[d].x-=b.x,this._data[d].y-=b.y,this._todo.push(d);d=c.y-b.y+a.itemSize[1];b=Math.round((c.x-b.x+a.itemSize[0])/a.gridStep)+2*this._distance[0];a=Math.round(d/a.gridStep)+2*this._distance[1];this._gridSize=new SMap.Pixel(b,a);this._grid=[];for(a=0;a<this._gridSize.x;a++){this._grid.push([]);for(b=0;b<this._gridSize.y;b++)this._grid[a].push(0)}};
SMap.Marker.Repositioner.prototype._addItem=function(a){for(var b=0,c=0;c<this._itemSize[0];c++)for(var d=0;d<this._itemSize[1];d++)b+=this._grid[a.x+c][a.y+d],this._grid[a.x+c][a.y+d]++;return b};SMap.Marker.Repositioner.prototype._removeItem=function(a){for(var b=0;b<this._itemSize[0];b++)for(var c=0;c<this._itemSize[1];c++)this._grid[a.x+b][a.y+c]--};
SMap.Marker.Repositioner.prototype._initialPlacement=function(){for(var a=this._options,b=this._itemSize,c=a.gridStep,d=0;d<this._todo.length;d++){var e=this._data[this._todo[d]];e.x=Math.round(e.x/c)+this._distance[0];e.y=Math.round(e.y/c)+this._distance[1];for(var f=0,g=!0,h=0;h<b[0];h++)for(var j=0;j<b[1];j++)this._grid[e.x+h][e.y+j]&&f++,f>a.tolerance&&(h=b[0],j=b[1],g=!1);g&&(this._addItem(e),this._todo.splice(d,1),d--)}};
SMap.Marker.Repositioner.prototype._advanceItem=function(a,b,c){var d=0,e=0,f=0,g=0,h=null;0==b[1]?(h=this._itemSize[1],f=d=a.x,1==b[0]?f+=this._itemSize[0]:(d+=this._itemSize[0]-1,f--)):(h=this._itemSize[0],g=e=a.y,1==b[1]?g+=this._itemSize[1]:(e+=this._itemSize[1]-1,g--));for(var j=0;j<h;j++)0==b[1]?(e=a.y+j,g=a.y+j):(d=a.x+j,f=a.x+j),this._grid[d][e]--,this._grid[d][e]&&c--,this._grid[f][g]&&c++,this._grid[f][g]++;a.x+=b[0];a.y+=b[1];return c};
SMap.Marker.Repositioner.prototype._rotateItem=function(a,b){a.y--;for(var c=a.x,d=a.y,e=0,f=b,g=this._addItem(a);g>this._options.tolerance;){var h=this._directions[e];f--;f||(e++,f=2*b);g=this._advanceItem(a,h,g);if(c==a.x&&d==a.y)return this._removeItem(a),!1}return!0};
SMap.Marker.Repositioner.prototype._mainLoop=function(){for(var a=0,b=Math.min(this._distance[0],this._distance[1]);this._todo.length&&a<b;){a++;for(var c=0;c<this._todo.length;c++)this._rotateItem(this._data[this._todo[c]],a)&&(this._todo.splice(c,1),c--)}};
SMap.Marker.Repositioner.prototype._finish=function(){var a=this._options.gridStep,b;for(b in this._data){var c=this._data[b];c.x=(c.x-this._distance[0])*a+this._offset.x;c.y=(c.y-this._distance[1])*a+this._offset.y}this._grid=[];this._todo=[];this._data={}};SMap.Marker.Cluster=JAK.ClassMaker.makeClass({NAME:"SMap.Marker.Cluster",VERSION:"1.0",EXTEND:SMap.Marker});
SMap.Marker.Cluster.prototype.$constructor=function(a,b){var c={url:JAK.mel("div",{className:"cluster"}),anchor:{left:0,top:0}};this.$super(null,a,c);this._clusterOptions={color:"#3d66cf",radius:function(a,b,c){return 25+10*(a-b+1)/(c-b+1)}};for(var d in b)this._clusterOptions[d]=b[d];this._dom.content=JAK.mel("span");this._dom.circle=JAK.mel("div",{},{color:this._clusterOptions.color});this._dom.container[SMap.LAYER_MARKER].appendChild(this._dom.circle);this._dom.circle.appendChild(this._dom.content);
this._dom.circle.appendChild(JAK.mel("img",{src:SMap.CONFIG.img+"/marker/cluster.png"},{backgroundColor:this._clusterOptions.color}));this._markers=[];this._markerCoords=[]};SMap.Marker.Cluster.prototype.addMarker=function(a){this._markers.push(a);this._markerCoords.push(a.getCoords());this._update();return this};SMap.Marker.Cluster.prototype.getMarkers=function(){return this._markers};
SMap.Marker.Cluster.prototype.click=function(a,b){this.$super(a,b);var c=this.getMap(),d=c.computeCenterZoom(this._markerCoords);c.setCenterZoom(d[0],d[1])};SMap.Marker.Cluster.prototype.setSize=function(a,b){var c=Math.round(this._clusterOptions.radius(this._markers.length,a,b));this._dom.circle.style.width=2*c+"px";this._dom.circle.style.height=2*c+"px";this._dom.circle.style.left=-c+"px";this._dom.circle.style.top=-c+"px";this._dom.content.style.lineHeight=2*c+"px";return this};
SMap.Marker.Cluster.prototype._update=function(){var a=Infinity,b=Infinity,c=-Infinity,d=-Infinity,e=this._markers.length;this._dom.content.innerHTML=e;this._dom.circle.title=e;for(var f=0;f<e;f++)var g=this._markerCoords[f],a=Math.min(a,g.x),b=Math.min(b,g.y),c=Math.max(c,g.x),d=Math.max(d,g.y);this.setCoords(new SMap.Coords((a+c)/2,(b+d)/2))};SMap.Marker.Clusterer=JAK.ClassMaker.makeClass({NAME:"SMap.Marker.Clusterer",VERSION:"1.0"});
SMap.Marker.Clusterer.prototype.$constructor=function(a,b){this._maxDistance=b||100;this._markers=[];this._clusters=[];this._positions=[];this._map=a};SMap.Marker.Clusterer.prototype.clear=function(){this._markers=[];this._clusters=[];this._positions=[]};SMap.Marker.Clusterer.prototype.addMarker=function(a){a instanceof Array?this._markers=this._markers.concat(a):this._markers.push(a)};
SMap.Marker.Clusterer.prototype.removeMarker=function(a){if(a instanceof Array)for(var b=0;b<a.length;b++)this.removeMarker(a[b]);else a=this._markers.indexOf(a),-1!=a&&this._markers.splice(a,1)};SMap.Marker.Clusterer.prototype.getAllMarkers=function(){return this._markers};SMap.Marker.Clusterer.prototype.getMarkers=function(){for(var a=[],b=0;b<this._clusters.length;b++){var c=this._clusters[b];1==c.getMarkers().length&&a.push(c.getMarkers()[0])}return a};
SMap.Marker.Clusterer.prototype.getClusters=function(){for(var a=[],b=0;b<this._clusters.length;b++){var c=this._clusters[b];1<c.getMarkers().length&&a.push(c)}return a};
SMap.Marker.Clusterer.prototype.compute=function(){this._clusters=[];this._positions=[];for(var a=0;a<this._markers.length;a++)this._process(this._markers[a]);for(var b=Infinity,c=-Infinity,a=0;a<this._clusters.length;a++)var d=this._clusters[a].getMarkers().length,b=Math.min(b,d),c=Math.max(c,d);for(a=0;a<this._clusters.length;a++)this._clusters[a].setSize(b,c)};
SMap.Marker.Clusterer.prototype._process=function(a){for(var b=Infinity,c=a.getCoords().toPixel(this._map),d=-1,e=0;e<this._positions.length;e++){var f=c.distance(this._positions[e]);f<b&&(b=f,d=e)}-1==d||b>this._maxDistance?(d=this._clusters.length,b=new SMap.Marker.Cluster,this._clusters.push(b)):b=this._clusters[d];b.addMarker(a);this._positions[d]=b.getCoords().toPixel(this._map)};
SMap.Card=JAK.ClassMaker.makeClass({NAME:"SMap.Card",VERSION:"1.0",IMPLEMENT:[SMap.IOwned],DEPEND:[{sClass:JAK.Window,ver:"2.0"}]});SMap.Card.prototype.MIN_HEIGHT=368;
SMap.Card.prototype.$constructor=function(a){this._ec=[];this._sc=[];this._anchor=!1;this._owner=null;this._size=[null,null];this._minHeight=null;this._tailPointer=[17,2];this._dom={container:null,content:null,close:null,tail:null,header:JAK.mel("div",{className:"card-header"}),body:JAK.mel("div",{className:"card-body"}),footer:JAK.mel("div",{className:"card-footer"})};this._build();this._addEvents();this.setSize(a||311)};
SMap.Card.prototype.$destructor=function(){this._ec.forEach(JAK.Events.removeListener,JAK.Events);this._ec=[];var a=this.getMap().getSignals();this._sc.forEach(function(b){a.removeListener(b)});this._sc=[]};SMap.Card.prototype.setOwner=function(a){this._owner=a;this.sync()};SMap.Card.prototype.getHeader=function(){return this._dom.header};SMap.Card.prototype.getBody=function(){return this._dom.body};SMap.Card.prototype.getFooter=function(){return this._dom.footer};
SMap.Card.prototype.setSize=function(a,b){this._size=[a||this._size[0],b||null];this._dom.content.style.width=this._size[0]+"px";this.sync()};SMap.Card.prototype.getContainer=function(){return this._dom.container};SMap.Card.prototype.getAnchor=function(){return this._anchor};SMap.Card.prototype.anchorTo=function(a){this._anchor=a;a=this._computePosition(a);this._dom.container.style.left=a.x+"px";this._dom.container.style.bottom=-a.y+"px"};
SMap.Card.prototype.isVisible=function(){var a=this._getOffset(),b=this.getMap().getSize(),c=this._getOuterSize(),d=Math.max(0,a.x),e=Math.max(0,a.y),f=Math.min(b.x,a.x+c.x),a=Math.min(b.y,a.y+c.y);return f>d&&a>e};SMap.Card.prototype.makeVisible=function(){var a=this.getMap(),b=this._visibilityDistance();if(!b.x&&!b.y)return!0;var c=Math.sqrt(b.x*b.x+b.y+b.y),d=a.getSize(),d=Math.sqrt(d.x*d.x+d.y*d.y);c<=0.5*d?a.animate(b):a.setCenter(b);return!1};
SMap.Card.prototype._visibilityDistance=function(){var a=this.getMap(),b=this._getOffset(),c=a.getSize(),d=new SMap.Pixel(a.getPadding("left"),a.getPadding("top")),e=new SMap.Pixel(c.x-a.getPadding("right"),c.y-a.getPadding("bottom")),f=this._getOuterSize(),a=b.x-d.x,d=b.y-d.y,c=e.x-(b.x+f.x),b=e.y-(b.y+f.y),f=e=0;0>a&&(e=-a);0>c&&(e=c);0>d&&(f=-d);0>b&&(f=b);return new SMap.Pixel(e,f)};
SMap.Card.prototype.sync=function(){if(this._owner){var a=this.getMap();this._dom.body.style.display="none";var b=this._getOuterSize().y;this._dom.body.style.display="";if(this._size[1])a=this._size[1]-b,0>a&&(a=0),this._dom.body.style.height=a+"px";else{var c=a.getSize().y,c=c-a.getPadding("top"),c=c-a.getPadding("bottom"),c=Math.min(c,this.MIN_HEIGHT);this._dom.body.style.height="";a=this._dom.body.scrollHeight;b+=a;b>c&&(a-=b-c,0>a&&(a=0),this._dom.body.style.height=a+"px")}}};
SMap.Card.prototype._getOuterSize=function(){var a=this._dom.tail;return new SMap.Pixel(this._dom.container.offsetWidth,a.offsetTop+a.offsetHeight)};SMap.Card.prototype._computePosition=function(a){var b=this.getMap(),a=a.toPixel(b).minus(b.getOffset()),b=this._dom.tail;a.x-=b.offsetLeft+this._tailPointer[0];a.y+=this._dom.container.offsetHeight-b.offsetTop-b.offsetHeight+this._tailPointer[1];return a};
SMap.Card.prototype._getOffset=function(){for(var a=this._dom.container,b=this.getMap().getContainer(),c=new SMap.Pixel(0,0);a!=b;)c.x+=a.offsetLeft,c.y+=a.offsetTop,a=a.offsetParent;a=b.clientLeft||0;b=b.clientTop||0;"opera"==JAK.Browser.client&&(a=-a,b=-b);c.x+=a;c.y+=b;return c};SMap.Card.prototype._closeClick=function(){var a=this.getMap();a.removeCard();a.getSignals().makeEvent("card-close-click",this)};
SMap.Card.prototype._addEvents=function(){this._ec.push(JAK.Events.addListener(this._dom.container,"DOMMouseScroll",JAK.Events.stopEvent));this._ec.push(JAK.Events.addListener(this._dom.container,"mousewheel",JAK.Events.stopEvent));this._ec.push(JAK.Events.addListener(this._dom.container,"mousedown",JAK.Events.stopEvent));this._ec.push(JAK.Events.addListener(this._dom.container,"dblclick",JAK.Events.stopEvent));this._ec.push(JAK.Events.addListener(this._dom.container,"contextmenu",JAK.Events.stopEvent))};
SMap.Card.prototype._build=function(){var a=new JAK.Window({imagePath:SMap.CONFIG.img+"/card/card-",imageFormat:"png",sizes:[16,16,16,16]}),b=a.container;this._dom.container=b;b.style.position="absolute";b.style.zIndex="";JAK.DOM.addClass(b,"card");b=a.content;b.parentNode.style.backgroundColor="white";b.style.overflow="hidden";this._dom.content=b;this._dom.content.appendChild(this._dom.header);this._dom.content.appendChild(this._dom.body);this._dom.content.appendChild(this._dom.footer);this._dom.close=
JAK.mel("div",{className:"close"});this._ec.push(JAK.Events.addListener(this._dom.close,"click",this,"_closeClick"));this._dom.container.appendChild(this._dom.close);this._dom.tail=JAK.mel("div",{className:"tail"});this._dom.container.appendChild(this._dom.tail)};SMap.Control=JAK.ClassMaker.makeClass({NAME:"SMap.Control",VERSION:"1.0",IMPLEMENT:SMap.IOwned});SMap.Control.prototype.$constructor=function(){this._ec=[];this._sc=[];this._owner=null};
SMap.Control.prototype.$destructor=function(){JAK.Events.removeListeners(this._ec);this.getMap().getSignals().removeListeners(this._sc)};SMap.Control.prototype.getContainer=function(){return!1};SMap.Control.prototype.setOwner=function(a){this._owner=a};SMap.Control.Keyboard=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Keyboard",VERSION:"1.0",EXTEND:SMap.Control});
SMap.Control.Keyboard.prototype.$constructor=function(a,b){this.$super();this.options={panAmount:10,moveThreshold:300};for(var c in b)this.options[c]=b[c];this.keyMap={37:new SMap.Pixel(this.options.panAmount,0),38:new SMap.Pixel(0,this.options.panAmount),39:new SMap.Pixel(-this.options.panAmount,0),40:new SMap.Pixel(0,-this.options.panAmount)};this.usedKeys={};for(var d in this.keyMap)this.usedKeys[d]=!1;this._mode=a;this._moving=!1;this.step=new SMap.Pixel(0,0);this._step=this._step.bind(this)};
SMap.Control.Keyboard.prototype.setOwner=function(a){this.$super(a);this._ec.push(JAK.Events.addListener(document,"keydown",this,"_down"));this._ec.push(JAK.Events.addListener(document,"keyup",this,"_up"));this._ec.push(JAK.Events.addListener(document,"keypress",this,"_press"))};SMap.Control.Keyboard.prototype.configure=function(a){this._mode=a};SMap.Control.Keyboard.prototype.getMode=function(){return this._mode};SMap.Control.Keyboard.prototype._step=function(){this.getMap().setCenter(this.step)};
SMap.Control.Keyboard.prototype._press=function(a){this._moving&&JAK.Events.cancelDef(a)};SMap.Control.Keyboard.prototype._up=function(a){if(this._moving&&(a=a.keyCode,a in this.keyMap&&(this.step.minus(this.keyMap[a]),this.usedKeys[a]=!1),!this.step.x&&!this.step.y))JAK.Timekeeper.getInstance().removeListener(this),this._moving=!1,this.getMap().unlock()};
SMap.Control.Keyboard.prototype._down=function(a){if(-1==["input","select","option","textarea"].indexOf(JAK.Events.getTarget(a).tagName.toLowerCase())){var b=a.keyCode;b in this.keyMap&&!this.usedKeys[b]&&this._mode&SMap.KB_PAN?(this.step.plus(this.keyMap[b]),this.usedKeys[b]=!0):109==b?this._mode&SMap.KB_ZOOM&&this.getMap().setZoom("-1",null,!0):107==b&&this._mode&SMap.KB_ZOOM&&this.getMap().setZoom("+1",null,!0);if((this.step.x||this.step.y)&&!this._moving)JAK.Events.cancelDef(a),this.getMap().lock(),
this._moving=!0,this._step(),JAK.Timekeeper.getInstance().addListener(this,"_step")}};SMap.Control.Sync=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Sync",VERSION:"1.0",EXTEND:SMap.Control});SMap.Control.Sync.prototype.$constructor=function(a){this.$super();this._options={bottomSpace:null,resizeTimeout:100};for(var b in a)this._options[b]=a[b];this._timeoutDone=this._timeoutDone.bind(this)};
SMap.Control.Sync.prototype.setOwner=function(a){this.$super(a);this._ec.push(JAK.Events.addListener(window,"resize",this,"_resize"));this._timeout=null;this._sync()};
SMap.Control.Sync.prototype._sync=function(){var a=this.getMap(),b=a.getContainer(),c=a.getSize();if(null!==this._options.bottomSpace){var d=JAK.DOM.getBoxPosition(b),d=JAK.DOM.getDocSize().height-d.top-this._options.bottomSpace;b.style.height=Math.round(d)+"px"}if(c.x!=b.offsetWidth||c.y!=b.offsetHeight)a.syncPort(),a.getSignals().makeEvent("map-resize",this)};SMap.Control.Sync.prototype._resize=function(){this._timeout&&clearTimeout(this._timeout);this._timeout=setTimeout(this._timeoutDone,this._options.resizeTimeout)};
SMap.Control.Sync.prototype._timeoutDone=function(){this._timeout=null;this._sync()};SMap.Control.Visible=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Visible",VERSION:"1.0",EXTEND:SMap.Control});SMap.Control.Visible.prototype.$constructor=function(){this.$super();this._dom={}};SMap.Control.Visible.prototype.getContainer=function(){return this._dom.container};SMap.Control.Visible.prototype._build=function(){this._dom.container=JAK.mel("div")};
SMap.Control.Image=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Image",VERSION:"1.0",EXTEND:SMap.Control.Visible});SMap.Control.Image.prototype.$constructor=function(a,b){this.$super();this._url=a;this._href=b;this._targetHref="";this._dom.container=JAK.mel("img");b&&(this._dom.container.style.cursor="pointer",this._ec.push(JAK.Events.addListener(this._dom.container,"click",this,"_click")))};
SMap.Control.Image.prototype.setOwner=function(a){this.$super(a);this._sc.push(this.getMap().getSignals().addListener(this,"map-redraw","_redraw"));this._redraw()};SMap.Control.Image.prototype._redraw=function(){this._dom.container.src=this._buildURL()};SMap.Control.Image.prototype._buildURL=function(){this._href&&(this._targetHref=this.getMap().formatString(this._href));return this.getMap().formatString(this._url)};SMap.Control.Image.prototype._click=function(){window.open(this._targetHref)};
SMap.Control.Compass=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Compass",VERSION:"1.0",EXTEND:SMap.Control.Visible});
SMap.Control.Compass.prototype.$constructor=function(a){this.$super();this._options={panAmount:1,title:"",moveThreshold:300};for(var b in a)this._options[b]=a[b];this._classNames={};this._classNames[SMap.NORTH]="north";this._classNames[SMap.EAST]="east";this._classNames[SMap.SOUTH]="south";this._classNames[SMap.WEST]="west";this._ec2=[];this._moving=!1;this._totalMoved=null;this._step=this._step.bind(this);this._build()};
SMap.Control.Compass.prototype.setOwner=function(a){this.$super(a);this._sc.push(this.getMap().getSignals().addListener(this,"map-redraw","_redraw"));this._redraw()};SMap.Control.Compass.prototype._redraw=function(){var a=this._classNames[this.getMap().getOrientation()],a="north";JAK.DOM.removeClass(this._dom.container,"compass-"+a);JAK.DOM.addClass(this._dom.container,"compass-"+a)};
SMap.Control.Compass.prototype._build=function(){this._dom.container=JAK.mel("div",{className:"compass"});this._dom.container.title=this._options.title;this._ec.push(JAK.Events.addListener(this._dom.container,"mousedown",this,"_start"))};
SMap.Control.Compass.prototype._start=function(a,b){this._set(a,b)&&(this._totalMoved=new SMap.Pixel(0,0),this._ec2.push(JAK.Events.addListener(this._dom.container,"mousemove",this,"_set")),this._ec2.push(JAK.Events.addListener(this._dom.container,"mouseout",this,"_end")),this._ec2.push(JAK.Events.addListener(this._dom.container,"mouseup",this,"_end")),this._moving=!0,this.getMap().lock(),this._step(),JAK.Timekeeper.getInstance().addListener(this,"_step",2),this.__ts=(new Date).getTime())};
SMap.Control.Compass.prototype._step=function(){this._totalMoved.plus(this.step);var a=this.getMap().getSize();Math.sqrt(a.x*a.x+a.y*a.y);this._totalMoved.norm()>this._options.moveThreshold&&(this._totalMoved.x=0,this._totalMoved.y=0,this.getMap().redraw());this.getMap().setCenter(this.step)};
SMap.Control.Compass.prototype._set=function(a){JAK.Events.cancelDef(a);var b=this._dom.container,c=JAK.DOM.getBoxPosition(b),d=JAK.DOM.getScrollPos();c.left-=d.x;c.top-=d.y;b=b.offsetWidth/2;d=b-(a.clientX-c.left);a=b-(a.clientY-c.top);if(d*d+a*a>b*b)return this._moving&&this._end(),!1;this.step=new SMap.Pixel(Math.round(d*this._options.panAmount),Math.round(a*this._options.panAmount));return!0};
SMap.Control.Compass.prototype._end=function(){JAK.Timekeeper.getInstance().removeListener(this);this._moving=!1;this._ec2.forEach(JAK.Events.removeListener,JAK.Events);this._ec2=[];this.getMap().unlock();var a=(new Date).getTime()-this.__ts;SMap.Logger.log("cross",{time:a})};SMap.Control.Selection=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Selection",VERSION:"1.0",EXTEND:SMap.Control.Visible});
SMap.Control.Selection.prototype.$constructor=function(a){this.$super();this._ecTmp=[];this._thickness=a||0;this._build();this._lock=!1;this._point2=this._point1=null;this._height=this._width=0};SMap.Control.Selection.prototype.setOwner=function(a){this.$super(a);a=a.getContainer();this._ec.push(JAK.Events.addListener(a,"mousedown",this,"_mousedown"));this._ec.push(JAK.Events.addListener(document,"keydown",this,"_keyDown"));this._ec.push(JAK.Events.addListener(document,"keyup",this,"_keyUp"))};
SMap.Control.Selection.prototype._keyDown=function(a){!this._lock&&(17==a.keyCode&&this._owner)&&(this._lock=!0,this.getMap().setCursor("pointer"))};SMap.Control.Selection.prototype._keyUp=function(a){this._lock&&(17==a.keyCode&&this._owner)&&(this._lock=!1,this.getMap().setCursor(null))};SMap.Control.Selection.prototype._build=function(){this._dom.container=JAK.mel("div",{className:"selection"},{borderWidth:this._thickness+"px"});this._hide()};
SMap.Control.Selection.prototype._hide=function(){this._dom.container.style.visibility="hidden"};SMap.Control.Selection.prototype._show=function(){this._dom.container.style.visibility="visible"};
SMap.Control.Selection.prototype._mousedown=function(a){if(a.button==JAK.Browser.mouse.left&&(a.ctrlKey||a.metaKey)){var b=this.getMap().getSize();this._width=Math.round(b.x/2);this._height=Math.round(b.y/2);this._point2=this._point1=SMap.Pixel.fromEvent(a,this.getMap());this._redraw();this._ecTmp.push(JAK.Events.addListener(document,"mouseup",this,"_mouseup"));this._ecTmp.push(JAK.Events.addListener(document,"mousemove",this,"_mousemove"));this._ecTmp.push(JAK.Events.addListener(document,"keydown",
this,"_keydown"))}};SMap.Control.Selection.prototype._mouseup=function(){this._stop(!0)};SMap.Control.Selection.prototype._mousemove=function(a){a=SMap.Pixel.fromEvent(a,this.getMap());if(this._point1==this._point2){if(3>this._point1.distance(a))return;this._show()}this._point2=a;this._redraw()};SMap.Control.Selection.prototype._keydown=function(a){27==a.keyCode&&this._stop(!1)};
SMap.Control.Selection.prototype._stop=function(a){this._ecTmp.forEach(JAK.Events.removeListener,JAK.Events);this._ecTmp=[];this._hide();if(a&&this._point1!=this._point2){var a=[this._point1.toCoords(this.getMap()),this._point2.toCoords(this.getMap())],b=this.getMap().computeCenterZoom(a),a=b[0],b=b[1];SMap.Logger.log("ctrl-zoom");this.getMap().setCenterZoom(a,b)}};
SMap.Control.Selection.prototype._redraw=function(){var a=Math.abs(this._point1.x-this._point2.x),b=Math.abs(this._point1.y-this._point2.y);this._dom.container.style.width=a+"px";this._dom.container.style.height=b+"px";a=Math.min(this._point1.x,this._point2.x);b=Math.min(this._point1.y,this._point2.y);a+=this._width;b+=this._height;a-=this._thickness;b-=this._thickness;this._dom.container.style.left=a+"px";this._dom.container.style.top=b+"px"};
SMap.Control.ZoomNotification=JAK.ClassMaker.makeClass({NAME:"SMap.Control.ZoomNotification",VERSION:"1.0",EXTEND:SMap.Control.Visible});SMap.Control.ZoomNotification.prototype.$constructor=function(){this.$super();this._fixedPoint=this._zoom=null;this._size=new SMap.Pixel(0,0);this._build()};
SMap.Control.ZoomNotification.prototype.setOwner=function(a){this.$super(a);a=this.getMap().getSignals();this._sc.push(a.addListener(this,"zoom-start","_zoomStart"));this._sc.push(a.addListener(this,"zoom-step","_zoomStep"));this._sc.push(a.addListener(this,"zoom-stop","_zoomStop"))};
SMap.Control.ZoomNotification.prototype._build=function(){this._dom.container=JAK.mel("div",{className:"notification"},{display:"none"});for(var a=["top","bottom"],b=["left","right"],c=0;c<a.length;c++)for(var d=0;d<b.length;d++){var e=JAK.mel("div",{className:a[c]+"-"+b[d]},{position:"absolute"});e.style[a[c]]="0px";e.style[b[d]]="0px";this._dom.container.appendChild(e)}};
SMap.Control.ZoomNotification.prototype._zoomStart=function(a){this._zoom=this.getMap().getZoom();var b=this.getMap().getSize();this._fixedPoint=a.data.fixedPoint.toPixel(this.getMap());this._fixedPoint.x+=b.x/2;this._fixedPoint.y+=b.y/2;this._dom.container.style.display="";this._dom.container.style.width="";a=this._dom.container.offsetWidth;b=a*b.y/b.x;this._size.x=a;this._size.y=b;this._updatePositionSize(a,b)};
SMap.Control.ZoomNotification.prototype._zoomStep=function(a){a=Math.pow(2,a.data.currentZoom-this._zoom);this._updatePositionSize(this._size.x*a,this._size.y*a)};SMap.Control.ZoomNotification.prototype._zoomStop=function(){this._dom.container.style.display="none"};
SMap.Control.ZoomNotification.prototype._updatePositionSize=function(a,b){var c=this._dom.container.style;c.width=Math.round(a)+"px";c.height=Math.round(b)+"px";c.left=Math.round(this._fixedPoint.x-a/2)+"px";c.top=Math.round(this._fixedPoint.y-b/2)+"px"};SMap.Control.Mouse=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Mouse",VERSION:"1.0",EXTEND:SMap.Control});
SMap.Control.Mouse.prototype.$constructor=function(a,b){this.$super();this._ecMove=[];this._ecGesture=[];this.options={scrollDelay:100,idleDelay:400,minDriftSpeed:30,maxDriftSpeed:80,driftSlowdown:0.95,driftThreshold:300};this._mode=a;this._gesture={scale:1,coords:null};this._drift={speed:0,direction:0,moved:0};this._context={timeout:null,event:null};this._lastEvents=[];this._lastTimestamp=null;this._moved=this._idleTimeout=this._scrollTimeout=!1;this._speed=[];this._gestureScale=0;for(var c in b)this.options[c]=
b[c];this._scrollUnlock=this._scrollUnlock.bind(this);this._idle=this._idle.bind(this);this._driftStep=this._driftStep.bind(this);this._contextMenu=this._contextMenu.bind(this)};SMap.Control.Mouse.prototype.setOwner=function(a){this.$super(a);this.configure(this._mode)};SMap.Control.Mouse.prototype.getMode=function(){return this._mode};
SMap.Control.Mouse.prototype.configure=function(a){JAK.Events.removeListeners(this._ec);this._mode=a;a=this._owner.getContent();this._ec.push(JAK.Events.addListener(a,"touchstart",this,"_touchStart"));this._mode&SMap.MOUSE_PAN&&this._ec.push(JAK.Events.addListener(a,"mousedown",this,"_mouseDown"));this._mode&SMap.MOUSE_WHEEL&&("gecko"==JAK.Browser.client?(this._ec.push(JAK.Events.addListener(a,"DOMMouseScroll",this,"_scroll")),this._ec.push(JAK.Events.addListener(document,"mousemove",this,"_recordPosition")),
this.getMap().getSize(),this._clientY=this._clientX=null):this._ec.push(JAK.Events.addListener(a,"mousewheel",this,"_scroll")));this._mode&SMap.MOUSE_ZOOM_IN&&this._ec.push(JAK.Events.addListener(a,"dblclick",this,"_dblClick"));this._mode&SMap.MOUSE_ZOOM_OUT&&this._ec.push(JAK.Events.addListener(a,"mouseup",this,"_rightClick"));this._mode&SMap.MOUSE_ZOOM&&this._ec.push(JAK.Events.addListener(a,"gesturestart",this,"_gestureStart"))};
SMap.Control.Mouse.prototype._mouseDown=function(a){if(a.button==JAK.Browser.mouse.left){var b=JAK.Events.getTarget(a);if(!this._isInActive(b)||b.useMap){if(a.ctrlKey||a.metaKey)for(var b=this.getMap().getControls(),c=0;c<b.length;c++)if(b[c]instanceof SMap.Control.Selection)return;this._ecMove.push(JAK.Events.addListener(document,"mousemove",this,"_mouseMove"));this._ecMove.push(JAK.Events.addListener(document,"mouseup",this,"_mouseUp"));this._ecMove.push(JAK.Events.addListener(document,"mouseout",
this,"_break"));this._commonStart(a.clientX,a.clientY)}}};
SMap.Control.Mouse.prototype._touchStart=function(a){for(var b=this.getMap(),c=[],d=0;d<a.touches.length;d++)c.push(SMap.Coords.fromEvent(a.touches[d],b));this._gesture.coords=b.computeCenterZoom(c)[0];if(this._mode&SMap.MOUSE_PAN&&(b=JAK.Events.getTarget(a),!this._isInActive(b)||b.useMap))this._ecMove.push(JAK.Events.addListener(document,"touchmove",this,"_touchMove")),this._ecMove.push(JAK.Events.addListener(document,"touchend",this,"_touchEnd")),a=a.touches[0],this._commonStart(a.clientX,a.clientY)};
SMap.Control.Mouse.prototype._isInActive=function(a){for(var b=this.getMap().getLayerContainer(SMap.LAYER_ACTIVE);a;){if(a==b)return!0;a=a.parentNode}return!1};SMap.Control.Mouse.prototype._commonStart=function(a,b){this._drift.speed&&this._stopDrift();this._lastEvents=[new SMap.Pixel(a,b)];this._lastTimestamp=(new Date).getTime();this._moved=!1;this._speed=[]};SMap.Control.Mouse.prototype._mouseMove=function(a){this._commonMove(a.clientX,a.clientY)};
SMap.Control.Mouse.prototype._touchMove=function(a){JAK.Events.cancelDef(a);1<a.touches.length||(a=a.touches[0],this._commonMove(a.clientX,a.clientY))};
SMap.Control.Mouse.prototype._commonMove=function(a,b){var c=this._lastEvents[this._lastEvents.length-1];if(!(c.x==a&&c.y==b)){c=(new Date).getTime();this.options.idleDelay&&(this._idleTimeout&&clearTimeout(this._idleTimeout),this._idleTimeout=setTimeout(this._idle,this.options.idleDelay));this._moved||(this._moved=!0,this.getMap().lock());var d=this._lastEvents[this._lastEvents.length-1],e=a-d.x,d=b-d.y;this.getMap().setCenter(new SMap.Pixel(e,d));this._lastEvents.push(new SMap.Pixel(a,b));3<this._lastEvents.length&&
this._lastEvents.shift();e=Math.sqrt(e*e+d*d)/(c-this._lastTimestamp);Infinity!=Math.abs(e)&&!isNaN(e)&&this._speed.push(e);2<this._speed.length&&this._speed.shift();this._lastTimestamp=c}};SMap.Control.Mouse.prototype._touchEnd=function(){this._commonEnd()};SMap.Control.Mouse.prototype._mouseUp=function(){this._commonEnd()};
SMap.Control.Mouse.prototype._commonEnd=function(){JAK.Events.removeListeners(this._ecMove);this._idleTimeout&&(clearTimeout(this._idleTimeout),this._idleTimeout=!1);(!this._speed.length||this._drift.speed||!this._startDrift())&&this._moved&&this._resyncMap()};
SMap.Control.Mouse.prototype._startDrift=function(){var a=0;if(!(2>this._speed.length)){for(var b=0;b<this._speed.length;b++)a+=this._speed[b];a=20*a/this._speed.length;this._speed=[];if(a<this.options.minDriftSpeed)return!1;this._drift.speed=Math.min(a,this.options.maxDriftSpeed);this._drift.moved=0;a=this._lastEvents.shift();b=this._lastEvents.pop();this._drift.direction=Math.atan2(b.y-a.y,b.x-a.x);JAK.Timekeeper.getInstance().addListener(this,"_driftStep");return!0}};
SMap.Control.Mouse.prototype._stopDrift=function(){JAK.Timekeeper.getInstance().removeListener(this);this._drift.speed=0;this._resyncMap()};
SMap.Control.Mouse.prototype._driftStep=function(){this._drift.speed*=this.options.driftSlowdown;var a=Math.round(this._drift.speed*Math.cos(this._drift.direction)),b=Math.round(this._drift.speed*Math.sin(this._drift.direction));this._drift.moved+=Math.sqrt(a*a+b*b);this._drift.moved>this.options.driftThreshold&&(this._drift.moved-=this.options.driftThreshold,this.getMap().redraw());this.getMap().setCenter(new SMap.Pixel(a,b));0.2>=this._drift.speed&&this._stopDrift()};
SMap.Control.Mouse.prototype._resyncMap=function(){this.getMap().unlock()};SMap.Control.Mouse.prototype._idle=function(){this._moved=!1;this._speed=[];this._resyncMap()};SMap.Control.Mouse.prototype._dblClick=function(a){this._zoom("1",a.clientX,a.clientY)};
SMap.Control.Mouse.prototype._rightClick=function(a){if(a.button==JAK.Browser.mouse.right)if(this._context.timeout)clearTimeout(this._context.timeout),this._context.timeout=null,this._context.event=null,this._mode&SMap.MOUSE_ZOOM_OUT&&this._zoom("-1",a.clientX,a.clientY);else{for(var b=this.getMap().getLayerContainer(SMap.LAYER_ACTIVE),c=JAK.Events.getTarget(a);c;){if(c==b)return;c=c.parentNode}this._context.event={};for(var d in a)try{this._context.event[d]=a[d]}catch(e){}this._context.timeout=setTimeout(this._contextMenu,
300)}};SMap.Control.Mouse.prototype._break=function(a){"html"==JAK.Events.getTarget(a).tagName.toLowerCase()&&this._commonEnd()};SMap.Control.Mouse.prototype._recordPosition=function(a){this._clientX=a.clientX;this._clientY=a.clientY};
SMap.Control.Mouse.prototype._gestureStart=function(){this._ecGesture.length||(this._ecGesture.push(JAK.Events.addListener(document,"gesturechange",this,"_gestureChange")),this._ecGesture.push(JAK.Events.addListener(document,"gestureend",this,"_gestureEnd")),this._gestureScale=1)};
SMap.Control.Mouse.prototype._gestureChange=function(a){this._gesture.running||(this._gesture.running=!0,this.getMap().zoomAnimationStart(this._gesture.coords));JAK.Events.cancelDef(a);this._gesture.scale=a.scale;var a=this.getMap(),b=a.getZoom()+Math.log(this._gesture.scale)/Math.LN2;a.zoomAnimationStep(b)};
SMap.Control.Mouse.prototype._gestureEnd=function(){JAK.Events.removeListeners(this._ecGesture);this._gesture.coords=null;this._gesture.running=!1;var a=Math.log(this._gesture.scale)/Math.LN2;roundedDiff=0<a?Math.ceil(a):Math.floor(a);var b=this.getMap();b.zoomAnimationTarget(b.getZoom()+roundedDiff,b.getZoom()+a)};
SMap.Control.Mouse.prototype._scroll=function(a){if(!a.wheelDeltaX&&(JAK.Events.cancelDef(a),this._checkScrollFrequency())){var b=a.wheelDelta||a.detail,c=a.clientX,a=a.clientY;"gecko"==JAK.Browser.client&&(b=-b,c=this._clientX,a=this._clientY);this._zoom(0<b?"1":"-1",c,a)}};SMap.Control.Mouse.prototype._checkScrollFrequency=function(){if(this.options.scrollDelay){if(this._scrollTimeout)return!1;this._scrollTimeout=setTimeout(this._scrollUnlock,this.options.scrollDelay)}return!0};
SMap.Control.Mouse.prototype._zoom=function(a,b,c){var d=null,d=null!==b&&null!=c?SMap.Pixel.fromEvent({clientX:b,clientY:c},this.getMap()):new SMap.Pixel(0,0),b=d.toCoords(this.getMap());this.getMap().setZoom(a,b,!0)};SMap.Control.Mouse.prototype._scrollUnlock=function(){this._scrollTimeout=!1};SMap.Control.Mouse.prototype._contextMenu=function(){this._context.timeout=null;this.getMap().getSignals().makeEvent("map-contextmenu",this,{event:this._context.event});this._context.event=null};
SMap.Control.Orientation=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Orientation",VERSION:"1.0",EXTEND:SMap.Control.Visible});SMap.Control.Orientation.prototype.$constructor=function(a){this.$super();this._options={title:"Oto\u010dit",mode:"cw"};for(var b in a)this._options[b]=a[b];this._build()};
SMap.Control.Orientation.prototype._build=function(){this._dom.container=JAK.mel("div",{className:this._options.mode,title:this._options.title});this._ec.push(JAK.Events.addListener(this._dom.container,"click",this,"_click"))};SMap.Control.Orientation.prototype._click=function(){var a=this.getMap().getOrientation(),a=(a+("cw"==this._options.mode?1:-1)+4)%4;this.getMap().setOrientation(a);SMap.Logger.log("map-turn",{way:this._options.mode})};
SMap.Control.Overview=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Overview",VERSION:"1.0",EXTEND:SMap.Control.Image});SMap.Control.Overview.prototype.$constructor=function(){this.$super("http://m1.mapserver.mapy.cz/nahled2/0_{x}_{y}");this._projection=new SMap.Projection.UTM33;this._pixel=new SMap.Pixel(0,0)};
SMap.Control.Overview.prototype._buildURL=function(){var a=this._projection.pixelToCoords(this._pixel,this.getMap().getCenter(),1,SMap.NORTH).toPP();return this.getMap().formatString(this._url,{x:a[0].toString(16),y:a[1].toString(16)})};SMap.Control.Layer=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Layer",VERSION:"2.1",EXTEND:SMap.Control.Visible});
SMap.Control.Layer.prototype.$constructor=function(a){this.$super();this._options={width:81,items:3,page:3};for(var b in a)this._options[b]=a[b];this._window=null;this._page=0;this._layers={};this._opened=!1;this._menuClose=this._menuClose.bind(this);this._timer=null;this._build()};SMap.Control.Layer.prototype.$destructor=function(){this._layers={};this._window.$destructor();this.$super()};
SMap.Control.Layer.prototype.setOwner=function(a){this.$super(a);this._sc.push(this.getMap().getSignals().addListener(this,"layer-enable","_layerChange"));this._sc.push(this.getMap().getSignals().addListener(this,"layer-disable","_layerChange"));for(var b in this._layers)this._checkLayer(b)};SMap.Control.Layer.prototype.addLayer=function(a,b,c,d){this._layers[a]=this._buildItem(b,c,d);this._checkLayer(a);this._setPage(0)};
SMap.Control.Layer.prototype.addDefaultLayer=function(a){if(a in SMap.CONFIG){var b=SMap.CONFIG[a];this.addLayer(a,b.label,SMap.CONFIG.img+"/"+b.preview,b.title)}else throw Error("Invalid default layer id "+a);};SMap.Control.Layer.prototype.getContent=function(){return this._window.content};SMap.Control.Layer.prototype.getActiveId=function(){for(id in this._layers){var a=this.getMap().getLayer(id);if(a&&a.isActive())return a.getId()}return null};
SMap.Control.Layer.prototype._maxPage=function(){var a=0,b;for(b in this._layers)a++;return Math.ceil((a-this._options.items)/this._options.page)};SMap.Control.Layer.prototype._pageToPixel=function(a){return-a*this._options.page*this._options.width};
SMap.Control.Layer.prototype._setPage=function(a){var b=new JAK.CSSInterpolator(this._dom.content,200);b.addProperty("left",this._pageToPixel(this._page),this._pageToPixel(a),"px");this._page=a;b.start();this._dom.prev.style.display=this._page?"":"none";this._dom.next.style.display=this._page!=this._maxPage()?"":"none"};SMap.Control.Layer.prototype._checkLayer=function(a){this._owner&&a in this._layers&&this.getMap().getLayer(a)&&this._syncLayer(a)};
SMap.Control.Layer.prototype._syncLayer=function(a){var b=this.getMap().getLayer(a),c=this._layers[a];b.isActive()?(JAK.DOM.addClass(c,"active"),SMap.CONFIG[a]&&SMap.CONFIG[a].zoom&&(a=SMap.CONFIG[a].zoom,this.getMap().setZoomRange(a[0],a[1]))):JAK.DOM.removeClass(c,"active")};
SMap.Control.Layer.prototype._build=function(){this._dom.container=JAK.mel("div",{className:"layer-switch"});this._ec.push(JAK.Events.addListener(this._dom.container,"mouseover",this,"_mouseOver"));this._dom.container.appendChild(JAK.mel("div",{className:"label",innerHTML:"Zm\u011bnit mapu"}));this._buildWindow()};
SMap.Control.Layer.prototype._buildWindow=function(){this._window=new JAK.Window({imagePath:SMap.CONFIG.img+"/layer-switch/bg-",sizes:[8,8,8,8]});this._dom.container.appendChild(this._window.container);this._window.container.style.display="none";var a=JAK.mel("div",{className:"port"},{position:"relative",overflow:"hidden",width:this._options.width*this._options.items+"px"});this._window.content.appendChild(a);var b=JAK.mel("div",{},{position:"relative"});a.appendChild(b);this._dom.content=b;a=JAK.mel("div",
{className:"left"});this._dom.prev=JAK.mel("div",{className:"arrow"});a.appendChild(this._dom.prev);this._window.content.appendChild(a);this._ec.push(JAK.Events.addListener(a,"click",this,"_prev"));a=JAK.mel("div",{className:"right"});this._dom.next=JAK.mel("div",{className:"arrow"});a.appendChild(this._dom.next);this._window.content.appendChild(a);this._ec.push(JAK.Events.addListener(a,"click",this,"_next"));this._ec.push(JAK.Events.addListener(this._window.container,"mouseout",this,"_mouseOut"));
this._ec.push(JAK.Events.addListener(this._window.container,"mouseover",this,"_closeCancel"))};
SMap.Control.Layer.prototype._buildItem=function(a,b,c){var d=1,e;for(e in this._layers)d++;this._dom.content.style.width=d*this._options.width+"px";d=JAK.mel("div",{className:"item"},{width:this._options.width+"px",overflow:"hidden"});d.innerHTML="<div><img src='"+b+"' alt='"+a+"' title='"+(c||a)+"' /></div><p>"+a+"</p>";this._dom.content.appendChild(d);this._ec.push(JAK.Events.addListener(d,"click",this,"_itemClick"));return d};
SMap.Control.Layer.prototype._open=function(){if(!this._opened){this._opened=!0;this._switchActivePage();if("ie"!=JAK.Browser.client){var a=new JAK.CSSInterpolator(this._window.container,150,{endCallback:function(){this._window.container.style.filter=""}.bind(this)});a.addProperty("opacity",0,1);a.start()}this._window.container.style.display=""}};
SMap.Control.Layer.prototype._switchActivePage=function(){for(var a=[],b=this.getMap(),c=this._dom.content.childNodes,d=0;d<c.length;d++)a.push(c[d]);var c=-1,e;for(e in this._layers)if(b.getLayer(e).isActive()){c=a.indexOf(this._layers[e]);break}-1!=c&&(a=this._page*this._options.page,c>=a&&c<a+this._options.items||(a=Math.ceil((c-this._options.items+1)/this._options.page),a=Math.max(0,a),this._setPage(a)))};
SMap.Control.Layer.prototype._menuClose=function(){if(this._opened){var a=function(){this._window.container.style.display="none";this._opened=!1};"ie"!=JAK.Browser.client?(a=new JAK.CSSInterpolator(this._window.container,150,{endCallback:a.bind(this)}),a.addProperty("opacity",1,0),a.start()):a.call(this)}};SMap.Control.Layer.prototype._closeCancel=function(){this._timer&&(window.clearTimeout(this._timer),this._timer=null)};SMap.Control.Layer.prototype._layerChange=function(a){this._checkLayer(a.target.getId())};
SMap.Control.Layer.prototype._itemClick=function(a,b){for(var c in this._layers){var d=this._layers[c],e=this.getMap().getLayer(c);e&&d!=b&&this._disable(c)}for(c in this._layers)d=this._layers[c],(e=this.getMap().getLayer(c))&&d==b&&this._enable(c);this.getMap().getSignals().makeEvent("control-layer-click",this)};SMap.Control.Layer.prototype._mouseOver=function(){this._open()};
SMap.Control.Layer.prototype._mouseOut=function(a){for(a=a.relatedTarget||a.toElement;a&&a!=document.documentElement;){if(a==this._dom.container)return;a=a.parentNode}this._timer&&window.clearTimeout(this._timer);this._timer=window.setTimeout(this._menuClose,200)};SMap.Control.Layer.prototype._enable=function(a){(a=this.getMap().getLayer(a))&&a.enable()};SMap.Control.Layer.prototype._disable=function(a){(a=this.getMap().getLayer(a))&&a.disable()};
SMap.Control.Layer.prototype._prev=function(){this._page&&this._setPage(this._page-1)};SMap.Control.Layer.prototype._next=function(){this._page!=this._maxPage()&&this._setPage(this._page+1)};SMap.Control.Zoom=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Zoom",VERSION:"1.0",EXTEND:SMap.Control.Visible});
SMap.Control.Zoom.prototype.$constructor=function(a,b){this.$super();this._labels=a;this._zoom=[0,0];this._options={step:9,titles:[],sliderHeight:16};this._drag={};this._ec2=[];this._opened=!1;this._menuClose=this._menuClose.bind(this);this._timer=null;for(var c in b)this._options[c]=b[c];this._build()};SMap.Control.Zoom.prototype.setZoom=function(a,b){this._zoom=[a,b];this._adjustLine()};
SMap.Control.Zoom.prototype.setOwner=function(a){this.$super(a);a=this.getMap();this._sc.push(a.getSignals().addListener(this,"map-redraw","_mapRedraw"));this._sc.push(a.getSignals().addListener(this,"zoom-step","_zoomStep"));this._sc.push(a.getSignals().addListener(this,"zoom-range-change","_zoomRangeChange"));this._zoomRangeChange()};
SMap.Control.Zoom.prototype._build=function(){this._dom.container=JAK.mel("div",{className:"zoom"});var a=JAK.mel("div",{className:"bird"},{width:"100%"});this._ec.push(JAK.Events.addListener(a,"click",this,"_switchToOblique"));this._dom.container.appendChild(a);this._dom.large=JAK.mel("div",{},{display:"none",width:"100%",position:"absolute"});this._dom.container.appendChild(this._dom.large);for(var a=["top","middle","bottom"],b=0;b<a.length;b++){var c=a[b],d=JAK.mel("div",{className:c},{width:"100%"});
this._dom[c]=d;this._dom.large.appendChild(d)}this._ec.push(JAK.Events.addListener(this._dom.large,"mouseover",this,"_mouseOver"));this._ec.push(JAK.Events.addListener(this._dom.large,"mouseover",this,"_closeCancel"));this._ec.push(JAK.Events.addListener(this._dom.large,"mouseout",this,"_mouseOut"));this._buildButtons();this._buildLine();this._buildSlider()};
SMap.Control.Zoom.prototype._buildButtons=function(){for(var a=["plus","minus"],b=0;b<a.length;b++){var c=a[b],d=JAK.mel("div",{className:c},{position:"absolute",cursor:"pointer"});d.title=this._options.titles[b];this._dom.container.appendChild(d);this._ec.push(JAK.Events.addListener(d,"click",this,"_"+c));this._ec.push(JAK.Events.addListener(d,"mouseover",this,"_mouseOver"));this._ec.push(JAK.Events.addListener(d,"mouseover",this,"_closeCancel"));this._ec.push(JAK.Events.addListener(d,"mouseout",
this,"_mouseOut"))}};SMap.Control.Zoom.prototype._buildLine=function(){this._dom.line=JAK.mel("div",{className:"line"},{position:"absolute",cursor:"pointer"});this._dom.large.appendChild(this._dom.line);this._ec.push(JAK.Events.addListener(this._dom.large,"click",this,"_largeClick"));this._dom.labels=JAK.mel("div");this._dom.line.appendChild(this._dom.labels);this._adjustLine()};
SMap.Control.Zoom.prototype._buildSlider=function(){this._dom.slider=JAK.mel("div",{className:"slider"},{position:"absolute",cursor:"pointer",height:this._options.sliderHeight+"px"});this._dom.line.appendChild(this._dom.slider);this._ec.push(JAK.Events.addListener(this._dom.slider,"mousedown",this,"_sliderDown"));this._ec.push(JAK.Events.addListener(this._dom.slider,"click",JAK.Events,"stopEvent"))};
SMap.Control.Zoom.prototype._adjustLine=function(){var a=this._zoom,b=a[1]-a[0];19==a[1]&&(b+=2);var c=this._options.step*b;this._dom.middle.style.height=c+"px";c=this._options.step*(b+1);this._dom.line.style.height=c+"px";b=this._options.step;JAK.DOM.clear(this._dom.labels);for(var d in this._labels)d=parseInt(d),d>=a[0]&&d<=a[1]&&(c=JAK.mel("div",{className:"label"},{position:"absolute",cursor:"pointer"}),c.innerHTML=this._labels[d],19==d&&(d+=1.5),c.style.top=Math.round((d-a[0])*b-3)+"px",this._dom.labels.appendChild(c))};
SMap.Control.Zoom.prototype._plus=function(){this._owner&&(this.getMap().setZoom("+1",null,!0),SMap.Logger.log("zoom-push",{dir:"+1"}))};SMap.Control.Zoom.prototype._minus=function(){this._owner&&(this.getMap().setZoom("-1",null,!0),SMap.Logger.log("zoom-push",{dir:"-1"}))};SMap.Control.Zoom.prototype._mouseOver=function(){this._open()};
SMap.Control.Zoom.prototype._open=function(){if(!this._opened){this._opened=!0;if("ie"!=JAK.Browser.client){var a=new JAK.CSSInterpolator(this._dom.large,150,{endCallback:function(){this._dom.large.style.filter=""}.bind(this)});a.addProperty("opacity",0,1);a.start()}this._dom.large.style.display=""}};
SMap.Control.Zoom.prototype._mouseOut=function(a){if(this._opened){for(a=a.relatedTarget||a.toElement;a&&a!=document.documentElement;){if(a==this._dom.container)return;a=a.parentNode}this._timer&&clearTimeout(this._timer);this._timer=setTimeout(this._menuClose,200)}};
SMap.Control.Zoom.prototype._menuClose=function(){this._timer=null;var a=function(){this._dom.large.style.display="none";this._opened=!1};"ie"!=JAK.Browser.client?(a=new JAK.CSSInterpolator(this._dom.large,150,{endCallback:a.bind(this)}),a.addProperty("opacity",1,0),a.start()):a.call(this)};SMap.Control.Zoom.prototype._closeCancel=function(){this._timer&&(clearTimeout(this._timer),this._timer=null)};
SMap.Control.Zoom.prototype._sliderDown=function(a){JAK.Events.cancelDef(a);this._drag.mouseY=a.clientY;this._drag.y=this._dom.slider.offsetTop;this._drag.min=this._zoomToY(this._zoom[0]);this._drag.max=this._zoomToY(this._zoom[1]);this._ec2.push(JAK.Events.addListener(document,"mousemove",this,"_sliderMove"));this._ec2.push(JAK.Events.addListener(document,"mouseup",this,"_sliderUp"))};
SMap.Control.Zoom.prototype._sliderMove=function(a){var b=a.clientY-this._drag.mouseY;this._drag.mouseY=a.clientY;this._drag.y+=b;a=Math.max(this._drag.y,this._drag.min);a=Math.min(a,this._drag.max);this._dom.slider.style.top=a+"px"};SMap.Control.Zoom.prototype._sliderUp=function(){this._ec2.forEach(JAK.Events.removeListener,JAK.Events);this._ec2=[];var a=this._yToZoom(this._dom.slider.offsetTop+this._options.sliderHeight/2);this.getMap().setZoom(a);this._redraw(a);SMap.Logger.log("zoom-pull",{type:"drag"})};
SMap.Control.Zoom.prototype._redraw=function(a){this._dom.slider.style.top=this._zoomToY(a)+"px";this._dom.slider.title=a};SMap.Control.Zoom.prototype._mapRedraw=function(){this._redraw(this.getMap().getZoom())};SMap.Control.Zoom.prototype._zoomStep=function(a){this._redraw(a.data.currentZoom)};SMap.Control.Zoom.prototype._zoomRangeChange=function(){var a=this.getMap().getZoomRange();this.setZoom(a[0],a[1]);this._redraw(this.getMap().getZoom())};
SMap.Control.Zoom.prototype._zoomToY=function(a){var b=this._options.step,c=a-this._zoom[0];19==a&&(c+=2);return Math.round((c+0.5)*b-this._options.sliderHeight/2)};SMap.Control.Zoom.prototype._yToZoom=function(a){return Math.min(this._zoom[0]+Math.floor(a/this._options.step),this._zoom[1])};
SMap.Control.Zoom.prototype._largeClick=function(a,b){SMap.Logger.log("zoom-pull",{type:"click"});var c=this._dom.line.offsetTop,d=c+this._dom.line.offsetHeight,e=JAK.DOM.getBoxPosition(b),f=JAK.DOM.getScrollPos(),e=a.clientY-e.top+f.y,e=e<c?0:e>d?this._dom.line.offsetHeight:e-c,c=this._yToZoom(e);this.getMap().setZoom(c)};SMap.Control.Zoom.prototype._switchToOblique=function(){4>=19-this.getMap().getZoom()?this.getMap().setZoom(19,null,!0):this.getMap().setZoom(19);SMap.Logger.log("oblique")};
SMap.Control.Copyright=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Copyright",VERSION:"1.0",EXTEND:SMap.Control.Visible});SMap.Control.Copyright.prototype.$constructor=function(){this.$super();this._dpm=0;this._dom.container=JAK.mel("div",{className:"copyright"},{visibility:"visible"});this._dom.outline=[];this._parts=[];this._static=[]};
SMap.Control.Copyright.prototype.setOwner=function(a){this.$super(a);this._sc.push(this.getMap().getSignals().addListener(this,"layer-enable","_enable"));this._sc.push(this.getMap().getSignals().addListener(this,"layer-disable","_disable"));this._sc.push(this.getMap().getSignals().addListener(this,"map-redraw","_redraw"));a=JAK.mel("div",{},{position:"absolute",width:"100cm"});document.body.appendChild(a);this._dpm=a.offsetWidth;a.parentNode.removeChild(a)};
SMap.Control.Copyright.prototype.addCopyright=function(a){this._static.push("&copy; "+a);this._redraw()};SMap.Control.Copyright.prototype._enable=function(a){this._parts.push(a.target);this._redraw()};SMap.Control.Copyright.prototype._disable=function(a){a=this._parts.indexOf(a.target);-1!=a&&(this._parts.splice(a,1),this._redraw())};
SMap.Control.Copyright.prototype._redraw=function(){var a=this.getMap().getZoom(),b=this._computeScale(),c=[];b&&c.push(b);for(b=0;b<this._static.length;b++)c.push(this._static[b]);for(b=0;b<this._parts.length;b++){var d=this._parts[b].getCopyright(a);if(d){d instanceof Array||(d=[d]);for(var e=0;e<d.length;e++){var f="&copy; "+d[e];-1==c.indexOf(f)&&c.push(f)}}}this._dom.container.innerHTML=c.join(", ")};
SMap.Control.Copyright.prototype._computeScale=function(){var a="";switch(this.getMap().getZoom()){case 9:a="380 000";break;case 10:a="190 000";break;case 11:a="95 000";break;case 12:a="47 000";break;case 13:a="24 000";break;case 14:a="12 000";break;case 15:a="6 000";break;case 16:a="3 000"}a&&(a="1 : "+a);return a};SMap.Control.Minimap=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Minimap",VERSION:"1.0",EXTEND:SMap.Control.Visible});
SMap.Control.Minimap.prototype.$constructor=function(a,b,c){this.$super();this._options={diff:-4,opacity:0.5,layer:SMap.DEF_BASE,color:"gray"};a=a||150;b=b||150;this._map=null;this._layer=new SMap.Layer.Geometry;this._dom.container=JAK.mel("div",{className:"minimap"},{width:a+"px",height:b+"px"});this.setOptions(c)};
SMap.Control.Minimap.prototype.setOwner=function(a){this.$super(a);a=this.getMap();this._sc.push(a.getSignals().addListener(this,"map-redraw","_mapRedraw"));for(this._map=new SMap(this._dom.container,a.getCenter(),14);;){a=this._map.getControls();if(!a.length)break;this._map.removeControl(a[0])}this._map.addDefaultLayer(this._options.layer).enable();this._map.addLayer(this._layer).enable();this._mapRedraw()};
SMap.Control.Minimap.prototype.setOptions=function(a){if(this._map){var b=this._map.getLayer(this._options.layer);b.disable();this._map.removeLayer(b);b.$destructor()}for(var c in a)this._options[c]=a[c];this._dom.container.borderColor=this._options.color;this._map&&(this._map.addDefaultLayer(this._options.layer).enable(),this._mapRedraw())};
SMap.Control.Minimap.prototype._mapRedraw=function(){var a=this.getMap(),b=a.getZoom();19==b&&(b=18);b+=this._options.diff;this._map.setCenterZoom(a.getCenter(),b);this._layer.removeAll();var c=a.getSize(),d=Math.round(c.x/2),c=Math.round(c.y/2),b=(new SMap.Pixel(-d,-c)).toCoords(a),e=(new SMap.Pixel(d,-c)).toCoords(a),f=(new SMap.Pixel(-d,c)).toCoords(a),a=(new SMap.Pixel(d,c)).toCoords(a),c=this._map.getSize(),d=Math.round(c.x/2),c=Math.round(c.y/2),g=(new SMap.Pixel(-d,-c)).toCoords(this._map),
h=(new SMap.Pixel(d,-c)).toCoords(this._map),j=(new SMap.Pixel(-d,c)).toCoords(this._map),d=(new SMap.Pixel(d,c)).toCoords(this._map),d=new SMap.Geometry(SMap.GEOMETRY_POLYGON,null,[b,e,a,f,b,g,j,d,h,g],{outlineOpacity:0,color:this._options.color,opacity:this._options.opacity});this._layer.addGeometry(d);d=new SMap.Geometry(SMap.GEOMETRY_POLYGON,null,[b,e,a,f],{outlineColor:this._options.color,outlineOpacity:0.8,color:"transparent"});this._layer.addGeometry(d)};
SMap.Control.Rosette=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Rosette",VERSION:"1.0",EXTEND:SMap.Control.Visible});SMap.Control.Rosette.prototype.STATIC_SRC="http://m1.mapserver.mapy.cz/rosette/0_0000000_{s}";SMap.Control.Rosette.prototype.$constructor=function(a){this.$super();this._options={};for(var b in a)this._options[b]=a[b];this._build()};SMap.Control.Rosette.prototype.$destructor=function(){this.getMap().getSignals().removeListeners(this._sc);this.$super()};
SMap.Control.Rosette.prototype.setOwner=function(a){this.$super(a);a=this.getMap().getSignals();this._sc.push(a.addListener(this,"map-redraw","_redraw"));this._sc.push(a.addListener(this,"rotation-temporary","_tempRotate"));this._redraw()};
SMap.Control.Rosette.prototype._build=function(){this._dom.container=JAK.mel("div",{className:"control-rosette"});this._dom.rosette=JAK.mel("img",{src:SMap.CONFIG.img+"/rosette.png"});this._dom.north=JAK.mel("div",{innerHTML:"s"});JAK.DOM.append([this._dom.container,this._dom.rosette,this._dom.north])};SMap.Control.Rosette.prototype._redraw=function(){var a=this.getMap(),b=a.getCenter(),c=a.getSize().x/2,a=(new SMap.Pixel(c,0)).toCoords(a,a.getZoom);this._rotate(b.azimuth(a),!0)};
SMap.Control.Rosette.prototype._rotate=function(a,b){for(var c=["transform","MozTransform","WebkitTransform","OTransform","msTransform"],d,e=0;e<c.length;e++)c[e]in this._dom.rosette.style&&(d=c[e]);d?(b&&(a=this._angle=90-a),this._dom.rosette.style[d]="rotate("+a+"deg)"):b&&this._changeSrc(90-a)};SMap.Control.Rosette.prototype._tempRotate=function(a){this._rotate(this._angle+a.data.angle)};
SMap.Control.Rosette.prototype._changeSrc=function(a){0>a&&(a=360+a);this._dom.rosette.src=this.STATIC_SRC.replace("{s}",Math.round(a).toString(16).lpad("0",7))};SMap.Control.ContextMenu=JAK.ClassMaker.makeClass({NAME:"SMap.Control.ContextMenu",VERSION:"1.0",EXTEND:SMap.Control});SMap.Control.ContextMenu.prototype.$constructor=function(){this.$super();this._window=null;this._isOpen=!1;this._items=[];this._signals={};this._dom={};this._margin=4;this._build()};
SMap.Control.ContextMenu.prototype.$destructor=function(){this._window.$destructor();this._isOpen&&this.close();this.$super()};
SMap.Control.ContextMenu.prototype.setOwner=function(a){this.$super(a);this._ec.push(JAK.Events.addListener(document,"mousedown",this,"_mousedown"));this._ec.push(JAK.Events.addListener(this._dom.container,"mousedown",JAK.Events.stopEvent));this._ec.push(JAK.Events.addListener(this._dom.container,"contextmenu",JAK.Events.cancelDef));this._ec.push(JAK.Events.addListener(window,"resize",this,"_syncBlank"));this._ec.push(JAK.Events.addListener(window,"scroll",this,"_syncBlank"))};
SMap.Control.ContextMenu.prototype.open=function(a,b){var c=this.getMap(),c=b||SMap.Coords.fromEvent(a,c);this._positionMenu(new SMap.Pixel(a.clientX,a.clientY));for(var d=0;d<this._items.length;d++)this._items[d].setCoords(c,this);this._isOpen||(this._closeSignal=this.getMap().getSignals().addListener(this,"map-redraw","close"),this._isOpen=!0,this._syncBlank());c=c.toWGS84();SMap.Logger.log("menu",{eventx:c[0].toFixed(6),eventy:c[1].toFixed(6)})};
SMap.Control.ContextMenu.prototype.close=function(){this._isOpen&&(this._dom.blank.parentNode.removeChild(this._dom.blank),this._dom.container.parentNode.removeChild(this._dom.container),this.getMap().getSignals().removeListener(this._closeSignal),this._closeSignal=null,this._isOpen=!1)};
SMap.Control.ContextMenu.prototype.addItem=function(a,b){var c=this._items.indexOf(a);if(0<=c)throw Error("Can't add existing item");var c=1<arguments.length?b:this._items.length,d=a.getContainer(),e=c>=this._items.length?null:this._items[c].getContainer();this._dom.content.insertBefore(d,e);this._items.splice(c,0,a)};
SMap.Control.ContextMenu.prototype.removeItem=function(a){var b=this._items.indexOf(a);if(-1==b)throw Error("Can't remove non-existent item");this._items.splice(b,1);a=a.getContainer();a.parentNode.removeChild(a)};SMap.Control.ContextMenu.prototype.getItems=function(){return this._items};SMap.Control.ContextMenu.prototype.clearItems=function(){JAK.DOM.clear(this._dom.content);this._items=[]};
SMap.Control.ContextMenu.prototype.addSignal=function(a,b){if(a in this._signals)throw Error("Signal '"+a+"' already handled");this._signals[a]=b;this._sc.push(this.getMap().getSignals().addListener(this,a,"_signal"))};
SMap.Control.ContextMenu.prototype._positionMenu=function(a){document.body.appendChild(this._dom.blank);var b=0,c=0;this._dom.container.style.visibility="hidden";document.body.appendChild(this._dom.container);var d=JAK.DOM.getScrollPos();a.x+=d.x;a.y+=d.y;d=JAK.DOM.getDocSize();a.x>d.width/2?(a.x-=this._dom.container.offsetWidth,a.x+=this._margin,c=2):a.x-=this._margin;a.y>d.height/2?(a.y-=this._dom.container.offsetHeight,a.y+=this._margin,b=2):a.y-=this._margin;this._dom.container.style.left=a.x+
"px";this._dom.container.style.top=a.y+"px";d=JAK.DOM.shiftBox(this._dom.container);a.x+=d[0];a.y+=d[1];this._dom.container.style.left=a.x+"px";this._dom.container.style.top=a.y+"px";this._window.setImage(0,0);this._window.setImage(0,2);this._window.setImage(2,0);this._window.setImage(2,2);this._window.setImage(b,c,"-active");this._dom.container.style.visibility=""};SMap.Control.ContextMenu.prototype._mousedown=function(){this._isOpen&&this.close()};
SMap.Control.ContextMenu.prototype._mapContextMenu=function(a){this.open(a.data.event)};
SMap.Control.ContextMenu.prototype._build=function(){this._window=new JAK.Window({imagePath:SMap.CONFIG.img+"/contextmenu/",sizes:[14,14,14,14]});this._dom.blank=JAK.mel("div",{},{position:"absolute"});this._dom.container=this._window.container;this._dom.content=this._window.content;JAK.DOM.addClass(this._dom.container,"context-menu");this._dom.container.style.position="absolute";this._ec.push(JAK.Events.addListener(this._dom.container,"click",this,"_click"))};
SMap.Control.ContextMenu.prototype._click=function(a){JAK.Events.cancelDef(a);for(var b=[],c=0;c<this._items.length;c++)b.push(this._items[c].getContainer());for(c=JAK.Events.getTarget(a);c!=this._dom.container;){var d=b.indexOf(c);if(-1!=d){this._items[d].click(a,this);break}c=c.parentNode}};SMap.Control.ContextMenu.prototype._signal=function(a){if(a.type in this._signals)this._signals[a.type](this,a)};
SMap.Control.ContextMenu.prototype._syncBlank=function(){if(this._isOpen){var a=JAK.DOM.getScrollPos();this._dom.blank.style.left=a.x+"px";this._dom.blank.style.top=a.y+"px";a=JAK.DOM.getDocSize();this._dom.blank.style.width=a.width+"px";this._dom.blank.style.height=a.height+"px"}};SMap.Control.ContextMenu.Item=JAK.ClassMaker.makeClass({NAME:"SMap.Control.ContextMenu.Item",VERSION:"1.0"});
SMap.Control.ContextMenu.Item.prototype.$constructor=function(a){this._label=a;this._disabled=!1;this._coords=null;this._ec=[];this._dom={};this._build()};SMap.Control.ContextMenu.Item.prototype.$destructor=function(){for(;this._ec.length;)JAK.Events.removeListener(this._ec.shift())};SMap.Control.ContextMenu.Item.prototype.click=function(){};SMap.Control.ContextMenu.Item.prototype.enable=function(){JAK.DOM.removeClass(this._dom.container,"disabled");this._disabled=!1};
SMap.Control.ContextMenu.Item.prototype.disable=function(){JAK.DOM.addClass(this._dom.container,"disabled");this._disabled=!0};SMap.Control.ContextMenu.Item.prototype.setCoords=function(a){this._coords=a};SMap.Control.ContextMenu.Item.prototype.getContainer=function(){return this._dom.container};SMap.Control.ContextMenu.Item.prototype._build=function(){var a=JAK.mel("a",{href:"#",className:"item"});a.innerHTML=this._label;this._dom.container=a};
SMap.Control.ContextMenu.Zoom=JAK.ClassMaker.makeClass({NAME:"SMap.Control.ContextMenu.Zoom",VERSION:"1.0",EXTEND:SMap.Control.ContextMenu.Item});SMap.Control.ContextMenu.Zoom.prototype.$constructor=function(a,b){this.$super(a);this._zoomDiff=b};SMap.Control.ContextMenu.Zoom.prototype.setCoords=function(a,b){this.$super(a);var c=b.getMap().getZoom(),d=b.getMap().getZoomRange(),c=c+this._zoomDiff;c>=d[0]&&c<=d[1]?this.enable():this.disable()};
SMap.Control.ContextMenu.Zoom.prototype.click=function(a,b){this._disabled||(b.getMap().setZoom(1==this._zoomDiff?"+1":"-1",this._coords,!0),b.close())};SMap.Control.ContextMenu.Coords=JAK.ClassMaker.makeClass({NAME:"SMap.Control.ContextMenu.Coords",VERSION:"1.0",EXTEND:SMap.Control.ContextMenu.Item});SMap.Control.ContextMenu.Coords.prototype.$constructor=function(){this.$super("")};SMap.Control.ContextMenu.Coords.prototype._build=function(){this._dom.container=JAK.mel("span",{className:"item"})};
SMap.Control.ContextMenu.Coords.prototype.setCoords=function(a){this.$super(a);this._dom.container.innerHTML=a.toWGS84(2).reverse().join(", ")};SMap.Control.ContextMenu.Separator=JAK.ClassMaker.makeClass({NAME:"SMap.Control.ContextMenu.Separator",VERSION:"1.0",EXTEND:SMap.Control.ContextMenu.Item});SMap.Control.ContextMenu.Separator.prototype.$constructor=function(){this.$super("")};SMap.Control.ContextMenu.Separator.prototype._build=function(){this._dom.container=JAK.mel("span",{className:"item separator"})};
SMap.Layer.GPX=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.GPX",VERSION:"1.0",EXTEND:SMap.Layer.Multi});SMap.Layer.GPX.prototype.$constructor=function(a,b,c){this.$super(b);this._xmlDoc=a;this._options={maxPoints:100,colors:"#004c8c #ff4911 #ffd625 #5ea221 #840026 #89cdff #374705 #b3d200 #522476 #ff9b11 #c9000e #008ad4".split(" ")};for(var d in c)this._options[d]=c[d];this._routes=[];this._tracks=[];this._waypoints=[];this._bounds=null;this._parse(a)};
SMap.Layer.GPX.prototype.fit=function(){var a=[];if(this._bounds)a=this._bounds;else{for(var b=0;b<this._waypoints.length;b++)a.push(this._waypoints[b].getCoords());for(b=0;b<this._routes.length;b++)a=a.concat(this._routes[b].getCoords());for(b=0;b<this._tracks.length;b++)a=a.concat(this._tracks[b].getCoords())}a=this.getMap().computeCenterZoom(a);this.getMap().setCenterZoom(a[0],a[1])};
SMap.Layer.GPX.prototype.filter=function(a){if(0==this._options.maxPoints||this._options.maxPoints>=a.length)return a;for(var b=[],c=(a.length-1)/(this._options.maxPoints-1),d=0,e=0;e<this._options.maxPoints;e++)b.push(a[Math.round(d)]),d+=c;return b};
SMap.Layer.GPX.prototype._parse=function(){for(var a=this._xmlDoc.getElementsByTagName("wpt"),a=this.filter(a),b=0;b<a.length;b++)this._waypoints.push(new SMap.Marker.GPX(a[b]));for(var a=0,c=this._xmlDoc.getElementsByTagName("rte"),b=0;b<c.length;b++)this._routes.push(new SMap.Geometry.GPXRoute(this,c[b],this._options.colors[a%this._options.colors.length])),a++;c=this._xmlDoc.getElementsByTagName("trk");for(b=0;b<c.length;b++)this._tracks.push(new SMap.Geometry.GPXTrack(this,c[b],this._options.colors[a%
this._options.colors.length])),a++;this._buildLayers();var d=this._xmlDoc.getElementsByTagName("bounds");d.length&&(d=d[0],a=parseFloat(d.getAttribute("minlat")),c=parseFloat(d.getAttribute("minlon")),b=parseFloat(d.getAttribute("maxlat")),d=parseFloat(d.getAttribute("maxlon")),a=SMap.Coords.fromWGS84(c,a),b=SMap.Coords.fromWGS84(d,b),this._bounds=[a,b])};
SMap.Layer.GPX.prototype._buildLayers=function(){if(this._waypoints.length){var a=new SMap.Layer.Marker;this.addLayer(a);for(var b=0;b<this._waypoints.length;b++)a.addMarker(this._waypoints[b])}if(this._routes.length+this._tracks.length){a=new SMap.Layer.Geometry;this.addLayer(a);for(b=0;b<this._routes.length;b++)a.addGeometry(this._routes[b]);for(b=0;b<this._tracks.length;b++)a.addGeometry(this._tracks[b])}};SMap.Marker.GPX=JAK.ClassMaker.makeClass({NAME:"SMap.Marker.GPX",EXTEND:SMap.Marker,VERSION:"2.0"});
SMap.Marker.GPX.prototype.$constructor=function(a){var b=a.getElementsByTagName("name"),b=b.length?JAK.XML.textContent(b[0]):"",c=a.getElementsByTagName("desc"),c=c.length?JAK.XML.textContent(c[0]):"",d={};b&&(d.title=b);var e=parseFloat(a.getAttribute("lat")),a=parseFloat(a.getAttribute("lon"));this.$super(SMap.Coords.fromWGS84(a,e),null,d);if(b||c)d=new SMap.Card,d.getHeader().innerHTML=b,d.getBody().innerHTML=c,this.decorate(SMap.Marker.Feature.Card,d)};
SMap.Geometry.GPXRoute=JAK.ClassMaker.makeClass({NAME:"SMap.Geometry.GPXRoute",EXTEND:SMap.Geometry,VERSION:"2.0"});SMap.Geometry.GPXRoute.prototype.$constructor=function(a,b,c){for(var c={width:4,color:c,opacity:0.7},d=[],e=b.getElementsByTagName("rtept"),e=a.filter(e),a=0;a<e.length;a++){var f=new SMap.Marker.GPX(e[a]);d.push(f.getCoords())}b=b.getElementsByTagName("name");b.length&&(c.title=JAK.XML.textContent(b[0]));this.$super(SMap.GEOMETRY_POLYLINE,null,d,c)};
SMap.Geometry.GPXTrack=JAK.ClassMaker.makeClass({NAME:"SMap.Geometry.GPXTrack",EXTEND:SMap.Geometry,VERSION:"2.0"});
SMap.Geometry.GPXTrack.prototype.$constructor=function(a,b,c){for(var c={width:4,color:c,opacity:0.7},d=[],e=b.getElementsByTagName("trkseg"),f=0;f<e.length;f++){for(var g=[],h=e[f].getElementsByTagName("trkpt"),h=a.filter(h),j=0;j<h.length;j++){var k=new SMap.Marker.GPX(h[j]);g.push(k.getCoords())}d=d.concat(g)}a=b.getElementsByTagName("name");a.length&&(c.title=JAK.XML.textContent(a[0]));this.$super(SMap.GEOMETRY_POLYLINE,null,d,c)};
SMap.Layer.KML=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.KML",VERSION:"1.0",EXTEND:SMap.Layer.Multi});SMap.Layer.KML.prototype.$constructor=function(a,b,c){this.$super(b);this._xmlDoc=a;this._ids={};this._options={maxPoints:100,url:""};for(var d in c)this._options[d]=c[d];a=a.getElementsByTagName("*");for(c=0;c<a.length;c++)d=a[c],(b=d.getAttribute("id"))&&(this._ids[b]=d);this._markers=[];this._geometries=[];this._parse()};
SMap.Layer.KML.prototype._parse=function(){for(var a=this._xmlDoc.getElementsByTagName("Placemark"),b=0;b<a.length;b++){var c=a[b];c.getElementsByTagName("Point").length?this._markers.push(new SMap.Marker.KML(this,c)):c.getElementsByTagName("LineString").length?this._geometries.push(new SMap.Geometry.KMLLine(this,c)):c.getElementsByTagName("Polygon").length&&this._geometries.push(new SMap.Geometry.KMLPolygon(this,c))}this._buildLayers()};
SMap.Layer.KML.prototype._buildLayers=function(){if(this._markers.length){var a=new SMap.Layer.Marker;this.addLayer(a);for(var b=0;b<this._markers.length;b++)a.addMarker(this._markers[b])}if(this._geometries.length){a=new SMap.Layer.Geometry;this.addLayer(a);for(b=0;b<this._geometries.length;b++)a.addGeometry(this._geometries[b])}};
SMap.Layer.KML.prototype.filter=function(a){if(0==this._options.maxPoints||this._options.maxPoints>=a.length)return a;for(var b=[],c=(a.length-1)/(this._options.maxPoints-1),d=0,e=0;e<this._options.maxPoints;e++)b.push(a[Math.round(d)]),d+=c;return b};
SMap.Layer.KML.prototype.fit=function(){for(var a=[],b=0;b<this._markers.length;b++)a.push(this._markers[b].getCoords());for(b=0;b<this._geometries.length;b++)a=a.concat(this._geometries[b].getCoords());a=this.getMap().computeCenterZoom(a);this.getMap().setCenterZoom(a[0],a[1])};SMap.Layer.KML.prototype.getStyle=function(a,b){var c=a,d=a.getElementsByTagName("styleUrl");d.length&&(d=this._ids[JAK.XML.textContent(d[0]).match(/[^#]+/)[0]])&&(c=d);c=c.getElementsByTagName(b);return c.length?c[0]:null};
SMap.Layer.KML.prototype.getColor=function(a){a=a.match(/..(..)(..)(..)/);return"#"+a[3]+a[2]+a[1]};SMap.Layer.KML.prototype.getOpacity=function(a){return parseInt(a.substring(0,2),16)/255};SMap.Layer.KML.prototype.getURL=function(){return this._options.url};SMap.Marker.KML=JAK.ClassMaker.makeClass({NAME:"SMap.Marker.KML",EXTEND:SMap.Marker,VERSION:"2.0"});
SMap.Marker.KML.prototype.$constructor=function(a,b){var c=b.getElementsByTagName("coordinates")[0],d=JAK.XML.textContent(c).split(","),e=parseFloat(d[0]),d=parseFloat(d[1]),c=SMap.Coords.fromWGS84(e,d),e=b.getElementsByTagName("name"),e=e.length?JAK.XML.textContent(e[0]):"",d=b.getElementsByTagName("description"),d=d.length?JAK.XML.textContent(d[0]):"",f={},g={},h=a.getStyle(b,"IconStyle");if(h){var j=h.getElementsByTagName("href");if(j.length){f.url=this._buildImageUrl(JAK.XML.textContent(j[0]),
a);var k=h.getElementsByTagName("hotSpot");if(k.length){var h={},k=k[0],j=parseFloat(k.getAttribute("x")),l=parseFloat(k.getAttribute("y")),m=k.getAttribute("xunits"),k=k.getAttribute("yunits");"fraction"==m?g.left=j:h.left=j;"fraction"==k?g.top=l:h.top=l;if("left"in h||"top"in h)f.anchor=h}else g.left=0.5,g.bottom=0}}e&&(f.title=e);this.$super(c,null,f);("left"in g||"top"in g)&&this.decorate(SMap.Marker.Feature.RelativeAnchor,{anchor:g});if(e||d)c=new SMap.Card,c.getHeader().innerHTML="<strong>"+
e+"</strong>",c.getBody().innerHTML=d,this.decorate(SMap.Marker.Feature.Card,c)};SMap.Marker.KML.prototype._buildImageUrl=function(a,b){if(a.match(/^http/i))return a;var c=b.getURL(),d=c.lastIndexOf("/");-1!=d&&(c=c.substring(0,d));return c+"/"+a};SMap.Geometry.KMLLine=JAK.ClassMaker.makeClass({NAME:"SMap.Geometry.KMLLine",EXTEND:SMap.Geometry,VERSION:"2.0"});
SMap.Geometry.KMLLine.prototype.$constructor=function(a,b){for(var c=[],d={},e=b.getElementsByTagName("LineString")[0].getElementsByTagName("coordinates")[0],e=JAK.XML.textContent(e),f=e.split(/\s+/),f=a.filter(f),g=0;g<f.length;g++)if(e=f[g]){var e=e.split(","),h=parseFloat(e[0]),e=parseFloat(e[1]),e=SMap.Coords.fromWGS84(h,e);c.push(e)}if(f=a.getStyle(b,"LineStyle"))if(e=f.getElementsByTagName("color"),e.length&&(e=JAK.XML.textContent(e[0]),d.color=a.getColor(e),d.opacity=a.getOpacity(e)),e=f.getElementsByTagName("width"),
e.length)d.width=parseFloat(JAK.XML.textContent(e[0]));f=b.getElementsByTagName("name");if(f=f.length?JAK.XML.textContent(f[0]):"")d.title=f;this.$super(SMap.GEOMETRY_POLYLINE,null,c,d);c=b.getElementsByTagName("description");c=c.length?JAK.XML.textContent(c[0]):"";if(f||c)e=new SMap.Card,e.getHeader().innerHTML="<strong>"+f+"</strong>",e.getBody().innerHTML=c,this.decorate(SMap.Geometry.Feature.Card,e)};
SMap.Geometry.KMLPolygon=JAK.ClassMaker.makeClass({NAME:"SMap.Geometry.KMLPolygon",EXTEND:SMap.Geometry,VERSION:"2.0"});
SMap.Geometry.KMLPolygon.prototype.$constructor=function(a,b){for(var c=[],d={},e=b.getElementsByTagName("Polygon")[0].getElementsByTagName("outerBoundaryIs")[0].getElementsByTagName("coordinates")[0],e=JAK.XML.textContent(e),f=e.split(/\s+/),f=a.filter(f),g=0;g<f.length;g++)if(e=f[g]){var e=e.split(","),h=parseFloat(e[0]),e=parseFloat(e[1]),e=SMap.Coords.fromWGS84(h,e);c.push(e)}if(f=a.getStyle(b,"PolyStyle"))if(e=f.getElementsByTagName("color"),e.length&&(e=JAK.XML.textContent(e[0]),d.color=a.getColor(e),
d.opacity=a.getOpacity(e)),e=f.getElementsByTagName("fill"),e.length&&"0"==JAK.XML.textContent(e[0])&&(d.color="none"),e=f.getElementsByTagName("width"),e.length)d.width=parseFloat(JAK.XML.textContent(e));if(f=a.getStyle(b,"LineStyle"))if(e=f.getElementsByTagName("color"),e.length&&(e=JAK.XML.textContent(e[0]),d.outlineColor=a.getColor(e),d.outlineOpacity=a.getOpacity(e)),e=f.getElementsByTagName("width"),e.length)d.outlineWidth=parseFloat(JAK.XML.textContent(e[0]));f=b.getElementsByTagName("name");
if(f=f.length?JAK.XML.textContent(f[0]):"")d.title=f;this.$super(SMap.GEOMETRY_POLYGON,null,c,d);c=b.getElementsByTagName("description");c=c.length?JAK.XML.textContent(c[0]):"";if(f||c)e=new SMap.Card,e.getHeader().innerHTML="<strong>"+f+"</strong>",e.getBody().innerHTML=c,this.decorate(SMap.Geometry.Feature.Card,e)};SMap.Geocoder=JAK.ClassMaker.makeClass({NAME:"SMap.Geocoder",VERSION:"2.0",IMPLEMENT:JAK.ISignals});SMap.Geocoder.METHOD="geocode";
SMap.Geocoder.prototype.$constructor=function(a,b,c){this._request=null;this._query=a;this._callback=b;this._results=[];this._options={url:"/geocode",count:null};for(var d in c)this._options[d]=c[d];this._sendRequest()};SMap.Geocoder.prototype.$destructor=function(){this.abort()};SMap.Geocoder.prototype.abort=function(){this._request&&(this._request.abort(),this.makeEvent("geocode-response"))};SMap.Geocoder.prototype.getResults=function(){return this._results};
SMap.Geocoder.prototype._sendRequest=function(){this.makeEvent("geocode-request");this._request=new JAK.Request(JAK.Request.XML);this._request.setCallback(this,"_response");var a=this._buildData();this._request.send(JAK.Request.supportsCrossOrigin()?SMap.CONFIG.base+"/"+this.constructor.METHOD:this._options.url,a)};SMap.Geocoder.prototype._response=function(a){this.makeEvent("geocode-response");this._request=null;a&&(this._parseResponse(a),this._callback(this))};
SMap.Geocoder.prototype._buildData=function(){var a={query:this._query instanceof Array?this._query:[this._query]};this._options.count&&(a.count=this._options.count);return a};
SMap.Geocoder.prototype._parseResponse=function(a){this._results=[];for(var a=a.getElementsByTagName("point"),b=0;b<a.length;b++){var c=a[b],d={};this._results.push(d);d.query=c.getAttribute("query");d.results=[];for(var c=c.getElementsByTagName("item"),e=0;e<c.length;e++){var f=c[e],g=SMap.Coords.fromWGS84(f.getAttribute("x"),f.getAttribute("y"));d.results.push({coords:g,label:f.getAttribute("title"),source:f.getAttribute("source"),id:f.getAttribute("id")})}}};
SMap.Geocoder.Reverse=JAK.ClassMaker.makeClass({NAME:"SMap.Geocoder.Reverse",VERSION:"2.0",EXTEND:SMap.Geocoder});SMap.Geocoder.Reverse.METHOD="rgeocode";SMap.Geocoder.Reverse.prototype.$constructor=function(a,b,c){var d={url:"/rgeocode"},e;for(e in c)d[e]=c[e];this.$super(a,b,d);this._results={items:[]}};SMap.Geocoder.Reverse.prototype._buildData=function(){var a=this._query.toWGS84();return{lon:a[0].toFixed(6),lat:a[1].toFixed(6)}};
SMap.Geocoder.Reverse.prototype._parseResponse=function(a){this._results={items:[],label:a.documentElement.getAttribute("label"),coords:this._query};for(var a=a.getElementsByTagName("item"),b=0;b<a.length;b++){var c=a[b],d={};d.coords=SMap.Coords.fromWGS84(c.getAttribute("x"),c.getAttribute("y"));d.name=c.getAttribute("name");d.type=c.getAttribute("type");d.id=c.getAttribute("id");this._results.items.push(d)}};SMap.Logger=JAK.ClassMaker.makeStatic({VERSION:"1.1",NAME:"SMap.Logger"});
SMap.Logger.enabled=!1;SMap.Logger.server="";SMap.Logger.re=/.*/;SMap.Logger.map=null;SMap.Logger.hash=null;SMap.Logger.service="api";SMap.Logger.dot=!1;SMap.Logger.log=function(a,b){if(this.map&&location.hostname.match(this.re)){if(!this.hash){for(var c="",d=0;10>d;d++)var e=Math.floor(26*Math.random()),c=c+String.fromCharCode(97+e);this.hash="h_"+c}this.enabled&&this._request(this._buildUrl(a,b));this.dot&&window.DOT&&(c=this._buildData(a,b),DOT.hit("event",{d:c}))}};
SMap.Logger._buildUrl=function(a,b){var c=this._buildData(a,b),d=[],e;for(e in c)d.push(encodeURIComponent(e)+"="+encodeURIComponent(c[e]));return this.server+"?"+d.join("&")};
SMap.Logger._buildData=function(a,b){for(var c=this.map,d=c.getCenter().toWGS84(),e=[SMap.DEF_BASE,SMap.DEF_TURIST,SMap.DEF_OPHOTO,SMap.DEF_HISTORIC,SMap.DEF_OPHOTO0203,SMap.DEF_OPHOTO0406,SMap.DEF_OBLIQUE,SMap.DEF_SMART_BASE,SMap.DEF_SMART_OPHOTO,SMap.DEF_SMART_TURIST],d={action:a,zoom:c.getZoom(),hash:this.service+"_"+this.hash,x:d[0].toFixed(6),y:d[1].toFixed(6),r:Math.random()},f=0;f<e.length;f++){var g=e[f],h=c.getLayer(g);h&&h.isActive()&&(d.map=g)}if(b)for(var j in b)d[j]=b[j];return d};
SMap.Logger._request=function(a){JAK.mel("img",{src:a})};SMap.Route=JAK.ClassMaker.makeClass({NAME:"SMap.Route",VERSION:"1.0",IMPLEMENT:JAK.ISignals});SMap.Route.URL="/route";
SMap.Route.prototype.$constructor=function(a,b,c){this._coords=a;this._callback=b;this._request=null;this._results={};if(2>a.length)throw Error("At least two coordinates required");this._params={criterion:"fast",autoSend:!0};for(var d in c)this._params[d]=c[d];this._request=new JAK.Request(JAK.Request.XML);this._request.setCallback(this,"_response");a={geometry:SMap.Coords.coordsToString(a)};for(d in this._params)"autoSend"!=d&&(a[d]=this._params[d]);this._results.url=this._buildUrl(a);this._params.autoSend&&
this.send()};SMap.Route.prototype.$destructor=function(){this.abort()};SMap.Route.prototype.send=function(){this.makeEvent("route-request");this._request.send(this._results.url)};SMap.Route.prototype.abort=function(){this._request&&(this._request.abort(),this.makeEvent("route-response"))};SMap.Route.prototype.getCoords=function(){return this._coords};SMap.Route.prototype.getCriterion=function(){return this._params.criterion};SMap.Route.prototype.getResults=function(){return this._results};
SMap.Route.prototype._buildUrl=function(a){var b=JAK.Request.supportsCrossOrigin()?SMap.CONFIG.base+"/route":this.constructor.URL,c=[],d;for(d in a)c.push(encodeURIComponent(d)+"="+encodeURIComponent(a[d]));return b+=(-1==b.indexOf("?")?"?":"&")+c.join("&")};SMap.Route.prototype._response=function(a){this.makeEvent("route-response");this._request=null;a&&(this._results=this._parseResponse(a),this._callback(this))};SMap.Route.prototype._coordsToString=function(a){return a.toWGS84().join(",")};
SMap.Route.prototype._parseResponse=function(a){var b=a.documentElement;if("error"==b.nodeName.toLowerCase())return a=JAK.XML.textContent(b.getElementsByTagName("status")[0]),{error:!0,status:parseInt(a)};var a={id:b.getAttribute("id"),url:this._results.url,geometry:[],altitude:[],points:[],ascent:parseFloat(b.getAttribute("ascent")),descent:parseFloat(b.getAttribute("descent")),inEurope:"1"==b.getAttribute("inEurope"),length:parseInt(b.getAttribute("length")),time:parseInt(b.getAttribute("time")),
routeType:b.getAttribute("routeType")},c=JAK.XML.childElements(b,"geometry");c.length&&(a.geometry=SMap.Coords.stringToCoords(JAK.XML.textContent(c[0])));c=JAK.XML.childElements(b,"altitude");c.length&&(a.altitude=SMap.Coords.stringToAltitude(JAK.XML.textContent(c[0])));b=b.getElementsByTagName("point");a.points=this._parsePoints(b,a.routeType);return a};
SMap.Route.prototype._parsePoints=function(a,b){for(var c=[],d=0;d<a.length;d++){var e=a[d],e={coords:SMap.Coords.fromWGS84(e.getAttribute("lon"),e.getAttribute("lat")),altitude:parseFloat(e.getAttribute("altitude")),angle:parseFloat(e.getAttribute("angle")),name:"car"==b?e.getAttribute("name"):e.getAttribute("nameCycle"),city:e.getAttribute("city"),typeId:e.getAttribute("typeId"),distance:parseInt(e.getAttribute("distance")),time:parseInt(e.getAttribute("time")),destinationIndex:parseInt(e.getAttribute("destinationIndex")),
ringRoadExit:parseInt(e.getAttribute("ringRoadExit")),roadCategory:e.getAttribute("roadCategory"),roadIconId:parseInt(e.getAttribute("roadIconId")),roadName:e.getAttribute("roadName"),roadNumber:e.getAttribute("roadNumber"),roadNumberCycle:e.getAttribute("roadNumberCycle"),winterGear:e.getAttribute("winterGear"),roadNumberTurist:e.getAttribute("roadNumberTurist"),nameTurist:e.getAttribute("nameTurist"),signPostName:e.getAttribute("signPostName"),turGroup:e.getAttribute("turGroup")};isNaN(e.destinationIndex)&&
(e.destinationIndex=null);c.push(e)}return c};
(function(){var a={_queue:[],_map:{},_origPress:null,init:function(){this._map["38,38,40,40,37,39,37,39,66,65"]=a.whereami;this._map["73,68,75,70,65"]=a.crosshair;this._map["73,68,68,81,68"]=a.plane;this._origDown=SMap.Control.Keyboard.prototype._down;SMap.Control.Keyboard.prototype._down=this._down},_down:function(b,c){a._queue.push(b.keyCode);var d=a._queue.join(","),e=0,f;for(f in a._map)e=Math.max(e,f.length),-1<d.indexOf(f)&&(a._queue=[],a._map[f].call(this));d.length>e&&a._queue.shift();return a._origDown.apply(this,
arguments)},_crosshairLayers:null,_crosshairEvents:[],crosshair:function(){if(a._crosshairLayers){for(;a._crosshairLayers.length;){var b=a._crosshairLayers.shift();this.getMap().removeLayer(b);b.$destructor()}a._crosshairLayers=null;JAK.Events.removeListeners(a._crosshairEvents)}else{hud=new SMap.Layer.HUD;this.getMap().addLayer(hud).enable();hud.enable();var b=JAK.mel("div"),c=JAK.mel("img",null,{left:"-16px",top:"-16px",position:"absolute"});c.src=SMap.CONFIG.img+"/crosshair.gif";b.appendChild(c);
hud.addItem(b,{left:"50%",top:"50%"});var d=new SMap.Layer.Marker;this.getMap().addLayer(d).enable();a._crosshairLayers=[hud,d];var e={url:SMap.CONFIG.img+"/hole.gif",anchor:{left:17,top:17}},b=JAK.Events.addListener(document,"keydown",this,function(a){if(17==a.keyCode){var a=this.getMap(),b=new SMap.Pixel(0,0);b.x+=Math.round(6*Math.random()-3);b.y+=Math.round(6*Math.random()-3);coords=b.toCoords(a);a=new SMap.Marker(coords,null,e);d.addMarker(a)}});a._crosshairEvents.push(b)}},_planeLayer:null,
_planeEvents:[],_planeMode:0,_planeTimeout:null,plane:function(){if(a._planeLayer)clearTimeout(a._planeTimeout),this.getMap().unlock(),this.getMap().removeLayer(a._planeLayer),a._planeLayer.$destructor(),a._planeLayer=null,JAK.Events.removeListeners(a._planeEvents),this.configure(a._planeMode);else{a._planeMode=this.getMode();this.configure(0);var b=0,c=new SMap.Pixel(0,0),d=0,e=5,f=function(){var a=b*Math.PI/180;c.x=-Math.round(e*Math.cos(a));c.y=-Math.round(e*Math.sin(a));for(var a=["transform",
"MozTransform","WebkitTransform","OTransform","msTransform"],d="translate(-50%, -50%) rotate("+b+"deg)",f=0;f<a.length;f++)g.style[a[f]]=d};a._planeLayer=new SMap.Layer.HUD;this.getMap().addLayer(a._planeLayer).enable();var g=JAK.mel("img",null,{left:"-16px",top:"-16px",position:"absolute"});g.src=SMap.CONFIG.img+"/plane.png";a._planeLayer.addItem(g,{left:"50%",top:"50%"});f();var h=JAK.Events.addListener(document,"keydown",this,function(a){switch(a.keyCode){case 37:b-=10;break;case 39:b+=10;break;
case 107:e++;break;case 109:e=Math.max(1,e-1)}b=(b+360)%360;f()});a._planeEvents.push(h);var j=this.getMap();j.lock();a._planeTimeout=setInterval(function(){j.setCenter(c);d+=e;300<d&&(d=0,j.unlock(),j.lock())},25)}},_whereamiLayers:{},whereami:function(){if(navigator.geolocation)if(a._whereamiLayers.marker){for(var b in a._whereamiLayers)this.getMap().removeLayer(a._whereamiLayers[b].disable());a._whereamiLayers={}}else navigator.geolocation.getCurrentPosition(function(b){var d=b.coords,b=SMap.Coords.fromWGS84(d.longitude,
d.latitude),e=15,f=new SMap.Layer.Marker,g=new SMap.Marker(b);this.getMap().addLayer(f).enable();f.addMarker(g);a._whereamiLayers.marker=f;d.accuracy&&(e=12742018*Math.PI*Math.cos(d.latitude*Math.PI/180),d=SMap.Coords.fromWGS84(d.longitude+360*(d.accuracy/e),d.latitude),e=new SMap.Layer.Geometry,this.getMap().addLayer(e).enable(),f=new SMap.Geometry(SMap.GEOMETRY_CIRCLE,null,[b,d],{opacity:0.2,color:"red",outlineColor:"red",outlineWidth:2}),e.addGeometry(f),a._whereamiLayers.geometry=e,e=this.getMap().computeCenterZoom([b,
d])[1]-2);this.getMap().setCenterZoom(b,e)}.bind(this))}};a.init()})();
